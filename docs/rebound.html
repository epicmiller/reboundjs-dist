<!DOCTYPE html>

<html>
<head>
  <title>rebound.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>rebound.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <pre><code>Rebound.js <span class="hljs-number">0.0</span>.60
</code></pre>
            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <pre><code>(c) <span class="hljs-number">2015</span> Adam Miller
Rebound may be freely distributed under the MIT license.
For all details and documentation:
http:<span class="hljs-comment">//reboundjs.com</span>
</code></pre>
            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <h2 id="rebound-runtime">Rebound Runtime</h2>

            </div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>If Backbone isn’t preset on the page yet, or if <code>window.Rebound</code> is already
in use, throw an error</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">if</span>(!<span class="hljs-built_in">window</span>.Backbone) <span class="hljs-keyword">throw</span> <span class="hljs-string">"Backbone must be on the page for Rebound to load."</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Load our <strong>Utils</strong>, helper environment, <strong>Rebound Data</strong>,
<strong>Rebound Components</strong> and the <strong>Rebound Router</strong></p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">import</span> utils <span class="hljs-keyword">from</span> <span class="hljs-string">"rebound-component/utils"</span>;
<span class="hljs-keyword">import</span> helpers <span class="hljs-keyword">from</span> <span class="hljs-string">"rebound-component/helpers"</span>;
<span class="hljs-keyword">import</span> { Model, Collection, ComputedProperty } <span class="hljs-keyword">from</span> <span class="hljs-string">"rebound-data/rebound-data"</span>;
<span class="hljs-keyword">import</span> Component <span class="hljs-keyword">from</span> <span class="hljs-string">"rebound-component/component"</span>;
<span class="hljs-keyword">import</span> Router <span class="hljs-keyword">from</span> <span class="hljs-string">"rebound-router/rebound-router"</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>If Backbone doesn’t have an ajax method from an external DOM library, use ours</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-built_in">window</span>.Backbone.ajax = <span class="hljs-built_in">window</span>.Backbone.$ &amp;&amp; <span class="hljs-built_in">window</span>.Backbone.$.ajax &amp;&amp; <span class="hljs-built_in">window</span>.Backbone.ajax || utils.ajax;</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Create Global Rebound Object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> Rebound = {
  services: {},
  registerHelper: helpers.registerHelper,
  registerPartial: helpers.registerPartial,
  registerComponent: Component.registerComponent,
  Model: Model,
  Collection: Collection,
  ComputedProperty: ComputedProperty,
  Component: Component,
  start: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options)</span></span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(resolve, reject)</span> </span>{
      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">if</span>(<span class="hljs-built_in">document</span>.readyState !== <span class="hljs-string">"complete"</span>) <span class="hljs-keyword">return</span>;
        Rebound.router = <span class="hljs-keyword">new</span> Router(options, resolve);
      }
      <span class="hljs-keyword">if</span>(<span class="hljs-built_in">document</span>.readyState === <span class="hljs-string">"complete"</span>) <span class="hljs-keyword">return</span> run();
      <span class="hljs-built_in">document</span>.addEventListener(<span class="hljs-string">"readystatechange"</span>, run);
    });
  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Fetch Rebound’s Config Object from Rebound’s <code>script</code> tag</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> Config = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'Rebound'</span>);
    Config = (Config) ? Config.innerHTML : <span class="hljs-literal">false</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Start the router if a config object is preset</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">if</span>(Config) Rebound.start(<span class="hljs-built_in">JSON</span>.parse(Config));

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> Rebound;</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <h2 id="rebound-data">Rebound Data</h2>

            </div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>These are methods inherited by all Rebound data types: <strong>Models</strong>,
<strong>Collections</strong> and <strong>Computed Properties</strong>. Controls tree ancestry
tracking, deep event propagation and tree destruction.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">import</span> Model <span class="hljs-keyword">from</span> <span class="hljs-string">"rebound-data/model"</span>;
<span class="hljs-keyword">import</span> Collection <span class="hljs-keyword">from</span> <span class="hljs-string">"rebound-data/collection"</span>;
<span class="hljs-keyword">import</span> ComputedProperty <span class="hljs-keyword">from</span> <span class="hljs-string">"rebound-data/computed-property"</span>;
<span class="hljs-keyword">import</span> $ from <span class="hljs-string">"rebound-component/utils"</span>;

<span class="hljs-keyword">var</span> sharedMethods = {</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>When a change event propagates up the tree it modifies the path part of
<code>change:&lt;path&gt;</code> to reflect the fully qualified path relative to that object.
Ex: Would trigger <code>change:val</code>, <code>change:[0].val</code>, <code>change:arr[0].val</code> and <code>obj.arr[0].val</code>
on each parent as it is propagated up the tree.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  propagateEvent: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(type, model)</span></span>{
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.__parent__ === <span class="hljs-keyword">this</span> || type === <span class="hljs-string">'dirty'</span>) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">if</span>(type.indexOf(<span class="hljs-string">'change:'</span>) === <span class="hljs-number">0</span> &amp;&amp; model.isModel){
      <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.isCollection &amp;&amp; ~type.indexOf(<span class="hljs-string">'change:['</span>)) <span class="hljs-keyword">return</span>;
      <span class="hljs-keyword">var</span> key,
          path = model.__path().replace(<span class="hljs-keyword">this</span>.__parent__.__path(), <span class="hljs-string">''</span>).replace(<span class="hljs-regexp">/^\./</span>, <span class="hljs-string">''</span>),
          changed = model.changedAttributes();

      <span class="hljs-keyword">for</span>(key <span class="hljs-keyword">in</span> changed){</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>TODO: Modifying arguments array is bad. change this</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-built_in">arguments</span>[<span class="hljs-number">0</span>] = (<span class="hljs-string">'change:'</span> + path + (path &amp;&amp; <span class="hljs-string">'.'</span>) + key); <span class="hljs-comment">// jshint ignore:line</span>
        <span class="hljs-keyword">this</span>.__parent__.trigger.apply(<span class="hljs-keyword">this</span>.__parent__, <span class="hljs-built_in">arguments</span>);
      }
      <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.__parent__.trigger.apply(<span class="hljs-keyword">this</span>.__parent__, <span class="hljs-built_in">arguments</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Set this data object’s parent to <code>parent</code> and, as long as a data object is
not its own parent, propagate every event triggered on <code>this</code> up the tree.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  setParent: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(parent)</span></span>{
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.__parent__) <span class="hljs-keyword">this</span>.off(<span class="hljs-string">'all'</span>, <span class="hljs-keyword">this</span>.propagateEvent);
    <span class="hljs-keyword">this</span>.__parent__ = parent;
    <span class="hljs-keyword">this</span>._hasAncestry = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">if</span>(parent !== <span class="hljs-keyword">this</span>) <span class="hljs-keyword">this</span>.on(<span class="hljs-string">'all'</span>, <span class="hljs-keyword">this</span>.__parent__.propagateEvent);
    <span class="hljs-keyword">return</span> parent;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Recursively set a data tree’s root element starting with <code>this</code> to the deepest child.
TODO: I dont like this recursively setting elements root when one element’s root changes. Fix this.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  setRoot: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(root)</span></span>{
    <span class="hljs-keyword">var</span> obj = <span class="hljs-keyword">this</span>;
    obj.__root__ = root;
    <span class="hljs-keyword">var</span> val = obj.models ||  obj.attributes || obj.cache;
    _.each(val, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value, key)</span></span>{
      <span class="hljs-keyword">if</span>(value &amp;&amp; value.isData){
        value.setRoot(root);
      }
    });
    <span class="hljs-keyword">return</span> root;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Tests to see if <code>this</code> has a parent <code>obj</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  hasParent: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj)</span></span>{
    <span class="hljs-keyword">var</span> tmp = <span class="hljs-keyword">this</span>;
    <span class="hljs-keyword">while</span>(tmp !== obj){
      tmp = tmp.__parent__;
      <span class="hljs-keyword">if</span>(_.isUndefined(tmp)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
      <span class="hljs-keyword">if</span>(tmp === obj) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
      <span class="hljs-keyword">if</span>(tmp.__parent__ === tmp) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>De-initializes a data tree starting with <code>this</code> and recursively calling <code>deinitialize()</code> on each child.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  deinitialize: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Undelegate Backbone Events from this data object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.undelegateEvents) <span class="hljs-keyword">this</span>.undelegateEvents();
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.stopListening) <span class="hljs-keyword">this</span>.stopListening();
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.off) <span class="hljs-keyword">this</span>.off();
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.unwire) <span class="hljs-keyword">this</span>.unwire();</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Destroy this data object’s lineage</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.__parent__;
    <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.__root__;
    <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.__path;</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>If there is a dom element associated with this data object, destroy all listeners associated with it.
Remove all event listeners from this dom element, recursively remove element lazyvalues,
and then remove the element referance itself.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.el){
      _.each(<span class="hljs-keyword">this</span>.el.__listeners, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(handler, eventType)</span></span>{
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.el.removeEventListener) <span class="hljs-keyword">this</span>.el.removeEventListener(eventType, handler, <span class="hljs-literal">false</span>);
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.el.detachEvent) <span class="hljs-keyword">this</span>.el.detachEvent(<span class="hljs-string">'on'</span>+eventType, handler);
      }, <span class="hljs-keyword">this</span>);
      $(<span class="hljs-keyword">this</span>.el).walkTheDOM(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(el)</span></span>{
        <span class="hljs-keyword">if</span>(el.__lazyValue &amp;&amp; el.__lazyValue.destroy()) n.__lazyValue.destroy();
      });
      <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.el.__listeners;
      <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.el.__events;
      <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.$el;
      <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.el;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Clean up Hook callback references</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.__observers;</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Mark as deinitialized so we don’t loop on cyclic dependancies.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.deinitialized = <span class="hljs-literal">true</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Destroy all children of this data object.
If a Collection, de-init all of its Models, if a Model, de-init all of its
Attributes, if a Computed Property, de-init its Cache objects.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    _.each(<span class="hljs-keyword">this</span>.models, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(val)</span></span>{ val &amp;&amp; val.deinitialize &amp;&amp; val.deinitialize(); });
    <span class="hljs-keyword">this</span>.models &amp;&amp; (<span class="hljs-keyword">this</span>.models.length = <span class="hljs-number">0</span>);
    _.each(<span class="hljs-keyword">this</span>.attributes, (val, key) =&gt; { <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.attributes[key]; val &amp;&amp; val.deinitialize &amp;&amp; val.deinitialize(); });
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.cache){
      <span class="hljs-keyword">this</span>.cache.collection.deinitialize();
      <span class="hljs-keyword">this</span>.cache.model.deinitialize();
    }
  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Extend all of the <strong>Rebound Data</strong> prototypes with these shared methods</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>_.extend(Model.prototype, sharedMethods);
_.extend(Collection.prototype, sharedMethods);
_.extend(ComputedProperty.prototype, sharedMethods);

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> { Model, Collection, ComputedProperty };</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <h2 id="rebound-model">Rebound Model</h2>

            </div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>Rebound <strong>Models</strong> are the basic data object in the framework - frequently
representing a row in a table in a database on your server. The inherit from
Backbone Models and have all of the same useful methods you are used to for
performing computations and transformations on that data. Rebound augments
Backbone Models by enabling deep data nesting. You can now have <strong>Rebound Collections</strong>
and <strong>Rebound Computed Properties</strong> as properties of the Model.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">import</span> ComputedProperty <span class="hljs-keyword">from</span> <span class="hljs-string">"rebound-data/computed-property"</span>;
<span class="hljs-keyword">import</span> $ from <span class="hljs-string">"rebound-component/utils"</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>Returns a function that, when called, generates a path constructed from its
parent’s path and the key it is assigned to. Keeps us from re-naming children
when parents change.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">pathGenerator</span><span class="hljs-params">(parent, key)</span></span>{
  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
    <span class="hljs-keyword">var</span> path = parent.__path();
    <span class="hljs-keyword">return</span> path + ((path === <span class="hljs-string">''</span>) ? <span class="hljs-string">''</span> : <span class="hljs-string">'.'</span>) + key;
  };
}

<span class="hljs-keyword">var</span> Model = Backbone.Model.extend({</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>Set this object’s data types</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  isModel: <span class="hljs-literal">true</span>,
  isData: <span class="hljs-literal">true</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>A method that returns a root path by default. Meant to be overridden on
instantiation.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  __path: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{ <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>; },</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>Create a new Model with the specified attributes. The Model’s lineage is set
up here to keep track of it’s place in the data tree.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  constructor: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(attributes, options)</span></span>{
    attributes || (attributes = {});
    attributes.isModel &amp;&amp; (attributes = attributes.attributes);
    options || (options = {});
    <span class="hljs-keyword">this</span>.helpers = {};
    <span class="hljs-keyword">this</span>.defaults = <span class="hljs-keyword">this</span>.defaults || {};
    <span class="hljs-keyword">this</span>.setParent( options.parent || <span class="hljs-keyword">this</span> );
    <span class="hljs-keyword">this</span>.setRoot( options.root || <span class="hljs-keyword">this</span> );
    <span class="hljs-keyword">this</span>.__path = options.path || <span class="hljs-keyword">this</span>.__path;</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>Convert getters and setters to computed properties</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    $.extractComputedProps(attributes);

    Backbone.Model.call( <span class="hljs-keyword">this</span>, attributes, options );
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>New convenience function to toggle boolean values in the Model.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  toggle: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(attr, options)</span> </span>{
    options = options ? _.clone(options) : {};
    <span class="hljs-keyword">var</span> val = <span class="hljs-keyword">this</span>.get(attr);
    <span class="hljs-keyword">if</span>(!_.isBoolean(val)) <span class="hljs-built_in">console</span>.error(<span class="hljs-string">'Tried to toggle non-boolean value '</span> + attr +<span class="hljs-string">'!'</span>, <span class="hljs-keyword">this</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.set(attr, !val, options);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>Model Reset does a deep reset on the data tree starting at this Model.
A <code>previousAttributes</code> property is set on the <code>options</code> property with the Model’s
old values.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  reset: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj, options)</span></span>{
    <span class="hljs-keyword">var</span> changed = {}, key, value;
    options || (options = {});
    options.reset = <span class="hljs-literal">true</span>;
    obj = (obj &amp;&amp; obj.isModel &amp;&amp; obj.attributes) || obj || {};
    options.previousAttributes = _.clone(<span class="hljs-keyword">this</span>.attributes);</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>Iterate over the Model’s attributes:</p>
<ul>
<li>If the property is the <code>idAttribute</code>, skip.</li>
<li>If the property is a <code>Model</code>, <code>Collection</code>, or <code>ComputedProperty</code>, reset it.</li>
<li>If the passed object has the property, set it to the new value.</li>
<li>If the Model has a default value for this property, set it back to default.</li>
<li>Otherwise, unset the attribute.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">for</span>(key <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span>.attributes){
      value = <span class="hljs-keyword">this</span>.attributes[key];
      <span class="hljs-keyword">if</span>(value === obj[key]) <span class="hljs-keyword">continue</span>;
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(_.isUndefined(value)) obj[key] &amp;&amp; (changed[key] = obj[key]);
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (key === <span class="hljs-keyword">this</span>.idAttribute) <span class="hljs-keyword">continue</span>;
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (value.isCollection || value.isModel || value.isComputedProperty){
        value.reset((obj[key] || []), {silent: <span class="hljs-literal">true</span>});
        <span class="hljs-keyword">if</span>(value.isCollection) changed[key] = [];
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(value.isModel &amp;&amp; value.isComputedProperty) changed[key] = value.cache.model.changed;
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(value.isModel) changed[key] = value.changed;
      }
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (obj.hasOwnProperty(key)){ changed[key] = obj[key]; }
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.defaults.hasOwnProperty(key) &amp;&amp; !_.isFunction(<span class="hljs-keyword">this</span>.defaults[key])){
        changed[key] = obj[key] = <span class="hljs-keyword">this</span>.defaults[key];
      }
      <span class="hljs-keyword">else</span>{
        changed[key] = <span class="hljs-literal">undefined</span>;
        <span class="hljs-keyword">this</span>.unset(key, {silent: <span class="hljs-literal">true</span>});
      }
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>Any unset changed values will be set to obj[key]</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    _.each(obj, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value, key, obj)</span></span>{
      changed[key] = changed[key] || obj[key];
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>Reset our model</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    obj = <span class="hljs-keyword">this</span>.set(obj, _.extend({}, options, {silent: <span class="hljs-literal">true</span>, reset: <span class="hljs-literal">false</span>}));</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>Trigger custom reset event</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.changed = changed;
    <span class="hljs-keyword">if</span> (!options.silent) <span class="hljs-keyword">this</span>.trigger(<span class="hljs-string">'reset'</span>, <span class="hljs-keyword">this</span>, options);</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>Return new values</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">return</span> obj;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p><strong>Model.Get</strong> is overridden to provide support for getting from a deep data tree.
<code>key</code> may now be any valid json-like identifier. Ex: <code>obj.coll[3].value</code>.
It needs to traverse <code>Models</code>, <code>Collections</code> and <code>Computed Properties</code> to
find the correct value.</p>
<ul>
<li>If key is undefined, return <code>undefined</code>.</li>
<li>If key is empty string, return <code>this</code>.</li>
</ul>
<p>For each part:</p>
<ul>
<li>If a <code>Computed Property</code> and <code>options.raw</code> is true, return it.</li>
<li>If a <code>Computed Property</code> traverse to its value.</li>
<li>If not set, return its falsy value.</li>
<li>If a <code>Model</code>, <code>Collection</code>, or primitive value, traverse to it.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  get: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key, options)</span></span>{
    options || (options = {});
    <span class="hljs-keyword">var</span> parts  = $.splitPath(key),
        result = <span class="hljs-keyword">this</span>,
        i, l=parts.length;

    <span class="hljs-keyword">if</span>(_.isUndefined(key) || _.isNull(key)) <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;
    <span class="hljs-keyword">if</span>(key === <span class="hljs-string">''</span> || parts.length === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> result;

    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; l; i++) {
      <span class="hljs-keyword">if</span>(result &amp;&amp; result.isComputedProperty &amp;&amp; options.raw) <span class="hljs-keyword">return</span> result;
      <span class="hljs-keyword">if</span>(result &amp;&amp; result.isComputedProperty) result = result.value();
      <span class="hljs-keyword">if</span>(_.isUndefined(result) || _.isNull(result)) <span class="hljs-keyword">return</span> result;
      <span class="hljs-keyword">if</span>(parts[i] === <span class="hljs-string">'@parent'</span>) result = result.__parent__;
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(result.isCollection) result = result.models[parts[i]];
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(result.isModel) result = result.attributes[parts[i]];
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(result &amp;&amp; result.hasOwnProperty(parts[i])) result = result[parts[i]];
    }

    <span class="hljs-keyword">if</span>(result &amp;&amp; result.isComputedProperty &amp;&amp; !options.raw) result = result.value();
    <span class="hljs-keyword">return</span> result;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p><strong>Model.Set</strong> is overridden to provide support for getting from a deep data tree.
<code>key</code> may now be any valid json-like identifier. Ex: <code>obj.coll[3].value</code>.
It needs to traverse <code>Models</code>, <code>Collections</code> and <code>Computed Properties</code> to
find the correct value to call the original <code>Backbone.Set</code> on.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  set: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key, val, options)</span></span>{

    <span class="hljs-keyword">var</span> attrs, attr, newKey, target, destination, props = [], lineage;

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> key === <span class="hljs-string">'object'</span>) {
      attrs = (key.isModel) ? key.attributes : key;
      options = val;
    }
    <span class="hljs-keyword">else</span> (attrs = {})[key] = val;
    options || (options = {});</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>Convert getters and setters to computed properties</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    $.extractComputedProps(attrs);</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>If reset option passed, do a reset. If nothing passed, return.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(options.reset === <span class="hljs-literal">true</span>) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.reset(attrs, options);
    <span class="hljs-keyword">if</span>(options.defaults === <span class="hljs-literal">true</span>) <span class="hljs-keyword">this</span>.defaults = attrs;
    <span class="hljs-keyword">if</span>(_.isEmpty(attrs)) <span class="hljs-keyword">return</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>For each attribute passed:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">for</span>(key <span class="hljs-keyword">in</span> attrs){
      <span class="hljs-keyword">let</span> val = attrs[key],
          paths = $.splitPath(key),
          attr  = paths.pop() || <span class="hljs-string">''</span>;           <span class="hljs-comment">// The key        ex: foo[0].bar --&gt; bar</span>
          target = <span class="hljs-keyword">this</span>.get(paths.join(<span class="hljs-string">'.'</span>)),  <span class="hljs-comment">// The element    ex: foo.bar.baz --&gt; foo.bar</span>
          lineage;</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>If target currently doesnt exist, construct its tree</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span>(_.isUndefined(target)){
        target = <span class="hljs-keyword">this</span>;
        _.each(paths, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value)</span></span>{
          <span class="hljs-keyword">var</span> tmp = target.get(value);
          <span class="hljs-keyword">if</span>(_.isUndefined(tmp)) tmp = target.set(value, {}).get(value);
          target = tmp;
        }, <span class="hljs-keyword">this</span>);
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>The old value of <code>attr</code> in <code>target</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      destination = target.get(attr, {raw: <span class="hljs-literal">true</span>}) || {};</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>Create this new object’s lineage.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      lineage = {
        name: key,
        parent: target,
        root: <span class="hljs-keyword">this</span>.__root__,
        path: pathGenerator(target, key),
        silent: <span class="hljs-literal">true</span>,
        defaults: options.defaults
      };</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <ul>
<li>If val is <code>null</code> or <code>undefined</code>, set to default value.</li>
<li>If val is a <code>Computed Property</code>, get its current cache object.</li>
<li>If val (default value or evaluated computed property) is <code>null</code>, set to default value or (fallback <code>undefined</code>).</li>
<li>Else If <code>{raw: true}</code> option is passed, set the exact object that was passed. No promotion to a Rebound Data object.</li>
<li>Else If this function is the same as the current computed property, continue.</li>
<li>Else If this value is a <code>Function</code>, turn it into a <code>Computed Property</code>.</li>
<li>Else If this is going to be a cyclical dependancy, use the original object, don’t make a copy.</li>
<li>Else If updating an existing object with its respective data type, let Backbone handle the merge.</li>
<li>Else If this value is a <code>Model</code> or <code>Collection</code>, create a new copy of it using its constructor, preserving its defaults while ensuring no shared memory between objects.</li>
<li>Else If this value is an <code>Array</code>, turn it into a <code>Collection</code>.</li>
<li>Else If this value is a <code>Object</code>, turn it into a <code>Model</code>.</li>
<li>Else val is a primitive value, set it accordingly.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>

      <span class="hljs-keyword">if</span>(_.isNull(val) || _.isUndefined(val)) val = <span class="hljs-keyword">this</span>.defaults[key];
      <span class="hljs-keyword">if</span>(val &amp;&amp; val.isComputedProperty) val = val.value();
      <span class="hljs-keyword">if</span>(_.isNull(val) || _.isUndefined(val)) val = <span class="hljs-literal">undefined</span>;
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(options.raw === <span class="hljs-literal">true</span>) val = val;
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(destination.isComputedProperty &amp;&amp; destination.func === val) <span class="hljs-keyword">continue</span>;
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(val.isComputedProto) val = <span class="hljs-keyword">new</span> ComputedProperty(val.get, val.set, lineage);
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(val.isData &amp;&amp; target.hasParent(val)) val = val;
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>( destination.isComputedProperty ||
              ( destination.isCollection &amp;&amp; ( _.isArray(val) || val.isCollection )) ||
              ( destination.isModel &amp;&amp; ( _.isObject(val) || val.isModel ))){
        destination.set(val, options);
        <span class="hljs-keyword">continue</span>;
      }
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(val.isData &amp;&amp; options.clone !== <span class="hljs-literal">false</span>) val = <span class="hljs-keyword">new</span> val.constructor(val.attributes || val.models, lineage);
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(_.isArray(val)) val = <span class="hljs-keyword">new</span> Rebound.Collection(val, lineage); <span class="hljs-comment">// TODO: Remove global referance</span>
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(_.isObject(val)) val = <span class="hljs-keyword">new</span> Model(val, lineage);</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>If val is a data object, let this object know it is now a parent</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">this</span>._hasAncestry = (val &amp;&amp; val.isData || <span class="hljs-literal">false</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>Set the value</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      Backbone.Model.prototype.set.call(target, attr, val, options); <span class="hljs-comment">// TODO: Event cleanup when replacing a model or collection with another value</span>

    }

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;

  },</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>Recursive <code>toJSON</code> function traverses the data tree returning a JSON object.
If there are any cyclic dependancies the object’s <code>cid</code> is used instead of looping infinitely.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  toJSON: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._isSerializing) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.id || <span class="hljs-keyword">this</span>.cid;
    <span class="hljs-keyword">this</span>._isSerializing = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">var</span> json = _.clone(<span class="hljs-keyword">this</span>.attributes);
    _.each(json, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value, name)</span> </span>{
        <span class="hljs-keyword">if</span>( _.isNull(value) || _.isUndefined(value) ){ <span class="hljs-keyword">return</span>; }
        _.isFunction(value.toJSON) &amp;&amp; (json[name] = value.toJSON());
    });
    <span class="hljs-keyword">this</span>._isSerializing = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">return</span> json;
  }

});</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>If default properties are passed into extend, process the computed properties</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Model.extend = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(protoProps, staticProps)</span> </span>{
  $.extractComputedProps(protoProps.defaults);
  <span class="hljs-keyword">return</span> Backbone.Model.extend.call(<span class="hljs-keyword">this</span>, protoProps, staticProps);
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> Model;</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <h2 id="rebound-collection">Rebound Collection</h2>

            </div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">import</span> Model <span class="hljs-keyword">from</span> <span class="hljs-string">"rebound-data/model"</span>;
<span class="hljs-keyword">import</span> $ from <span class="hljs-string">"rebound-component/utils"</span>;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">pathGenerator</span><span class="hljs-params">(collection)</span></span>{
  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
    <span class="hljs-keyword">return</span> collection.__path() + <span class="hljs-string">'['</span> + collection.indexOf(collection._byId[<span class="hljs-keyword">this</span>.cid]) + <span class="hljs-string">']'</span>;
  };
}

<span class="hljs-keyword">var</span> Collection = Backbone.Collection.extend({

  isCollection: <span class="hljs-literal">true</span>,
  isData: <span class="hljs-literal">true</span>,

  model: Model,

  __path: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{<span class="hljs-keyword">return</span> <span class="hljs-string">''</span>;},

  constructor: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(models, options)</span></span>{
    models || (models = []);
    options || (options = {});
    <span class="hljs-keyword">this</span>.__observers = {};
    <span class="hljs-keyword">this</span>.helpers = {};
    <span class="hljs-keyword">this</span>.cid = _.uniqueId(<span class="hljs-string">'collection'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>Set lineage</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.setParent( options.parent || <span class="hljs-keyword">this</span> );
    <span class="hljs-keyword">this</span>.setRoot( options.root || <span class="hljs-keyword">this</span> );
    <span class="hljs-keyword">this</span>.__path = options.path || <span class="hljs-keyword">this</span>.__path;

    Backbone.Collection.apply( <span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span> );</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>When a model is removed from its original collection, destroy it
TODO: Fix this. Computed properties now somehow allow collection to share a model. They may be removed from one but not the other. That is bad.
The clone = false options is the culprit. Find a better way to copy all of the collections custom attributes over to the clone.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.on(<span class="hljs-string">'remove'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(model, collection, options)</span></span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>model.deinitialize();</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    });

  },

  get: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key, options)</span></span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>If the key is a number or object, default to backbone’s collection get</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> key == <span class="hljs-string">'number'</span> || <span class="hljs-keyword">typeof</span> key == <span class="hljs-string">'object'</span>){
      <span class="hljs-keyword">return</span> Backbone.Collection.prototype.get.call(<span class="hljs-keyword">this</span>, key);
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p>If key is not a string, return undefined</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (!_.isString(key)) <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p>Split the path at all ‘.’, ‘[‘ and ‘]’ and find the value referanced.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> parts  = $.splitPath(key),
        result = <span class="hljs-keyword">this</span>,
        l=parts.length,
        i=<span class="hljs-number">0</span>;
        options || (options = {});

    <span class="hljs-keyword">if</span>(_.isUndefined(key) || _.isNull(key)) <span class="hljs-keyword">return</span> key;
    <span class="hljs-keyword">if</span>(key === <span class="hljs-string">''</span> || parts.length === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> result;

    <span class="hljs-keyword">if</span> (parts.length &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>; i &lt; l; i++) {</pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p>If returning raw, always return the first computed property found. If undefined, you’re done.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span>(result &amp;&amp; result.isComputedProperty &amp;&amp; options.raw) <span class="hljs-keyword">return</span> result;
        <span class="hljs-keyword">if</span>(result &amp;&amp; result.isComputedProperty) result = result.value();
        <span class="hljs-keyword">if</span>(_.isUndefined(result) || _.isNull(result)) <span class="hljs-keyword">return</span> result;
        <span class="hljs-keyword">if</span>(parts[i] === <span class="hljs-string">'@parent'</span>) result = result.__parent__;
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(result.isCollection) result = result.models[parts[i]];
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(result.isModel) result = result.attributes[parts[i]];
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(result.hasOwnProperty(parts[i])) result = result[parts[i]];
      }
    }

    <span class="hljs-keyword">if</span>(result &amp;&amp; result.isComputedProperty &amp;&amp; !options.raw) result = result.value();

    <span class="hljs-keyword">return</span> result;
  },

  set: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(models, options)</span></span>{
    <span class="hljs-keyword">var</span> newModels = [],
        lineage = {
          parent: <span class="hljs-keyword">this</span>,
          root: <span class="hljs-keyword">this</span>.__root__,
          path: pathGenerator(<span class="hljs-keyword">this</span>),
          silent: <span class="hljs-literal">true</span>
        };
        options = options || {},</pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <p>If no models passed, implies an empty array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    models || (models = []);</pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <p>If models is a string, call set at that path</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(_.isString(models)) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.get($.splitPath(models)[<span class="hljs-number">0</span>]).set($.splitPath(models).splice(<span class="hljs-number">1</span>, models.length).join(<span class="hljs-string">'.'</span>), options);
    <span class="hljs-keyword">if</span>(!_.isObject(models)) <span class="hljs-keyword">return</span> <span class="hljs-built_in">console</span>.error(<span class="hljs-string">'Collection.set must be passed a Model, Object, array or Models and Objects, or another Collection'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <p>If another collection, treat like an array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    models = (models.isCollection) ? models.models : models;</pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <p>Ensure models is an array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    models = (!_.isArray(models)) ? [models] : models;</pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <p>If the model already exists in this collection, or we are told not to clone it, let Backbone handle the merge
Otherwise, create our copy of this model, give them the same cid so our helpers treat them as the same object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    _.each(models, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data, index)</span></span>{
      <span class="hljs-keyword">if</span>(data.isModel &amp;&amp; options.clone === <span class="hljs-literal">false</span> || <span class="hljs-keyword">this</span>._byId[data.cid]) <span class="hljs-keyword">return</span> newModels[index] = data;
      newModels[index] = <span class="hljs-keyword">new</span> <span class="hljs-keyword">this</span>.model(data, _.defaults(lineage, options));
      data.isModel &amp;&amp; (newModels[index].cid = data.cid);
    }, <span class="hljs-keyword">this</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <p>Ensure that this element now knows that it has children now. Without this cyclic dependancies cause issues</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>._hasAncestry || (<span class="hljs-keyword">this</span>._hasAncestry = newModels.length &gt; <span class="hljs-number">0</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <p>Call original set function with model duplicates</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">return</span> Backbone.Collection.prototype.set.call(<span class="hljs-keyword">this</span>, newModels, options);

  }

});

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> Collection;</pre></div></div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              <h2 id="rebound-computed-property">Rebound Computed Property</h2>

            </div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">import</span> propertyCompiler <span class="hljs-keyword">from</span> <span class="hljs-string">"property-compiler/property-compiler"</span>;
<span class="hljs-keyword">import</span> $ from <span class="hljs-string">"rebound-component/utils"</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              <p>Returns true if str starts with test</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">startsWith</span><span class="hljs-params">(str, test)</span></span>{
  <span class="hljs-keyword">if</span>(str === test) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  <span class="hljs-keyword">return</span> str.substring(<span class="hljs-number">0</span>, test.length+<span class="hljs-number">1</span>) === test+<span class="hljs-string">'.'</span>;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-73">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-73">&#182;</a>
              </div>
              <p>Called after callstack is exausted to call all of this computed property’s
dependants that need to be recomputed</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">recomputeCallback</span><span class="hljs-params">()</span></span>{
  <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, len = <span class="hljs-keyword">this</span>._toCall.length;
  <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>._recomputeTimeout;
  <span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>;i&lt;len;i++){
    <span class="hljs-keyword">this</span>._toCall.shift().call();
  }
  <span class="hljs-keyword">this</span>._toCall.added = {};
}

<span class="hljs-keyword">var</span> ComputedProperty = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(getter, setter, options)</span></span>{

  <span class="hljs-keyword">if</span>(!_.isFunction(getter) &amp;&amp; !_.isFunction(setter)) <span class="hljs-keyword">return</span> <span class="hljs-built_in">console</span>.error(<span class="hljs-string">'ComputedProperty constructor must be passed a functions!'</span>, prop, <span class="hljs-string">'Found instead.'</span>);
  options = options || {};
  <span class="hljs-keyword">this</span>.cid = _.uniqueId(<span class="hljs-string">'computedPropety'</span>);
  <span class="hljs-keyword">this</span>.name = options.name;
  <span class="hljs-keyword">this</span>.returnType = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">this</span>.__observers = {};
  <span class="hljs-keyword">this</span>.helpers = {};
  <span class="hljs-keyword">this</span>.waiting = {};
  <span class="hljs-keyword">this</span>.isChanging = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">this</span>.isDirty = <span class="hljs-literal">true</span>;
  _.bindAll(<span class="hljs-keyword">this</span>, <span class="hljs-string">'onModify'</span>, <span class="hljs-string">'markDirty'</span>);

  <span class="hljs-keyword">if</span>(getter) <span class="hljs-keyword">this</span>.getter = getter;
  <span class="hljs-keyword">if</span>(setter) <span class="hljs-keyword">this</span>.setter = setter;
  <span class="hljs-keyword">this</span>.deps = propertyCompiler.compile(<span class="hljs-keyword">this</span>.getter, <span class="hljs-keyword">this</span>.name);</pre></div></div>
            
        </li>
        
        
        <li id="section-74">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-74">&#182;</a>
              </div>
              <p>Create lineage to pass to our cache objects</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> lineage = {
    parent: <span class="hljs-keyword">this</span>.setParent( options.parent || <span class="hljs-keyword">this</span> ),
    root: <span class="hljs-keyword">this</span>.setRoot( options.root || options.parent || <span class="hljs-keyword">this</span> ),
    path: <span class="hljs-keyword">this</span>.__path = options.path || <span class="hljs-keyword">this</span>.__path
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-75">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-75">&#182;</a>
              </div>
              <p>Results Cache Objects
These models will never be re-created for the lifetime of the Computed Proeprty
On Recompute they are updated with new values.
On Change their new values are pushed to the object it is tracking</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">this</span>.cache = {
    model: <span class="hljs-keyword">new</span> Rebound.Model({}, lineage),
    collection: <span class="hljs-keyword">new</span> Rebound.Collection([], lineage),
    value: <span class="hljs-literal">undefined</span>
  };

  <span class="hljs-keyword">this</span>.wire();

};

_.extend(ComputedProperty.prototype, Backbone.Events, {

  isComputedProperty: <span class="hljs-literal">true</span>,
  isData: <span class="hljs-literal">true</span>,
  __path: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{ <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>; },

  getter: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{ <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>; },
  setter: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{ <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>; },

  markDirty: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.isDirty) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">this</span>.isDirty = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">this</span>.trigger(<span class="hljs-string">'dirty'</span>, <span class="hljs-keyword">this</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-76">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-76">&#182;</a>
              </div>
              <p>Attached to listen to all events where this Computed Property’s dependancies
are stored. See wire(). Will re-evaluate any computed properties that
depend on the changed data value which triggered this callback.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  onRecompute: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(type, model, collection, options)</span></span>{
    <span class="hljs-keyword">var</span> shortcircuit = { change: <span class="hljs-number">1</span>, sort: <span class="hljs-number">1</span>, request: <span class="hljs-number">1</span>, destroy: <span class="hljs-number">1</span>, sync: <span class="hljs-number">1</span>, error: <span class="hljs-number">1</span>, invalid: <span class="hljs-number">1</span>, route: <span class="hljs-number">1</span>, dirty: <span class="hljs-number">1</span> };
    <span class="hljs-keyword">if</span>( shortcircuit[type] || !model.isData ) <span class="hljs-keyword">return</span>;
    model || (model = {});
    collection || (collection = {});
    options || (options = {});
    <span class="hljs-keyword">this</span>._toCall || (<span class="hljs-keyword">this</span>._toCall = []);
    <span class="hljs-keyword">this</span>._toCall.added || (<span class="hljs-keyword">this</span>._toCall.added = {});
    !collection.isData &amp;&amp; (options = collection) &amp;&amp; (collection = model);
    <span class="hljs-keyword">var</span> push = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(arr)</span></span>{
      <span class="hljs-keyword">var</span> i, len = arr.length;
      <span class="hljs-keyword">this</span>.added || (<span class="hljs-keyword">this</span>.added = {});
      <span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>;i&lt;len;i++){
        <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.added[arr[i].cid]) <span class="hljs-keyword">continue</span>;
        <span class="hljs-keyword">this</span>.added[arr[i].cid] = <span class="hljs-number">1</span>;
        <span class="hljs-keyword">this</span>.push(arr[i]);
      }
    }, path, vector;
    vector = path = collection.__path().replace(<span class="hljs-regexp">/\.?\[.*\]/ig</span>, <span class="hljs-string">'.@each'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-77">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-77">&#182;</a>
              </div>
              <p>If a reset event on a Model, check for computed properties that depend
on each changed attribute’s full path.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(type === <span class="hljs-string">'reset'</span> &amp;&amp; options.previousAttributes){
      _.each(options.previousAttributes, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value, key)</span></span>{
        vector = path + (path &amp;&amp; <span class="hljs-string">'.'</span>) + key;
        _.each(<span class="hljs-keyword">this</span>.__computedDeps, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(dependants, dependancy)</span></span>{
          startsWith(vector, dependancy) &amp;&amp; push.call(<span class="hljs-keyword">this</span>._toCall, dependants);
        }, <span class="hljs-keyword">this</span>);
      }, <span class="hljs-keyword">this</span>);
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-78">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-78">&#182;</a>
              </div>
              <p>If a reset event on a Collction, check for computed properties that depend
on anything inside that collection.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(type === <span class="hljs-string">'reset'</span> &amp;&amp; options.previousModels){
      _.each(<span class="hljs-keyword">this</span>.__computedDeps, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(dependants, dependancy)</span></span>{
        startsWith(dependancy, vector) &amp;&amp; push.call(<span class="hljs-keyword">this</span>._toCall, dependants);
      }, <span class="hljs-keyword">this</span>);
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-79">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-79">&#182;</a>
              </div>
              <p>If an add or remove event, check for computed properties that depend on
anything inside that collection or that contains that collection.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(type === <span class="hljs-string">'add'</span> || type === <span class="hljs-string">'remove'</span>){
      _.each(<span class="hljs-keyword">this</span>.__computedDeps, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(dependants, dependancy)</span></span>{
        <span class="hljs-keyword">if</span>( startsWith(dependancy, vector) || startsWith(vector, dependancy) ) push.call(<span class="hljs-keyword">this</span>._toCall, dependants);
      }, <span class="hljs-keyword">this</span>);
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-80">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-80">&#182;</a>
              </div>
              <p>If a change event, trigger anything that depends on that changed path.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(type.indexOf(<span class="hljs-string">'change:'</span>) === <span class="hljs-number">0</span>){
      vector = type.replace(<span class="hljs-string">'change:'</span>, <span class="hljs-string">''</span>).replace(<span class="hljs-regexp">/\.?\[.*\]/ig</span>, <span class="hljs-string">'.@each'</span>);
      _.each(<span class="hljs-keyword">this</span>.__computedDeps, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(dependants, dependancy)</span></span>{
        startsWith(vector, dependancy) &amp;&amp; push.call(<span class="hljs-keyword">this</span>._toCall, dependants);
      }, <span class="hljs-keyword">this</span>);
    }

    <span class="hljs-keyword">var</span> i, len = <span class="hljs-keyword">this</span>._toCall.length;
    <span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>;i&lt;len;i++){
      <span class="hljs-keyword">this</span>._toCall[i].markDirty();
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-81">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-81">&#182;</a>
              </div>
              <p>Notifies all computed properties in the dependants array to recompute.
Marks everyone as dirty and then calls them.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>._recomputeTimeout) <span class="hljs-keyword">this</span>._recomputeTimeout = setTimeout(_.bind(recomputeCallback, <span class="hljs-keyword">this</span>), <span class="hljs-number">0</span>);
    <span class="hljs-keyword">return</span>;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-82">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-82">&#182;</a>
              </div>
              <p>Called when a Computed Property’s active cache object changes.
Pushes any changes to Computed Property that returns a data object back to
the original object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  onModify: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(type, model, collection, options)</span></span>{
    <span class="hljs-keyword">var</span> shortcircuit = { sort: <span class="hljs-number">1</span>, request: <span class="hljs-number">1</span>, destroy: <span class="hljs-number">1</span>, sync: <span class="hljs-number">1</span>, error: <span class="hljs-number">1</span>, invalid: <span class="hljs-number">1</span>, route: <span class="hljs-number">1</span> };
    <span class="hljs-keyword">if</span>( !<span class="hljs-keyword">this</span>.tracking || shortcircuit[type] || ~type.indexOf(<span class="hljs-string">'change:'</span>) ) <span class="hljs-keyword">return</span>;
    model || (model = {});
    collection || (collection = {});
    options || (options = {});
    !collection.isData &amp;&amp; _.isObject(collection) &amp;&amp; (options = collection) &amp;&amp; (collection = model);
    <span class="hljs-keyword">var</span> src = <span class="hljs-keyword">this</span>;
    <span class="hljs-keyword">var</span> path = collection.__path().replace(src.__path(), <span class="hljs-string">''</span>).replace(<span class="hljs-regexp">/^\./</span>, <span class="hljs-string">''</span>);
    <span class="hljs-keyword">var</span> dest = <span class="hljs-keyword">this</span>.tracking.get(path);

    <span class="hljs-keyword">if</span>(_.isUndefined(dest)) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">if</span>(type === <span class="hljs-string">'change'</span>) dest.set &amp;&amp; dest.set(model.changedAttributes());
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(type === <span class="hljs-string">'reset'</span>) dest.reset &amp;&amp; dest.reset(model);
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(type === <span class="hljs-string">'add'</span>)  dest.add &amp;&amp; dest.add(model);
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(type === <span class="hljs-string">'remove'</span>)  dest.remove &amp;&amp; dest.remove(model);</pre></div></div>
            
        </li>
        
        
        <li id="section-83">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-83">&#182;</a>
              </div>
              <p>TODO: Add sort</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  },</pre></div></div>
            
        </li>
        
        
        <li id="section-84">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-84">&#182;</a>
              </div>
              <p>Adds a litener to the root object and tells it what properties this
Computed Property depend on.
The listener will re-compute this Computed Property when any are changed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  wire: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
    <span class="hljs-keyword">var</span> root = <span class="hljs-keyword">this</span>.__root__;
    <span class="hljs-keyword">var</span> context = <span class="hljs-keyword">this</span>.__parent__;
    root.__computedDeps || (root.__computedDeps = {});

    _.each(<span class="hljs-keyword">this</span>.deps, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(path)</span></span>{
      <span class="hljs-keyword">var</span> dep = root.get(path, {raw: <span class="hljs-literal">true</span>});
      <span class="hljs-keyword">if</span>(!dep || !dep.isComputedProperty) <span class="hljs-keyword">return</span>;
      dep.on(<span class="hljs-string">'dirty'</span>, <span class="hljs-keyword">this</span>.markDirty);
    }, <span class="hljs-keyword">this</span>);

    _.each(<span class="hljs-keyword">this</span>.deps, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(path)</span></span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-85">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-85">&#182;</a>
              </div>
              <p>Find actual path from relative paths</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> split = $.splitPath(path);
      <span class="hljs-keyword">while</span>(split[<span class="hljs-number">0</span>] === <span class="hljs-string">'@parent'</span>){
        context = context.__parent__;
        split.shift();
      }

      path = context.__path().replace(<span class="hljs-regexp">/\.?\[.*\]/ig</span>, <span class="hljs-string">'.@each'</span>);
      path = path + (path &amp;&amp; <span class="hljs-string">'.'</span>) + split.join(<span class="hljs-string">'.'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-86">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-86">&#182;</a>
              </div>
              <p>Add ourselves as dependants</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      root.__computedDeps[path] || (root.__computedDeps[path] = []);
      root.__computedDeps[path].push(<span class="hljs-keyword">this</span>);
    }, <span class="hljs-keyword">this</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-87">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-87">&#182;</a>
              </div>
              <p>Ensure we only have one listener per Model at a time.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    context.off(<span class="hljs-string">'all'</span>, <span class="hljs-keyword">this</span>.onRecompute).on(<span class="hljs-string">'all'</span>, <span class="hljs-keyword">this</span>.onRecompute);
  },

  unwire: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
    <span class="hljs-keyword">var</span> root = <span class="hljs-keyword">this</span>.__root__;
    <span class="hljs-keyword">var</span> context = <span class="hljs-keyword">this</span>.__parent__;

    _.each(<span class="hljs-keyword">this</span>.deps, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(path)</span></span>{
      <span class="hljs-keyword">var</span> dep = root.get(path, {raw: <span class="hljs-literal">true</span>});
      <span class="hljs-keyword">if</span>(!dep || !dep.isComputedProperty) <span class="hljs-keyword">return</span>;
      dep.off(<span class="hljs-string">'dirty'</span>, <span class="hljs-keyword">this</span>.markDirty);
    }, <span class="hljs-keyword">this</span>);

    context.off(<span class="hljs-string">'all'</span>, <span class="hljs-keyword">this</span>.onRecompute);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-88">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-88">&#182;</a>
              </div>
              <p>Call this computed property like you would with Function.call()</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  call: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
    <span class="hljs-keyword">var</span> args = <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>),
        context = args.shift();
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.apply(context, args);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-89">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-89">&#182;</a>
              </div>
              <p>Call this computed property like you would with Function.apply()
Only properties that are marked as dirty and are not already computing
themselves are evaluated to prevent cyclic callbacks. If any dependants
aren’t finished computeding, we add ourselved to their waiting list.
Vanilla objects returned from the function are promoted to Rebound Objects.
Then, set the proper return type for future fetches from the cache and set
the new computed value. Track changes to the cache to push it back up to
the original object and return the value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  apply: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(context, params)</span></span>{

    context || (context = <span class="hljs-keyword">this</span>.__parent__);

    <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>.isDirty || <span class="hljs-keyword">this</span>.isChanging || !context) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">this</span>.isChanging = <span class="hljs-literal">true</span>;

    <span class="hljs-keyword">var</span> value = <span class="hljs-keyword">this</span>.cache[<span class="hljs-keyword">this</span>.returnType],
        result;</pre></div></div>
            
        </li>
        
        
        <li id="section-90">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-90">&#182;</a>
              </div>
              <p>Check all of our dependancies to see if they are evaluating.
If we have a dependancy that is dirty and this isnt its first run,
Let this dependancy know that we are waiting for it.
It will re-run this Computed Property after it finishes.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    _.each(<span class="hljs-keyword">this</span>.deps, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(dep)</span></span>{
      <span class="hljs-keyword">var</span> dependancy = context.get(dep, {raw: <span class="hljs-literal">true</span>});
      <span class="hljs-keyword">if</span>(!dependancy || !dependancy.isComputedProperty) <span class="hljs-keyword">return</span>;
      <span class="hljs-keyword">if</span>(dependancy.isDirty &amp;&amp; dependancy.returnType !== <span class="hljs-literal">null</span>){
        dependancy.waiting[<span class="hljs-keyword">this</span>.cid] = <span class="hljs-keyword">this</span>;
        dependancy.apply(); <span class="hljs-comment">// Try to re-evaluate this dependancy if it is dirty</span>
        <span class="hljs-keyword">if</span>(dependancy.isDirty) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.isChanging = <span class="hljs-literal">false</span>;
      }
      <span class="hljs-keyword">delete</span> dependancy.waiting[<span class="hljs-keyword">this</span>.cid];</pre></div></div>
            
        </li>
        
        
        <li id="section-91">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-91">&#182;</a>
              </div>
              <p>TODO: There can be a check here looking for cyclic dependancies.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    }, <span class="hljs-keyword">this</span>);

    <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>.isChanging) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.returnType !== <span class="hljs-string">'value'</span>) <span class="hljs-keyword">this</span>.stopListening(value, <span class="hljs-string">'all'</span>, <span class="hljs-keyword">this</span>.onModify);

    result = <span class="hljs-keyword">this</span>.getter.apply(context, params);</pre></div></div>
            
        </li>
        
        
        <li id="section-92">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-92">&#182;</a>
              </div>
              <p>Promote vanilla objects to Rebound Data keeping the same original objects</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(_.isArray(result)) result = <span class="hljs-keyword">new</span> Rebound.Collection(result, {clone: <span class="hljs-literal">false</span>});
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(_.isObject(result) &amp;&amp; !result.isData) result = <span class="hljs-keyword">new</span> Rebound.Model(result, {clone: <span class="hljs-literal">false</span>});</pre></div></div>
            
        </li>
        
        
        <li id="section-93">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-93">&#182;</a>
              </div>
              <p>If result is undefined, reset our cache item</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(_.isUndefined(result) || _.isNull(result)){
      <span class="hljs-keyword">this</span>.returnType = <span class="hljs-string">'value'</span>;
      <span class="hljs-keyword">this</span>.isCollection = <span class="hljs-keyword">this</span>.isModel = <span class="hljs-literal">false</span>;
      <span class="hljs-keyword">this</span>.set(<span class="hljs-literal">undefined</span>);
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-94">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-94">&#182;</a>
              </div>
              <p>Set result and return types, bind events</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(result.isCollection){
      <span class="hljs-keyword">this</span>.returnType = <span class="hljs-string">'collection'</span>;
      <span class="hljs-keyword">this</span>.isCollection = <span class="hljs-literal">true</span>;
      <span class="hljs-keyword">this</span>.isModel = <span class="hljs-literal">false</span>;
      <span class="hljs-keyword">this</span>.set(result);
      <span class="hljs-keyword">this</span>.track(result);
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(result.isModel){
      <span class="hljs-keyword">this</span>.returnType = <span class="hljs-string">'model'</span>;
      <span class="hljs-keyword">this</span>.isCollection = <span class="hljs-literal">false</span>;
      <span class="hljs-keyword">this</span>.isModel = <span class="hljs-literal">true</span>;
      <span class="hljs-keyword">this</span>.reset(result);
      <span class="hljs-keyword">this</span>.track(result);
    }
    <span class="hljs-keyword">else</span>{
      <span class="hljs-keyword">this</span>.returnType = <span class="hljs-string">'value'</span>;
      <span class="hljs-keyword">this</span>.isCollection = <span class="hljs-keyword">this</span>.isModel = <span class="hljs-literal">false</span>;
      <span class="hljs-keyword">this</span>.reset(result);
    }

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.value();
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-95">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-95">&#182;</a>
              </div>
              <p>When we receive a new model to set in our cache, unbind the tracker from
the previous cache object, sync the objects’ cids so helpers think they
are the same object, save a referance to the object we are tracking,
and re-bind our onModify hook.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  track: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(object)</span></span>{
    <span class="hljs-keyword">var</span> target = <span class="hljs-keyword">this</span>.value();
    <span class="hljs-keyword">if</span>(!object || !target || !target.isData || !object.isData) <span class="hljs-keyword">return</span>;
    target._cid || (target._cid = target.cid);
    object._cid || (object._cid = object.cid);
    target.cid = object.cid;
    <span class="hljs-keyword">this</span>.tracking = object;
    <span class="hljs-keyword">this</span>.listenTo(target, <span class="hljs-string">'all'</span>, <span class="hljs-keyword">this</span>.onModify);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-96">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-96">&#182;</a>
              </div>
              <p>Get from the Computed Property’s cache</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  get: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key, options)</span></span>{
    <span class="hljs-keyword">var</span> value = <span class="hljs-keyword">this</span>.value();
    options || (options = {});
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.returnType === <span class="hljs-string">'value'</span>) <span class="hljs-keyword">return</span> <span class="hljs-built_in">console</span>.error(<span class="hljs-string">'Called get on the `'</span>+ <span class="hljs-keyword">this</span>.name +<span class="hljs-string">'` computed property which returns a primitive value.'</span>);
    <span class="hljs-keyword">return</span> value.get(key, options);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-97">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-97">&#182;</a>
              </div>
              <p>Set the Computed Property’s cache to a new value and trigger appropreate events.
Changes will propagate back to the original object if a Rebound Data Object and re-compute.
If Computed Property returns a value, all downstream dependancies will re-compute.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  set: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key, val, options)</span></span>{

    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.returnType === <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;
    options || (options = {});
    <span class="hljs-keyword">var</span> attrs = key;
    <span class="hljs-keyword">var</span> value = <span class="hljs-keyword">this</span>.value();</pre></div></div>
            
        </li>
        
        
        <li id="section-98">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-98">&#182;</a>
              </div>
              <p>Noralize the data passed in</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.returnType === <span class="hljs-string">'model'</span>){
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> key === <span class="hljs-string">'object'</span>) {
        attrs = (key.isModel) ? key.attributes : key;
        options = val;
      } <span class="hljs-keyword">else</span> {
        (attrs = {})[key] = val;
      }
    }
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.returnType !== <span class="hljs-string">'model'</span>) options = val || {};
    attrs = (attrs &amp;&amp; attrs.isComputedProperty) ? attrs.value() : attrs;</pre></div></div>
            
        </li>
        
        
        <li id="section-99">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-99">&#182;</a>
              </div>
              <p>If a new value, set it and trigger events</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.setter &amp;&amp; <span class="hljs-keyword">this</span>.setter.call(<span class="hljs-keyword">this</span>.__root__, attrs);
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.returnType === <span class="hljs-string">'value'</span> &amp;&amp; <span class="hljs-keyword">this</span>.cache.value !== attrs){
      <span class="hljs-keyword">this</span>.cache.value = attrs;
      <span class="hljs-keyword">if</span>(!options.quiet){</pre></div></div>
            
        </li>
        
        
        <li id="section-100">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-100">&#182;</a>
              </div>
              <p>If set was called not through computedProperty.call(), this is a fresh new event burst.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>.isDirty &amp;&amp; !<span class="hljs-keyword">this</span>.isChanging) <span class="hljs-keyword">this</span>.__parent__.changed = {};
        <span class="hljs-keyword">this</span>.__parent__.changed[<span class="hljs-keyword">this</span>.name] = attrs;
        <span class="hljs-keyword">this</span>.trigger(<span class="hljs-string">'change'</span>, <span class="hljs-keyword">this</span>.__parent__);
        <span class="hljs-keyword">this</span>.trigger(<span class="hljs-string">'change:'</span>+<span class="hljs-keyword">this</span>.name, <span class="hljs-keyword">this</span>.__parent__, attrs);
        <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.__parent__.changed[<span class="hljs-keyword">this</span>.name];
      }
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.returnType !== <span class="hljs-string">'value'</span> &amp;&amp; options.reset) key = value.reset(attrs, options);
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.returnType !== <span class="hljs-string">'value'</span>) key = value.set(attrs, options);
    <span class="hljs-keyword">this</span>.isDirty = <span class="hljs-keyword">this</span>.isChanging = <span class="hljs-literal">false</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-101">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-101">&#182;</a>
              </div>
              <p>Call all reamining computed properties waiting for this value to resolve.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    _.each(<span class="hljs-keyword">this</span>.waiting, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(prop)</span></span>{ prop &amp;&amp; prop.call(); });

    <span class="hljs-keyword">return</span> key;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-102">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-102">&#182;</a>
              </div>
              <p>Return the current value from the cache, running if dirty.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  value: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.isDirty) <span class="hljs-keyword">this</span>.apply();
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.cache[<span class="hljs-keyword">this</span>.returnType];
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-103">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-103">&#182;</a>
              </div>
              <p>Reset the current value in the cache, running if first run.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  reset: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj, options)</span></span>{
    <span class="hljs-keyword">if</span>(_.isNull(<span class="hljs-keyword">this</span>.returnType)) <span class="hljs-keyword">return</span>; <span class="hljs-comment">// First run</span>
    options || (options = {});
    options.reset = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">return</span>  <span class="hljs-keyword">this</span>.set(obj, options);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-104">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-104">&#182;</a>
              </div>
              <p>Cyclic dependancy safe toJSON method.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  toJSON: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._isSerializing) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.cid;
    <span class="hljs-keyword">var</span> val = <span class="hljs-keyword">this</span>.value();
    <span class="hljs-keyword">this</span>._isSerializing = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">var</span> json = (val &amp;&amp; _.isFunction(val.toJSON)) ? val.toJSON() : val;
    <span class="hljs-keyword">this</span>._isSerializing = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">return</span> json;
  }

});

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> ComputedProperty;</pre></div></div>
            
        </li>
        
        
        <li id="section-105">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-105">&#182;</a>
              </div>
              <h2 id="rebound-component">Rebound Component</h2>

            </div>
            
        </li>
        
        
        <li id="section-106">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-106">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">import</span> DOMHelper <span class="hljs-keyword">from</span> <span class="hljs-string">"dom-helper"</span>;
<span class="hljs-keyword">import</span> render <span class="hljs-keyword">from</span> <span class="hljs-string">"htmlbars-runtime/render"</span>;
<span class="hljs-keyword">import</span> hooks <span class="hljs-keyword">from</span> <span class="hljs-string">"rebound-component/hooks"</span>;
<span class="hljs-keyword">import</span> helpers <span class="hljs-keyword">from</span> <span class="hljs-string">"rebound-component/helpers"</span>;
<span class="hljs-keyword">import</span> $ from <span class="hljs-string">"rebound-component/utils"</span>;
<span class="hljs-keyword">import</span> { Model } <span class="hljs-keyword">from</span> <span class="hljs-string">"rebound-data/rebound-data"</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-107">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-107">&#182;</a>
              </div>
              <p>Returns true if <code>str</code> starts with <code>test</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">startsWith</span><span class="hljs-params">(str, test)</span></span>{
  <span class="hljs-keyword">if</span>(str === test) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  str = $.splitPath(str);
  test = $.splitPath(test);
  <span class="hljs-keyword">while</span>(test[<span class="hljs-number">0</span>] &amp;&amp; str[<span class="hljs-number">0</span>]){
    <span class="hljs-keyword">if</span>(str[<span class="hljs-number">0</span>] !== test[<span class="hljs-number">0</span>] &amp;&amp; str[<span class="hljs-number">0</span>] !== <span class="hljs-string">'@each'</span> &amp;&amp; test[<span class="hljs-number">0</span>] !== <span class="hljs-string">'@each'</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    test.shift();
    str.shift();
  }
  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-108">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-108">&#182;</a>
              </div>
              <p>New Backbone Component</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> Component = Model.extend({

  isComponent: <span class="hljs-literal">true</span>,

  _render: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
    <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, len = <span class="hljs-keyword">this</span>._toRender.length, key;
    <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>._renderTimeout;
    <span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>;i&lt;len;i++){
      <span class="hljs-keyword">this</span>._toRender.shift().notify();
    }
    <span class="hljs-keyword">this</span>._toRender.added = {};
    <span class="hljs-keyword">for</span>(key <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span>.env.revalidateQueue){
      <span class="hljs-keyword">this</span>.env.revalidateQueue[key].revalidate();
    }
  },

  _callOnComponent: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name, event)</span></span>{
    <span class="hljs-keyword">if</span>(!_.isFunction(<span class="hljs-keyword">this</span>[name])){ <span class="hljs-keyword">throw</span> <span class="hljs-string">"ERROR: No method named "</span> + name + <span class="hljs-string">" on component "</span> + <span class="hljs-keyword">this</span>.__name + <span class="hljs-string">"!"</span>; }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>[name].call(<span class="hljs-keyword">this</span>, event);
  },

  _listenToService: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key, service)</span></span>{
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
    <span class="hljs-keyword">this</span>.listenTo(service, <span class="hljs-string">'all'</span>, (type, model, value, options) =&gt; {
      <span class="hljs-keyword">var</span> attr,
          path = model.__path(),
          changed;
      <span class="hljs-keyword">if</span>(type.indexOf(<span class="hljs-string">'change:'</span>) === <span class="hljs-number">0</span>){
        changed = model.changedAttributes();
        <span class="hljs-keyword">for</span>(attr <span class="hljs-keyword">in</span> changed){</pre></div></div>
            
        </li>
        
        
        <li id="section-109">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-109">&#182;</a>
              </div>
              <p>TODO: Modifying arguments array is bad. change this</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          type = (<span class="hljs-string">'change:'</span> + key + <span class="hljs-string">'.'</span> + path + (path &amp;&amp; <span class="hljs-string">'.'</span>) + attr); <span class="hljs-comment">// jshint ignore:line</span>
          options.service = key;
          <span class="hljs-keyword">this</span>.trigger.call(<span class="hljs-keyword">this</span>, type, model, value, options);
        }
        <span class="hljs-keyword">return</span>;
      }
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.trigger.call(<span class="hljs-keyword">this</span>, type, model, value, options);
    });
  },

  deinitialize: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.consumers.length) <span class="hljs-keyword">return</span>;
    _.each(<span class="hljs-keyword">this</span>.services, (service, key) =&gt; {
      _.each(service.consumers, (consumer, index) =&gt; {
        <span class="hljs-keyword">if</span>(consumer.component === <span class="hljs-keyword">this</span>) service.consumers.splice(index, <span class="hljs-number">1</span>);
      });
    });
    <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.services;
    Rebound.Model.prototype.deinitialize.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-110">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-110">&#182;</a>
              </div>
              <p>Set is overridden on components to accept components as a valid input type.
Components set on other Components are mixed in as a shared object. {raw: true}
It also marks itself as a consumer of this component</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  set: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key, val, options)</span></span>{
    <span class="hljs-keyword">var</span> attrs, attr, serviceOptions;
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> key === <span class="hljs-string">'object'</span>) {
      attrs = (key.isModel) ? key.attributes : key;
      options = val;
    } <span class="hljs-keyword">else</span> (attrs = {})[key] = val;
    options || (options = {});</pre></div></div>
            
        </li>
        
        
        <li id="section-111">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-111">&#182;</a>
              </div>
              <p>If reset option passed, do a reset. If nothing passed, return.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(options.reset === <span class="hljs-literal">true</span>) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.reset(attrs, options);
    <span class="hljs-keyword">if</span>(options.defaults === <span class="hljs-literal">true</span>) <span class="hljs-keyword">this</span>.defaults = attrs;
    <span class="hljs-keyword">if</span>(_.isEmpty(attrs)) <span class="hljs-keyword">return</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-112">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-112">&#182;</a>
              </div>
              <p>For each attribute passed:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">for</span>(key <span class="hljs-keyword">in</span> attrs){
      attr = attrs[key];
      <span class="hljs-keyword">if</span>(attr &amp;&amp; attr.isComponent){
        serviceOptions || (serviceOptions = _.defaults(_.clone(options), {raw: <span class="hljs-literal">true</span>}));
        attr.consumers.push({key: key, component: <span class="hljs-keyword">this</span>});
        <span class="hljs-keyword">this</span>.services[key] = attr;
        <span class="hljs-keyword">this</span>._listenToService(key, attr);
        Rebound.Model.prototype.set.call(<span class="hljs-keyword">this</span>, key, attr, serviceOptions);
      }
      Rebound.Model.prototype.set.call(<span class="hljs-keyword">this</span>, key, attr, options);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  },

  constructor: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options)</span></span>{
    <span class="hljs-keyword">var</span> key, attr, self = <span class="hljs-keyword">this</span>;
    options = options || (options = {});
    _.bindAll(<span class="hljs-keyword">this</span>, <span class="hljs-string">'_callOnComponent'</span>, <span class="hljs-string">'_listenToService'</span>, <span class="hljs-string">'_render'</span>);
    <span class="hljs-keyword">this</span>.cid = _.uniqueId(<span class="hljs-string">'component'</span>);
    <span class="hljs-keyword">this</span>.env = hooks.createChildEnv(hooks.createFreshEnv());</pre></div></div>
            
        </li>
        
        
        <li id="section-113">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-113">&#182;</a>
              </div>
              <p>Call on component is used by the {{on}} helper to call all event callbacks in the scope of the component</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.env.helpers._callOnComponent = <span class="hljs-keyword">this</span>._callOnComponent;
    <span class="hljs-keyword">this</span>.attributes = {};
    <span class="hljs-keyword">this</span>.changed = {};
    <span class="hljs-keyword">this</span>.consumers = [];
    <span class="hljs-keyword">this</span>.services = {};
    <span class="hljs-keyword">this</span>.__parent__ = <span class="hljs-keyword">this</span>.__root__ = <span class="hljs-keyword">this</span>;
    <span class="hljs-keyword">this</span>.listenTo(<span class="hljs-keyword">this</span>, <span class="hljs-string">'all'</span>, <span class="hljs-keyword">this</span>._onChange);</pre></div></div>
            
        </li>
        
        
        <li id="section-114">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-114">&#182;</a>
              </div>
              <p>Take our parsed data and add it to our backbone data structure. Does a deep defaults set.
In the model, primatives (arrays, objects, etc) are converted to Backbone Objects
Functions are compiled to find their dependancies and added as computed properties
Set our component’s context with the passed data merged with the component’s defaults</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.set((<span class="hljs-keyword">this</span>.defaults || {}));
    <span class="hljs-keyword">this</span>.set((options.data || {}));</pre></div></div>
            
        </li>
        
        
        <li id="section-115">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-115">&#182;</a>
              </div>
              <p>Get any additional routes passed in from options</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.routes =  _.defaults((options.routes || {}), <span class="hljs-keyword">this</span>.routes);</pre></div></div>
            
        </li>
        
        
        <li id="section-116">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-116">&#182;</a>
              </div>
              <p>Ensure that all route functions exist</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    _.each(<span class="hljs-keyword">this</span>.routes, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value, key, routes)</span></span>{
        <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> value !== <span class="hljs-string">'string'</span>){ <span class="hljs-keyword">throw</span>(<span class="hljs-string">'Function name passed to routes in  '</span> + <span class="hljs-keyword">this</span>.__name + <span class="hljs-string">' component must be a string!'</span>); }
        <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>[value]){ <span class="hljs-keyword">throw</span>(<span class="hljs-string">'Callback function '</span>+value+<span class="hljs-string">' does not exist on the  '</span> + <span class="hljs-keyword">this</span>.__name + <span class="hljs-string">' component!'</span>); }
    }, <span class="hljs-keyword">this</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-117">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-117">&#182;</a>
              </div>
              <p>Set our outlet and template if we have them</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.el = options.outlet || <span class="hljs-built_in">document</span>.createDocumentFragment();
    <span class="hljs-keyword">this</span>.$el = (_.isUndefined(<span class="hljs-built_in">window</span>.Backbone.$)) ? <span class="hljs-literal">false</span> : <span class="hljs-built_in">window</span>.Backbone.$(<span class="hljs-keyword">this</span>.el);
    <span class="hljs-keyword">this</span>.template = options.template || <span class="hljs-keyword">this</span>.template;
    <span class="hljs-keyword">this</span>.el.data = <span class="hljs-keyword">this</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-118">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-118">&#182;</a>
              </div>
              <p>Render our dom and place the dom in our custom element
TODO: Check if template is a string, and if the compiler exists on the page, and compile if needed</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.template){
      (<span class="hljs-keyword">this</span>.template.reboundTemplate) || (<span class="hljs-keyword">this</span>.template = hooks.wrap(<span class="hljs-keyword">this</span>.template));
      <span class="hljs-keyword">this</span>.template = <span class="hljs-keyword">this</span>.template.render(<span class="hljs-keyword">this</span>, <span class="hljs-keyword">this</span>.env, { contextualElement: <span class="hljs-keyword">this</span>.el }, {});
      <span class="hljs-keyword">this</span>.el.appendChild(<span class="hljs-keyword">this</span>.template.fragment);</pre></div></div>
            
        </li>
        
        
        <li id="section-119">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-119">&#182;</a>
              </div>
              <p>Add active class to this newly rendered template’s link elements that require it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      $(<span class="hljs-keyword">this</span>.el).markLinks();
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-120">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-120">&#182;</a>
              </div>
              <p>Our Component is fully created now, but not rendered. Call created callback.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(_.isFunction(<span class="hljs-keyword">this</span>.createdCallback)){
      <span class="hljs-keyword">this</span>.createdCallback.call(<span class="hljs-keyword">this</span>);
    }

    <span class="hljs-keyword">this</span>.initialize();

  },

  $: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(selector)</span> </span>{
    <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>.$el){
      <span class="hljs-keyword">return</span> <span class="hljs-built_in">console</span>.error(<span class="hljs-string">'No DOM manipulation library on the page!'</span>);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.$el.find(selector);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-121">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-121">&#182;</a>
              </div>
              <p>Trigger all events on both the component and the element</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  trigger: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(eventName)</span></span>{
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.el){
      $(<span class="hljs-keyword">this</span>.el).trigger(eventName, <span class="hljs-built_in">arguments</span>);
    }
    Backbone.Model.prototype.trigger.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);
  },

  _onAttributeChange: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(attrName, oldVal, newVal)</span></span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-122">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-122">&#182;</a>
              </div>
              <p>Commented out because tracking attribute changes and making sure they dont infinite loop is hard.
TODO: Make work.
try{ newVal = JSON.parse(newVal); } catch (e){ newVal = newVal; }</p>
<p>// data attributes should be referanced by their camel case name
attrName = attrName.replace(/^data-/g, “”).replace(/-([a-z])/g, function (g) { return g[1].toUpperCase(); });</p>
<p>oldVal = this.get(attrName);</p>
<p>if(newVal === null){ this.unset(attrName); }</p>
<p>// If oldVal is a number, and newVal is only numerical, preserve type
if(<em>.isNumber(oldVal) &amp;&amp; </em>.isString(newVal) &amp;&amp; newVal.match(/^[0-9]*$/i)){
  newVal = parseInt(newVal);
}</p>
<p>else{ this.set(attrName, newVal, {quiet: true}); }</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  },


  _onChange: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(type, model, collection, options)</span></span>{
    <span class="hljs-keyword">var</span> shortcircuit = { change: <span class="hljs-number">1</span>, sort: <span class="hljs-number">1</span>, request: <span class="hljs-number">1</span>, destroy: <span class="hljs-number">1</span>, sync: <span class="hljs-number">1</span>, error: <span class="hljs-number">1</span>, invalid: <span class="hljs-number">1</span>, route: <span class="hljs-number">1</span>, dirty: <span class="hljs-number">1</span> };
    <span class="hljs-keyword">if</span>( shortcircuit[type] ) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">var</span> data, changed;
    model || (model = {});
    collection || (collection = {});
    options || (options = {});
    !collection.isData &amp;&amp; (type.indexOf(<span class="hljs-string">'change:'</span>) === -<span class="hljs-number">1</span>) &amp;&amp; (options = collection) &amp;&amp; (collection = model);
    <span class="hljs-keyword">this</span>._toRender || (<span class="hljs-keyword">this</span>._toRender = []);

    <span class="hljs-keyword">if</span>( (type === <span class="hljs-string">'reset'</span> &amp;&amp; options.previousAttributes) || type.indexOf(<span class="hljs-string">'change:'</span>) !== -<span class="hljs-number">1</span>){
      data = model;
      changed = model.changedAttributes();
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(type === <span class="hljs-string">'add'</span> || type === <span class="hljs-string">'remove'</span> || (type === <span class="hljs-string">'reset'</span> &amp;&amp; options.previousModels)){
      data = collection;
      changed = {
        <span class="hljs-string">'@each'</span>: data
      };
    }

    <span class="hljs-keyword">if</span>(!data || !changed) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">var</span> push = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(arr)</span></span>{
      <span class="hljs-keyword">var</span> i, len = arr.length;
      <span class="hljs-keyword">this</span>.added || (<span class="hljs-keyword">this</span>.added = {});
      <span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>;i&lt;len;i++){
        <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.added[arr[i].cid]) <span class="hljs-keyword">continue</span>;
        <span class="hljs-keyword">this</span>.added[arr[i].cid] = <span class="hljs-number">1</span>;
        <span class="hljs-keyword">this</span>.push(arr[i]);
      }
    };
    <span class="hljs-keyword">var</span> context = <span class="hljs-keyword">this</span>;
    <span class="hljs-keyword">var</span> basePath = data.__path();</pre></div></div>
            
        </li>
        
        
        <li id="section-123">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-123">&#182;</a>
              </div>
              <p>If this event came from within a service, include the service key in the base path</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(options.service) basePath = options.service + <span class="hljs-string">'.'</span> + basePath;
    <span class="hljs-keyword">var</span> parts = $.splitPath(basePath);
    <span class="hljs-keyword">var</span> key, obsPath, path, observers;</pre></div></div>
            
        </li>
        
        
        <li id="section-124">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-124">&#182;</a>
              </div>
              <p>For each changed key, walk down the data tree from the root to the data
element that triggered the event and add all relevent callbacks to this
object’s _toRender queue.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">do</span>{
      <span class="hljs-keyword">for</span>(key <span class="hljs-keyword">in</span> changed){
        path = (basePath + (basePath &amp;&amp; key &amp;&amp; <span class="hljs-string">'.'</span>) + key).replace(context.__path(), <span class="hljs-string">''</span>).replace(<span class="hljs-regexp">/\[[^\]]+\]/g</span>, <span class="hljs-string">".@each"</span>).replace(<span class="hljs-regexp">/^\./</span>, <span class="hljs-string">''</span>);
        <span class="hljs-keyword">for</span>(obsPath <span class="hljs-keyword">in</span> context.__observers){
          observers = context.__observers[obsPath];
          <span class="hljs-keyword">if</span>(startsWith(obsPath, path)){</pre></div></div>
            
        </li>
        
        
        <li id="section-125">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-125">&#182;</a>
              </div>
              <p>If this is a collection event, trigger everything, otherwise only trigger property change callbacks</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span>(data.isCollection) push.call(<span class="hljs-keyword">this</span>._toRender, observers.collection);
            push.call(<span class="hljs-keyword">this</span>._toRender, observers.model);
          }
        }
      }
    } <span class="hljs-keyword">while</span>(context !== data &amp;&amp; (context = context.get(parts.shift())));</pre></div></div>
            
        </li>
        
        
        <li id="section-126">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-126">&#182;</a>
              </div>
              <p>Queue our render callback to be called after the current call stack has been exhausted</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-built_in">window</span>.clearTimeout(<span class="hljs-keyword">this</span>._renderTimeout);
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.el &amp;&amp; <span class="hljs-keyword">this</span>.el.testing) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._render();
    <span class="hljs-keyword">this</span>._renderTimeout = <span class="hljs-built_in">window</span>.setTimeout(<span class="hljs-keyword">this</span>._render, <span class="hljs-number">0</span>);
  }

});


Component.extend= <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(protoProps, staticProps)</span> </span>{
  <span class="hljs-keyword">var</span> parent = <span class="hljs-keyword">this</span>,
      child,
      reservedMethods = {
        <span class="hljs-string">'trigger'</span>:<span class="hljs-number">1</span>,    <span class="hljs-string">'constructor'</span>:<span class="hljs-number">1</span>, <span class="hljs-string">'get'</span>:<span class="hljs-number">1</span>,               <span class="hljs-string">'set'</span>:<span class="hljs-number">1</span>,             <span class="hljs-string">'has'</span>:<span class="hljs-number">1</span>,
        <span class="hljs-string">'extend'</span>:<span class="hljs-number">1</span>,     <span class="hljs-string">'escape'</span>:<span class="hljs-number">1</span>,      <span class="hljs-string">'unset'</span>:<span class="hljs-number">1</span>,             <span class="hljs-string">'clear'</span>:<span class="hljs-number">1</span>,           <span class="hljs-string">'cid'</span>:<span class="hljs-number">1</span>,
        <span class="hljs-string">'attributes'</span>:<span class="hljs-number">1</span>, <span class="hljs-string">'changed'</span>:<span class="hljs-number">1</span>,     <span class="hljs-string">'toJSON'</span>:<span class="hljs-number">1</span>,            <span class="hljs-string">'validationError'</span>:<span class="hljs-number">1</span>, <span class="hljs-string">'isValid'</span>:<span class="hljs-number">1</span>,
        <span class="hljs-string">'isNew'</span>:<span class="hljs-number">1</span>,      <span class="hljs-string">'hasChanged'</span>:<span class="hljs-number">1</span>,  <span class="hljs-string">'changedAttributes'</span>:<span class="hljs-number">1</span>, <span class="hljs-string">'previous'</span>:<span class="hljs-number">1</span>,        <span class="hljs-string">'previousAttributes'</span>:<span class="hljs-number">1</span>
      },
      configProperties = {
        <span class="hljs-string">'routes'</span>:<span class="hljs-number">1</span>,     <span class="hljs-string">'template'</span>:<span class="hljs-number">1</span>,    <span class="hljs-string">'defaults'</span>:<span class="hljs-number">1</span>, <span class="hljs-string">'outlet'</span>:<span class="hljs-number">1</span>,          <span class="hljs-string">'url'</span>:<span class="hljs-number">1</span>,
        <span class="hljs-string">'urlRoot'</span>:<span class="hljs-number">1</span>,    <span class="hljs-string">'idAttribute'</span>:<span class="hljs-number">1</span>, <span class="hljs-string">'id'</span>:<span class="hljs-number">1</span>,       <span class="hljs-string">'createdCallback'</span>:<span class="hljs-number">1</span>, <span class="hljs-string">'attachedCallback'</span>:<span class="hljs-number">1</span>,
        <span class="hljs-string">'detachedCallback'</span>:<span class="hljs-number">1</span>
      };

  protoProps || (protoProps = {});
  staticProps || (staticProps = {});
  protoProps.defaults = {};</pre></div></div>
            
        </li>
        
        
        <li id="section-127">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-127">&#182;</a>
              </div>
              <p>staticProps.services = {};</p>

            </div>
            
        </li>
        
        
        <li id="section-128">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-128">&#182;</a>
              </div>
              <p>If given a constructor, use it, otherwise use the default one defined above</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (protoProps &amp;&amp; _.has(protoProps, <span class="hljs-string">'constructor'</span>)) {
    child = protoProps.constructor;
  } <span class="hljs-keyword">else</span> {
    child = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{ <span class="hljs-keyword">return</span> parent.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>); };
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-129">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-129">&#182;</a>
              </div>
              <p>Our class should inherit everything from its parent, defined above</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> Surrogate = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{ <span class="hljs-keyword">this</span>.constructor = child; };
  Surrogate.prototype = parent.prototype;
  child.prototype = <span class="hljs-keyword">new</span> Surrogate();

  $.extractComputedProps(protoProps);</pre></div></div>
            
        </li>
        
        
        <li id="section-130">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-130">&#182;</a>
              </div>
              <p>For each property passed into our component base class</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> key <span class="hljs-keyword">in</span> protoProps){
    <span class="hljs-keyword">let</span> get, set;</pre></div></div>
            
        </li>
        
        
        <li id="section-131">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-131">&#182;</a>
              </div>
              <p>If a configuration property, or not actually on the obj, ignore it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(!protoProps.hasOwnProperty(key) || configProperties[key]) <span class="hljs-keyword">continue</span>;

    <span class="hljs-keyword">let</span> value = protoProps[key];</pre></div></div>
            
        </li>
        
        
        <li id="section-132">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-132">&#182;</a>
              </div>
              <p>If a primative or backbone type object, or computed property (function which takes no arguments and returns a value) move it to our defaults</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(!_.isFunction(value) || value.isComputedProto || value.isModel || value.isComponent){
      protoProps.defaults[key] = value;
      <span class="hljs-keyword">delete</span> protoProps[key];
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-133">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-133">&#182;</a>
              </div>
              <p>If a reserved method, yell</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(reservedMethods[key]){ <span class="hljs-keyword">throw</span> <span class="hljs-string">"ERROR: "</span> + key + <span class="hljs-string">" is a reserved method name in "</span> + staticProps.__name + <span class="hljs-string">"!"</span>; }</pre></div></div>
            
        </li>
        
        
        <li id="section-134">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-134">&#182;</a>
              </div>
              <p>All other values are component methods, leave them be unless already defined.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-135">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-135">&#182;</a>
              </div>
              <p>Extend our prototype with any remaining protoProps, overriting pre-defined ones</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (protoProps){ _.extend(child.prototype, protoProps, staticProps); }</pre></div></div>
            
        </li>
        
        
        <li id="section-136">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-136">&#182;</a>
              </div>
              <p>Set our ancestry</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  child.__super__ = parent.prototype;

  <span class="hljs-keyword">return</span> child;
};

Component.registerComponent = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">registerComponent</span><span class="hljs-params">(name, options)</span> </span>{
  <span class="hljs-keyword">var</span> script = options.prototype;
  <span class="hljs-keyword">var</span> template = options.template;
  <span class="hljs-keyword">var</span> style = options.style;
  name = name;

  <span class="hljs-keyword">var</span> component = <span class="hljs-keyword">this</span>.extend(script, { __name: name });
  <span class="hljs-keyword">var</span> proto = <span class="hljs-built_in">Object</span>.create(HTMLElement.prototype, {});

  proto.createdCallback = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">new</span> component({
      template: template,
      outlet: <span class="hljs-keyword">this</span>,
      data: Rebound.seedData,
      content: Rebound.content
    });
  };

  proto.attachedCallback = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    script.attachedCallback &amp;&amp; script.attachedCallback.call(<span class="hljs-keyword">this</span>.data);
  };

  proto.detachedCallback = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    script.detachedCallback &amp;&amp; script.detachedCallback.call(<span class="hljs-keyword">this</span>.data);
    <span class="hljs-keyword">this</span>.data.deinitialize();
  };

  proto.attributeChangedCallback = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(attrName, oldVal, newVal)</span> </span>{
    <span class="hljs-keyword">this</span>.data._onAttributeChange(attrName, oldVal, newVal);
    script.attributeChangedCallback &amp;&amp; script.attributeChangedCallback.call(<span class="hljs-keyword">this</span>.data, attrName, oldVal, newVal);
  };

  <span class="hljs-keyword">return</span> <span class="hljs-built_in">document</span>.registerElement(name, { prototype: proto });
};

_.bindAll(Component, <span class="hljs-string">'registerComponent'</span>);

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> Component;</pre></div></div>
            
        </li>
        
        
        <li id="section-137">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-137">&#182;</a>
              </div>
              <h2 id="rebound-helpers">Rebound Helpers</h2>

            </div>
            
        </li>
        
        
        <li id="section-138">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-138">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">import</span> LazyValue <span class="hljs-keyword">from</span> <span class="hljs-string">"rebound-component/lazy-value"</span>;
<span class="hljs-keyword">import</span> $ from <span class="hljs-string">"rebound-component/utils"</span>;


<span class="hljs-keyword">var</span> helpers  = {},
    partials = {};

helpers.registerPartial = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name, func)</span></span>{
  <span class="hljs-keyword">if</span>(func &amp;&amp; <span class="hljs-keyword">typeof</span> name === <span class="hljs-string">'string'</span>){
    <span class="hljs-keyword">return</span> partials[name] = func;
  }
};

helpers.hasHelper = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(env, scope, name)</span> </span>{
  <span class="hljs-keyword">return</span> env.helpers[name] !== <span class="hljs-literal">undefined</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-139">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-139">&#182;</a>
              </div>
              <p>lookupHelper returns the given function from the helpers object. Manual checks prevent user from overriding reserved words.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>helpers.lookupHelper = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(env, scope, name)</span> </span>{
  <span class="hljs-keyword">if</span>(_.isString(env)) name = env;
  (env &amp;&amp; env.helpers) || (env = {helpers:helpers});</pre></div></div>
            
        </li>
        
        
        <li id="section-140">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-140">&#182;</a>
              </div>
              <p>If a reserved helper, return it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>(name === <span class="hljs-string">'attribute'</span>) { <span class="hljs-keyword">return</span> env.helpers.attribute; }
  <span class="hljs-keyword">if</span>(name === <span class="hljs-string">'if'</span>) { <span class="hljs-keyword">return</span> env.helpers.if; }
  <span class="hljs-keyword">if</span>(name === <span class="hljs-string">'unless'</span>) { <span class="hljs-keyword">return</span> env.helpers.unless; }
  <span class="hljs-keyword">if</span>(name === <span class="hljs-string">'each'</span>) { <span class="hljs-keyword">return</span> env.helpers.each; }
  <span class="hljs-keyword">if</span>(name === <span class="hljs-string">'partial'</span>) { <span class="hljs-keyword">return</span> env.helpers.partial; }
  <span class="hljs-keyword">if</span>(name === <span class="hljs-string">'on'</span>) { <span class="hljs-keyword">return</span> env.helpers.on; }
  <span class="hljs-keyword">if</span>(name === <span class="hljs-string">'debugger'</span>) { <span class="hljs-keyword">return</span> env.helpers.debugger; }
  <span class="hljs-keyword">if</span>(name === <span class="hljs-string">'log'</span>) { <span class="hljs-keyword">return</span> env.helpers.log; }</pre></div></div>
            
        </li>
        
        
        <li id="section-141">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-141">&#182;</a>
              </div>
              <p>If not a reserved helper, check env, then global helpers, else return false</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">return</span> helpers[name] || env.helpers[name];
};

helpers.registerHelper = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name, callback)</span></span>{
  <span class="hljs-keyword">if</span>(!_.isString(name)){
    <span class="hljs-built_in">console</span>.error(<span class="hljs-string">'Name provided to registerHelper must be a string!'</span>);
    <span class="hljs-keyword">return</span>;
  }
  <span class="hljs-keyword">if</span>(!_.isFunction(callback)){
    <span class="hljs-built_in">console</span>.error(<span class="hljs-string">'Callback provided to regierHelper must be a function!'</span>);
    <span class="hljs-keyword">return</span>;
  }
  <span class="hljs-keyword">if</span>(helpers.lookupHelper(<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, name)){
    <span class="hljs-built_in">console</span>.error(<span class="hljs-string">'A helper called "'</span> + name + <span class="hljs-string">'" is already registered!'</span>);
    <span class="hljs-keyword">return</span>;
  }

  helpers[name] = callback;

};

<span class="hljs-comment">/*******************************
        Default helpers
********************************/</span>

helpers.debugger = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(params, hash, options, env)</span></span>{
  <span class="hljs-comment">/* jshint -W087 */</span>
  <span class="hljs-keyword">debugger</span>;
  <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>;
};

helpers.log = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(params, hash, options, env)</span></span>{
  <span class="hljs-built_in">console</span>.log.apply(<span class="hljs-built_in">console</span>, params);
  <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>;
};

helpers.on = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(params, hash, options, env)</span></span>{
  <span class="hljs-keyword">var</span> i, callback, delegate, element,
      eventName = params[<span class="hljs-number">0</span>],
      len = params.length;</pre></div></div>
            
        </li>
        
        
        <li id="section-142">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-142">&#182;</a>
              </div>
              <p>By default everything is delegated on the parent component</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>(len === <span class="hljs-number">2</span>){
    callback = params[<span class="hljs-number">1</span>];
    delegate = options.element;
    element = options.element;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-143">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-143">&#182;</a>
              </div>
              <p>If a selector is provided, delegate on the helper’s element</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(len === <span class="hljs-number">3</span>){
    callback = params[<span class="hljs-number">2</span>];
    delegate = params[<span class="hljs-number">1</span>];
    element = options.element;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-144">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-144">&#182;</a>
              </div>
              <p>Attach event</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  $(element).on(eventName, delegate, hash, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(event)</span></span>{
    <span class="hljs-keyword">return</span> env.helpers._callOnComponent(callback, event);
  });
};

helpers.length = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(params, hash, options, env)</span></span>{
    <span class="hljs-keyword">return</span> params[<span class="hljs-number">0</span>] &amp;&amp; params[<span class="hljs-number">0</span>].length || <span class="hljs-number">0</span>;
};

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isTruthy</span><span class="hljs-params">(condition)</span></span>{

  <span class="hljs-keyword">if</span>(condition === <span class="hljs-literal">true</span> || condition === <span class="hljs-literal">false</span>) <span class="hljs-keyword">return</span> condition;

  <span class="hljs-keyword">if</span>(condition === <span class="hljs-literal">undefined</span> || condition === <span class="hljs-literal">null</span>){
    condition = <span class="hljs-literal">false</span>;
  }

  condition.isModel &amp;&amp; (condition = <span class="hljs-literal">true</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-145">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-145">&#182;</a>
              </div>
              <p>If our condition is an array, handle properly</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>(_.isArray(condition) || condition.isCollection){
    condition = condition.length ? <span class="hljs-literal">true</span> : <span class="hljs-literal">false</span>;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-146">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-146">&#182;</a>
              </div>
              <p>Handle string values</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  (condition === <span class="hljs-string">'true'</span>) &amp;&amp; (condition = <span class="hljs-literal">true</span>);
  (condition === <span class="hljs-string">'false'</span>) &amp;&amp; (condition = <span class="hljs-literal">false</span>);

  <span class="hljs-keyword">return</span> condition;
}

helpers.if = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(params, hash, templates)</span></span>{

  <span class="hljs-keyword">var</span> condition = isTruthy(params[<span class="hljs-number">0</span>]);</pre></div></div>
            
        </li>
        
        
        <li id="section-147">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-147">&#182;</a>
              </div>
              <p>If yield does not exist, this is not a block helper.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>.yield){
    <span class="hljs-keyword">return</span> (condition) ? params[<span class="hljs-number">1</span>] : ( params[<span class="hljs-number">2</span>] || <span class="hljs-string">''</span>);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-148">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-148">&#182;</a>
              </div>
              <p>Render the apropreate block statement</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>(condition &amp;&amp; <span class="hljs-keyword">this</span>.yield){
    <span class="hljs-keyword">this</span>.yield();
  }
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(!condition &amp;&amp; templates.inverse &amp;&amp; templates.inverse.yield){
    templates.inverse.yield();
  }
  <span class="hljs-keyword">else</span>{
    <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>;
  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-149">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-149">&#182;</a>
              </div>
              <p>Unless proxies to the if helper with an inverted conditional value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>helpers.unless = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(params, hash, templates)</span></span>{
  params[<span class="hljs-number">0</span>] = !isTruthy(params[<span class="hljs-number">0</span>]);
  <span class="hljs-keyword">return</span> helpers.if.apply((templates.template || {}), [params, hash, templates]);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-150">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-150">&#182;</a>
              </div>
              <p>Given an array, predicate and optional extra variable, finds the index in the array where predicate is true</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">findIndex</span><span class="hljs-params">(arr, predicate, cid)</span> </span>{
  <span class="hljs-keyword">if</span> (arr === <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">TypeError</span>(<span class="hljs-string">'findIndex called on null or undefined'</span>);
  }
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> predicate !== <span class="hljs-string">'function'</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">TypeError</span>(<span class="hljs-string">'predicate must be a function'</span>);
  }
  <span class="hljs-keyword">var</span> list = <span class="hljs-built_in">Object</span>(arr);
  <span class="hljs-keyword">var</span> length = list.length &gt;&gt;&gt; <span class="hljs-number">0</span>;
  <span class="hljs-keyword">var</span> thisArg = <span class="hljs-built_in">arguments</span>[<span class="hljs-number">1</span>];
  <span class="hljs-keyword">var</span> value;

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; length; i++) {
    value = list[i];
    <span class="hljs-keyword">if</span> (predicate.call(thisArg, value, i, list, cid)) {
      <span class="hljs-keyword">return</span> i;
    }
  }
  <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
}

helpers.each = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(params, hash, templates)</span></span>{

  <span class="hljs-keyword">if</span>(_.isNull(params[<span class="hljs-number">0</span>]) || _.isUndefined(params[<span class="hljs-number">0</span>])){ <span class="hljs-built_in">console</span>.warn(<span class="hljs-string">'Undefined value passed to each helper! Maybe try providing a default value?'</span>, params, hash); <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>; }

  <span class="hljs-keyword">var</span> key, value = (params[<span class="hljs-number">0</span>].isCollection) ? params[<span class="hljs-number">0</span>].models : params[<span class="hljs-number">0</span>]; <span class="hljs-comment">// Accepts collections or arrays</span>

  <span class="hljs-keyword">if</span>((!_.isArray(value) || value.length === <span class="hljs-number">0</span>)){
    <span class="hljs-keyword">if</span>(templates.inverse &amp;&amp; templates.inverse.yield)
      templates.inverse.yield();
  }
  <span class="hljs-keyword">else</span>{
    <span class="hljs-keyword">for</span> (key <span class="hljs-keyword">in</span> value) {
      <span class="hljs-keyword">if</span>(value.hasOwnProperty(key))
        <span class="hljs-keyword">this</span>.yieldItem(value[key].cid, [ value[key] ], value);
    }
  }
  <span class="hljs-keyword">return</span> _.uniqueId(<span class="hljs-string">'rand'</span>);
};

helpers.partial = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(params, hash, options, env)</span></span>{
  <span class="hljs-keyword">var</span> partial = partials[params[<span class="hljs-number">0</span>]];
  <span class="hljs-keyword">if</span>( partial &amp;&amp; partial.isHTMLBars ){
    <span class="hljs-keyword">return</span> partial.render(options.context, env);
  }
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> helpers;
<span class="hljs-keyword">export</span> { partials };</pre></div></div>
            
        </li>
        
        
        <li id="section-151">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-151">&#182;</a>
              </div>
              <h2 id="rebound-hooks">Rebound Hooks</h2>

            </div>
            
        </li>
        
        
        <li id="section-152">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-152">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>
import LazyValue from "rebound-component/lazy-value";
import $ from "rebound-component/utils";
import helpers, { partials } from "rebound-component/helpers";
import hooks, { wrapForHelper } from "htmlbars-runtime/hooks";
import DOMHelper from "dom-helper";
import { createObject } from "../htmlbars-util/object-utils";
import render from "htmlbars-runtime/render";



var attributes = {  abbr: 1,      "accept-charset": 1,   accept: 1,      accesskey: 1,     action: 1,
                    align: 1,      alink: 1,             alt: 1,         archive: 1,       axis: 1,
                    background: 1, bgcolor: 1,           border: 1,      cellpadding: 1,   cellspacing: 1,
                    char: 1,       charoff: 1,           charset: 1,     checked: 1,       cite: 1,
                    class: 1,      classid: 1,           clear: 1,       code: 1,          codebase: 1,
                    codetype: 1,   color: 1,             cols: 1,        colspan: 1,       compact: 1,
                    content: 1,    coords: 1,            data: 1,        datetime: 1,      declare: 1,
                    defer: 1,      dir: 1,               disabled: 1,    enctype: 1,       face: 1,
                    for: 1,        frame: 1,             frameborder: 1, headers: 1,       height: 1,
                    href: 1,       hreflang: 1,          hspace: 1,     "http-equiv": 1,   id: 1,
                    ismap: 1,      label: 1,             lang: 1,        language: 1,      link: 1,
                    longdesc: 1,   marginheight: 1,      marginwidth: 1, maxlength: 1,     media: 1,
                    method: 1,     multiple: 1,          name: 1,        nohref: 1,        noresize: 1,
                    noshade: 1,    nowrap: 1,            object: 1,      onblur: 1,        onchange: 1,
                    onclick: 1,    ondblclick: 1,        onfocus: 1,     onkeydown: 1,     onkeypress: 1,
                    onkeyup: 1,    onload: 1,            onmousedown: 1, onmousemove: 1,   onmouseout: 1,
                    onmouseover: 1,onmouseup: 1,         onreset: 1,     onselect: 1,      onsubmit: 1,
                    onunload: 1,   profile: 1,           prompt: 1,      readonly: 1,      rel: 1,
                    rev: 1,        rows: 1,              rowspan: 1,     rules: 1,         scheme: 1,
                    scope: 1,      scrolling: 1,         selected: 1,    shape: 1,         size: 1,
                    span: 1,       src: 1,               standby: 1,     start: 1,         style: 1,
                    summary: 1,    tabindex: 1,          target: 1,      text: 1,          title: 1,
                    type: 1,       usemap: 1,            valign: 1,      value: 1,         valuetype: 1,
                    version: 1,    vlink: 1,             vspace: 1,      width: 1  };


/*******************************
        Hook Utils
********************************/

hooks.get = function get(env, scope, path){

    if(path === 'this') path = '';

    var setPath = path;

    var key, value,
        rest = $.splitPath(path);
    key = rest.shift();</pre></div></div>
            
        </li>
        
        
        <li id="section-153">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-153">&#182;</a>
              </div>
              <p>If this path referances a block param, use that as the context instead.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(scope.localPresent[key]){
      value = scope.locals[key];
      path = rest.join(<span class="hljs-string">'.'</span>);
    }
    <span class="hljs-keyword">else</span>{
      value = scope.self;
    }

    <span class="hljs-keyword">if</span>(scope.streams[setPath]) <span class="hljs-keyword">return</span> scope.streams[setPath];
    <span class="hljs-keyword">return</span> (scope.streams[setPath] = streamProperty(value, path));
};</pre></div></div>
            
        </li>
        
        
        <li id="section-154">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-154">&#182;</a>
              </div>
              <p>Given an object (context) and a path, create a LazyValue object that returns the value of object at context and add it as an observer of the context.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">streamProperty</span><span class="hljs-params">(context, path)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-155">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-155">&#182;</a>
              </div>
              <p>Lazy value that returns the value of context.path</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> lazyValue = <span class="hljs-keyword">new</span> LazyValue(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> context.get(path);
  }, {context: context});</pre></div></div>
            
        </li>
        
        
        <li id="section-156">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-156">&#182;</a>
              </div>
              <p>Save our path so parent lazyvalues can know the data var or helper they are getting info from</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  lazyValue.path = path;</pre></div></div>
            
        </li>
        
        
        <li id="section-157">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-157">&#182;</a>
              </div>
              <p>Save the observer at this path</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  lazyValue.addObserver(path, context);

  <span class="hljs-keyword">return</span> lazyValue;
}


hooks.invokeHelper = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">invokeHelper</span><span class="hljs-params">(morph, env, scope, visitor, params, hash, helper, templates, context)</span></span>{
  <span class="hljs-keyword">if</span>(morph &amp;&amp; scope.streams[morph.guid]){
    scope.streams[morph.guid].value;
    <span class="hljs-keyword">return</span> scope.streams[morph.guid];
  }
  <span class="hljs-keyword">var</span> lazyValue = streamHelper.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);
  lazyValue.path = helper.name;
  lazyValue.value;</pre></div></div>
            
        </li>
        
        
        <li id="section-158">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-158">&#182;</a>
              </div>
              <p>if(morph) scope.streams[morph.guid] = lazyValue;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">return</span> lazyValue;
};

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">streamHelper</span><span class="hljs-params">(morph, env, scope, visitor, params, hash, helper, templates, context)</span></span>{

  <span class="hljs-keyword">if</span>(!_.isFunction(helper)) <span class="hljs-keyword">return</span> <span class="hljs-built_in">console</span>.error(scope + <span class="hljs-string">' is not a valid helper!'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-159">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-159">&#182;</a>
              </div>
              <p>Create a lazy value that returns the value of our evaluated helper.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> lazyValue = <span class="hljs-keyword">new</span> LazyValue(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
    <span class="hljs-keyword">var</span> plainParams = [],
        plainHash = {};</pre></div></div>
            
        </li>
        
        
        <li id="section-160">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-160">&#182;</a>
              </div>
              <p>Assemble our args and hash variables. For each lazyvalue param, push the lazyValue’s value so helpers with no concept of lazyvalues.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    _.each(params, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(param, index)</span></span>{
      plainParams.push(( (param &amp;&amp; param.isLazyValue) ? param.value : param ));
    });
    _.each(hash, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(hash, key)</span></span>{
      plainHash[key] = (hash &amp;&amp; hash.isLazyValue) ? hash.value : hash;
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-161">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-161">&#182;</a>
              </div>
              <p>Call our helper functions with our assembled args.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">return</span> helper.call((context || {}), plainParams, plainHash, templates, env);

  }, {morph: morph, path: helper.name});</pre></div></div>
            
        </li>
        
        
        <li id="section-162">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-162">&#182;</a>
              </div>
              <p>For each param or hash value passed to our helper, add it to our helper’s dependant list. Helper will re-evaluate when one changes.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  params.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(param)</span> </span>{
    <span class="hljs-keyword">if</span> (param &amp;&amp; param.isLazyValue){
      lazyValue.addDependentValue(param);
    }
  });
  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> key <span class="hljs-keyword">in</span> hash){
    <span class="hljs-keyword">if</span> (hash[key] &amp;&amp; hash[key].isLazyValue){
      lazyValue.addDependentValue(hash[key]);
    }
  }

  <span class="hljs-keyword">return</span> lazyValue;
}

hooks.cleanupRenderNode = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
};

hooks.destroyRenderNode = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(renderNode)</span></span>{

};
hooks.willCleanupTree = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(renderNode)</span></span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-163">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-163">&#182;</a>
              </div>
              <p>for(let i in renderNode.lazyValues)
  if(renderNode.lazyValues[i].isLazyValue)
    renderNode.lazyValues[i].destroy();</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>};


<span class="hljs-comment">/*******************************
        Default Hooks
********************************/</span></pre></div></div>
            
        </li>
        
        
        <li id="section-164">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-164">&#182;</a>
              </div>
              <p>Helper Hooks</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
hooks.hasHelper = helpers.hasHelper;

hooks.lookupHelper = helpers.lookupHelper;</pre></div></div>
            
        </li>
        
        
        <li id="section-165">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-165">&#182;</a>
              </div>
              <p>Rebound’s default environment
The application environment is propagated down each render call and
augmented with helpers as it goes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>hooks.createFreshEnv = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
  <span class="hljs-keyword">return</span> {
    helpers: helpers,
    hooks: hooks,
    streams: {},
    dom: <span class="hljs-keyword">new</span> DOMHelper.default(),
    useFragmentCache: <span class="hljs-literal">true</span>,
    revalidateQueue: {},
    isReboundEnv: <span class="hljs-literal">true</span>
  };
};

hooks.createChildEnv = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(parent)</span></span>{
  <span class="hljs-keyword">var</span> env = createObject(parent);
  env.helpers = createObject(parent.helpers);
  <span class="hljs-keyword">return</span> env;
};

hooks.createFreshScope = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-166">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-166">&#182;</a>
              </div>
              <p>because <code>in</code> checks have unpredictable performance, keep a
separate dictionary to track whether a local was bound.
See <code>bindLocal</code> for more information.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">return</span> { self: <span class="hljs-literal">null</span>, blocks: {}, locals: {}, localPresent: {}, streams: {} };
};

hooks.createChildScope = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(parent)</span> </span>{
  <span class="hljs-keyword">var</span> scope = createObject(parent);
  scope.locals = createObject(parent.locals);
  scope.streams = createObject(parent.streams);
  <span class="hljs-keyword">return</span> scope;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-167">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-167">&#182;</a>
              </div>
              <p>Scope Hooks</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>hooks.bindScope = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">bindScope</span><span class="hljs-params">(env, scope)</span></span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-168">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-168">&#182;</a>
              </div>
              <p>Initial setup of scope</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  env.scope = scope;
};

hooks.wrap = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">wrap</span><span class="hljs-params">(template)</span></span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-169">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-169">&#182;</a>
              </div>
              <p>Return a wrapper function that will merge user provided helpers and hooks with our defaults</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  return {
    reboundTemplate: true,
    meta: template.meta,
    arity: template.arity,
    raw: template,
    render: function(data, env=hooks.createFreshEnv(), options={}, blockArguments){</pre></div></div>
            
        </li>
        
        
        <li id="section-170">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-170">&#182;</a>
              </div>
              <p>Create a fresh scope if it doesn’t exist</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> scope = hooks.createFreshScope();

      env = hooks.createChildEnv(env);
      _.extend(env.helpers, options.helpers);</pre></div></div>
            
        </li>
        
        
        <li id="section-171">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-171">&#182;</a>
              </div>
              <p>Ensure we have a contextual element to pass to render</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      options.contextualElement || (options.contextualElement = <span class="hljs-built_in">document</span>.body);
      options.self = data;
      options.blockArguments = blockArguments;</pre></div></div>
            
        </li>
        
        
        <li id="section-172">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-172">&#182;</a>
              </div>
              <p>Call our func with merged helpers and hooks</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      env.template = render.default(template, env, scope, options);
      env.template.uid = _.uniqueId(<span class="hljs-string">'template'</span>);
      <span class="hljs-keyword">return</span> env.template;
    }
  };
};

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">rerender</span><span class="hljs-params">(path, node, lazyValue, env)</span></span>{
  lazyValue.onNotify(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
    node.isDirty = <span class="hljs-literal">true</span>;
    env.revalidateQueue[env.template.uid] = env.template;
  });
}

hooks.linkRenderNode = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">linkRenderNode</span><span class="hljs-params">(renderNode, env, scope, path, params, hash)</span></span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-173">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-173">&#182;</a>
              </div>
              <p>If this node has already been rendered, it is already linked to its streams</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>(renderNode.rendered) <span class="hljs-keyword">return</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-174">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-174">&#182;</a>
              </div>
              <p>Save the path on our render node for easier debugging</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  renderNode.path = path;
  renderNode.lazyValues || (renderNode.lazyValues = {});

  <span class="hljs-keyword">if</span> (params &amp;&amp; params.length) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; params.length; i++) {
      <span class="hljs-keyword">if</span>(params[i].isLazyValue){
        rerender(path, renderNode, params[i], env);
      }
    }
  }
  <span class="hljs-keyword">if</span> (hash) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> key <span class="hljs-keyword">in</span> hash) {
      <span class="hljs-keyword">if</span>(hash.hasOwnProperty(key) &amp;&amp; hash[key].isLazyValue){
        rerender(path, renderNode, hash[key], env);
      }
    }
  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-175">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-175">&#182;</a>
              </div>
              <p>Hooks</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
hooks.getValue = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(referance)</span></span>{
  <span class="hljs-keyword">return</span> (referance &amp;&amp; referance.isLazyValue) ? referance.value : referance;
};

hooks.subexpr = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">subexpr</span><span class="hljs-params">(env, scope, helperName, params, hash)</span> </span>{
  <span class="hljs-keyword">var</span> helper = helpers.lookupHelper(helperName, env),
      lazyValue, i, l,
      name = <span class="hljs-string">`subexpr <span class="hljs-subst">${helperName}</span>: `</span>;
  <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, l = params.length; i &lt; l; i++) {
    <span class="hljs-keyword">if</span>(params[i].isLazyValue) name += params[i].cid;
  }

  <span class="hljs-keyword">if</span>(env.streams[name]) <span class="hljs-keyword">return</span> env.streams[name];

  <span class="hljs-keyword">if</span> (helper) {
    lazyValue = streamHelper(<span class="hljs-literal">null</span>, env, scope, <span class="hljs-literal">null</span>, params, hash, helper, {}, <span class="hljs-literal">null</span>);
  } <span class="hljs-keyword">else</span> {
    lazyValue = hooks.get(env, context, helperName);
  }

  <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, l = params.length; i &lt; l; i++) {
    <span class="hljs-keyword">if</span>(params[i].isLazyValue) {
      lazyValue.addDependentValue(params[i]);
    }
  }

  lazyValue.path = helperName;
  env.streams[name] = lazyValue;
  <span class="hljs-keyword">return</span> lazyValue;
};

hooks.concat = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">concat</span><span class="hljs-params">(env, params)</span></span>{

  <span class="hljs-keyword">var</span> name = <span class="hljs-string">"concat: "</span>, i, l;

  <span class="hljs-keyword">if</span>(params.length === <span class="hljs-number">1</span>){
    <span class="hljs-keyword">return</span> params[<span class="hljs-number">0</span>];
  }

  <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, l = params.length; i &lt; l; i++) {
    name += (params[i] &amp;&amp; params[i].isLazyValue) ? params[i].cid : params[i];
  }

  <span class="hljs-keyword">if</span>(env.streams[name]) <span class="hljs-keyword">return</span> env.streams[name];

  <span class="hljs-keyword">var</span> lazyValue = <span class="hljs-keyword">new</span> LazyValue(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(params)</span> </span>{
    <span class="hljs-keyword">var</span> value = <span class="hljs-string">""</span>;

    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, l = params.length; i &lt; l; i++) {
      value += (params[i] &amp;&amp; params[i].isLazyValue) ? params[i].value : (params[i] || <span class="hljs-string">''</span>);
    }

    <span class="hljs-keyword">return</span> value;
  }, {context: params[<span class="hljs-number">0</span>].context});

  <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, l = params.length; i &lt; l; i++) {
    lazyValue.addDependentValue(params[i]);
  }

  env.scope.streams[name] = lazyValue;
  lazyValue.path = name;
  <span class="hljs-keyword">return</span> lazyValue;

};</pre></div></div>
            
        </li>
        
        
        <li id="section-176">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-176">&#182;</a>
              </div>
              <p>Content Hook</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>hooks.content = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">content</span><span class="hljs-params">(morph, env, context, path, lazyValue)</span></span>{
  <span class="hljs-keyword">var</span> value,
      observer = subtreeObserver,
      domElement = morph.contextualElement,
      helper = helpers.lookupHelper(path, env);

  <span class="hljs-keyword">var</span> updateTextarea = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(lazyValue)</span></span>{
    domElement.value = lazyValue.value;
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-177">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-177">&#182;</a>
              </div>
              <p>Two way databinding for textareas</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>(domElement.tagName === <span class="hljs-string">'TEXTAREA'</span>){
    lazyValue.onNotify(updateTextarea);
    $(domElement).on(<span class="hljs-string">'change keyup'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(event)</span></span>{
      lazyValue.set(lazyValue.path, <span class="hljs-keyword">this</span>.value);
    });
  }

  <span class="hljs-keyword">return</span> lazyValue.value;

};

hooks.attribute = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">attribute</span><span class="hljs-params">(attrMorph, env, scope, name, value)</span></span>{
  <span class="hljs-keyword">var</span> val = value.isLazyValue ? value.value : value,
      domElement = attrMorph.element,
      checkboxChange,
      type = domElement.getAttribute(<span class="hljs-string">"type"</span>),
      attr,
      inputTypes = {  <span class="hljs-string">'null'</span>: <span class="hljs-literal">true</span>,  <span class="hljs-string">'text'</span>:<span class="hljs-literal">true</span>,   <span class="hljs-string">'email'</span>:<span class="hljs-literal">true</span>,  <span class="hljs-string">'password'</span>:<span class="hljs-literal">true</span>,
                      <span class="hljs-string">'search'</span>:<span class="hljs-literal">true</span>, <span class="hljs-string">'url'</span>:<span class="hljs-literal">true</span>,    <span class="hljs-string">'tel'</span>:<span class="hljs-literal">true</span>,    <span class="hljs-string">'hidden'</span>:<span class="hljs-literal">true</span>,
                      <span class="hljs-string">'number'</span>:<span class="hljs-literal">true</span>, <span class="hljs-string">'color'</span>: <span class="hljs-literal">true</span>, <span class="hljs-string">'date'</span>: <span class="hljs-literal">true</span>,  <span class="hljs-string">'datetime'</span>: <span class="hljs-literal">true</span>,
                      <span class="hljs-string">'datetime-local:'</span>: <span class="hljs-literal">true</span>,      <span class="hljs-string">'month'</span>: <span class="hljs-literal">true</span>, <span class="hljs-string">'range'</span>: <span class="hljs-literal">true</span>,
                      <span class="hljs-string">'time'</span>: <span class="hljs-literal">true</span>,  <span class="hljs-string">'week'</span>: <span class="hljs-literal">true</span>
                    };</pre></div></div>
            
        </li>
        
        
        <li id="section-178">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-178">&#182;</a>
              </div>
              <p>If is a text input element’s value prop with only one variable, wire default events</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>( domElement.tagName === <span class="hljs-string">'INPUT'</span> &amp;&amp; inputTypes[type] &amp;&amp; name === <span class="hljs-string">'value'</span> ){</pre></div></div>
            
        </li>
        
        
        <li id="section-179">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-179">&#182;</a>
              </div>
              <p>If our special input events have not been bound yet, bind them and set flag</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(!attrMorph.inputObserver){

      $(domElement).on(<span class="hljs-string">'change input propertychange'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(event)</span></span>{
        value.set(value.path, <span class="hljs-keyword">this</span>.value);
      });

      attrMorph.inputObserver = <span class="hljs-literal">true</span>;

    }</pre></div></div>
            
        </li>
        
        
        <li id="section-180">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-180">&#182;</a>
              </div>
              <p>Set the attribute on our element for visual referance</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    (_.isUndefined(val)) ? domElement.removeAttribute(name) : domElement.setAttribute(name, val);

    attr = val;
    <span class="hljs-keyword">return</span> (domElement.value !== <span class="hljs-built_in">String</span>(attr)) ? domElement.value = (attr || <span class="hljs-string">''</span>) : attr;
  }

  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>( domElement.tagName === <span class="hljs-string">'INPUT'</span> &amp;&amp; (type === <span class="hljs-string">'checkbox'</span> || type === <span class="hljs-string">'radio'</span>) &amp;&amp; name === <span class="hljs-string">'checked'</span> ){</pre></div></div>
            
        </li>
        
        
        <li id="section-181">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-181">&#182;</a>
              </div>
              <p>If our special input events have not been bound yet, bind them and set flag</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(!attrMorph.eventsBound){

      $(domElement).on(<span class="hljs-string">'change propertychange'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(event)</span></span>{
        value.set(value.path, ((<span class="hljs-keyword">this</span>.checked) ? <span class="hljs-literal">true</span> : <span class="hljs-literal">false</span>), {quiet: <span class="hljs-literal">true</span>});
      });

      attrMorph.eventsBound = <span class="hljs-literal">true</span>;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-182">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-182">&#182;</a>
              </div>
              <p>Set the attribute on our element for visual referance</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    (!val) ? domElement.removeAttribute(name) : domElement.setAttribute(name, val);

    <span class="hljs-keyword">return</span> domElement.checked = (val) ? <span class="hljs-literal">true</span> : <span class="hljs-literal">undefined</span>;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-183">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-183">&#182;</a>
              </div>
              <p>Special case for link elements with dynamic classes.
If the router has assigned it a truthy ‘active’ property, ensure that the extra class is present on re-render.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>( domElement.tagName === <span class="hljs-string">'A'</span> &amp;&amp; name === <span class="hljs-string">'class'</span> ){
    <span class="hljs-keyword">if</span>(_.isUndefined(val)){
      domElement.active ? domElement.setAttribute(<span class="hljs-string">'class'</span>, <span class="hljs-string">'active'</span>) : domElement.classList.remove(<span class="hljs-string">'class'</span>);
    }
    <span class="hljs-keyword">else</span>{
      domElement.setAttribute(name, val + (domElement.active ? <span class="hljs-string">' active'</span> : <span class="hljs-string">''</span>));
    }
  }

  <span class="hljs-keyword">else</span> {
    _.isString(val) &amp;&amp; (val = val.trim());
    val || (val = <span class="hljs-literal">undefined</span>);
    <span class="hljs-keyword">if</span>(_.isUndefined(val)){
      domElement.removeAttribute(name);
    }
    <span class="hljs-keyword">else</span>{
      domElement.setAttribute(name, val);
    }
  }

  hooks.linkRenderNode(attrMorph, env, scope, <span class="hljs-string">'@attribute'</span>, [value], {});

};

hooks.partial = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">partial</span><span class="hljs-params">(renderNode, env, scope, path)</span></span>{
  <span class="hljs-keyword">let</span> part = partials[path];
  <span class="hljs-keyword">if</span>( part &amp;&amp; part.render ){
    env = <span class="hljs-built_in">Object</span>.create(env);
    env.template = part.render(scope.self, env, {contextualElement: renderNode.contextualElement}, scope.block);
    <span class="hljs-keyword">return</span> env.template.fragment;
  }
};

hooks.component = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(morph, env, scope, tagName, params, attrs, templates, visitor)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-184">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-184">&#182;</a>
              </div>
              <p>Components are only ever rendered once</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (morph.componentIsRendered) <span class="hljs-keyword">return</span>;

  <span class="hljs-keyword">if</span> (env.hooks.hasHelper(env, scope, tagName)) {
    <span class="hljs-keyword">return</span> env.hooks.block(morph, env, scope, tagName, params, attrs, templates.default, templates.inverse, visitor);
  }

  <span class="hljs-keyword">var</span> component, element, outlet,
      seedData = {},
      componentData = {};</pre></div></div>
            
        </li>
        
        
        <li id="section-185">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-185">&#182;</a>
              </div>
              <p>Create a plain data object to pass to our new component as seed data</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> key <span class="hljs-keyword">in</span> attrs){
    seedData[key] = hooks.getValue(attrs[key]);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-186">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-186">&#182;</a>
              </div>
              <p>For each param passed to our shared component, add it to our custom element
TODO: there has to be a better way to get seed data to element instances
Global seed data is consumed by element as its created. This is not scoped and very dumb.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  Rebound.seedData = seedData;
  element = <span class="hljs-built_in">document</span>.createElement(tagName);
  component = element.data;
  <span class="hljs-keyword">delete</span> Rebound.seedData;</pre></div></div>
            
        </li>
        
        
        <li id="section-187">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-187">&#182;</a>
              </div>
              <p>For each lazy param passed to our component, create its lazyValue</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> key <span class="hljs-keyword">in</span> seedData){
    componentData[key] = streamProperty(component, key);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-188">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-188">&#182;</a>
              </div>
              <p>Set up two way binding between component and original context for non-data attributes
Syncing between models and collections passed are handled in model and collection</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> prop <span class="hljs-keyword">in</span> componentData){
    <span class="hljs-keyword">let</span> key = prop;
    <span class="hljs-keyword">if</span>(componentData[key].isLazyValue &amp;&amp; attrs[key].isLazyValue){</pre></div></div>
            
        </li>
        
        
        <li id="section-189">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-189">&#182;</a>
              </div>
              <p>For each lazy param passed to our component, have it update the original context when changed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      componentData[key].onNotify(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
        attrs[key].set(attrs[key].path, componentData[key].value);
      });</pre></div></div>
            
        </li>
        
        
        <li id="section-190">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-190">&#182;</a>
              </div>
              <p>For each lazy param passed to our component, have it update the component when changed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      attrs[key].onNotify(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
        componentData[key].set(key, attrs[key].value);
      });</pre></div></div>
            
        </li>
        
        
        <li id="section-191">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-191">&#182;</a>
              </div>
              <p>Seed the cache</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      componentData[key].value;

    }
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-192">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-192">&#182;</a>
              </div>
              <p>TODO: Move this to Component
// For each change on our component, update the states of the original context and the element’s proeprties.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  component.listenTo(component, <span class="hljs-string">'change'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(model)</span></span>{
    <span class="hljs-keyword">var</span> json = component.toJSON();

    <span class="hljs-keyword">if</span>(_.isString(json)) <span class="hljs-keyword">return</span>; <span class="hljs-comment">// If is a string, this model is seralizing already</span></pre></div></div>
            
        </li>
        
        
        <li id="section-193">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-193">&#182;</a>
              </div>
              <p>Set the properties on our element for visual referance if we are on a top level attribute</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    _.each(json, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value, key)</span></span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-194">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-194">&#182;</a>
              </div>
              <p>TODO: Currently, showing objects as properties on the custom element causes problems.
Linked models between the context and component become the same exact model and all hell breaks loose.
Find a way to remedy this. Until then, don’t show objects.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span>((_.isObject(value))){ <span class="hljs-keyword">return</span>; }
      value = (_.isObject(value)) ? <span class="hljs-built_in">JSON</span>.stringify(value) : value;
        <span class="hljs-keyword">try</span>{ (attributes[key]) ? element.setAttribute(key, value) : element.dataset[key] = value; }
        <span class="hljs-keyword">catch</span>(e){
          <span class="hljs-built_in">console</span>.error(e.message);
        }
    });
  });

  <span class="hljs-comment">/** The attributeChangedCallback on our custom element updates the component's data. **/</span>


<span class="hljs-comment">/*******************************************************

  End data dependancy chain

*******************************************************/</span></pre></div></div>
            
        </li>
        
        
        <li id="section-195">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-195">&#182;</a>
              </div>
              <p>TODO: break this out into its own function
Set the properties on our element for visual referance if we are on a top level attribute</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> compjson = component.toJSON();
  _.each(compjson, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value, key)</span></span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-196">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-196">&#182;</a>
              </div>
              <p>TODO: Currently, showing objects as properties on the custom element causes problems.
Linked models between the context and component become the same exact model and all hell breaks loose.
Find a way to remedy this. Until then, don’t show objects.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>((_.isObject(value))){ <span class="hljs-keyword">return</span>; }
    value = (_.isObject(value)) ? <span class="hljs-built_in">JSON</span>.stringify(value) : value;
    <span class="hljs-keyword">if</span>(!_.isNull(value) &amp;&amp; !_.isUndefined(value)){
      <span class="hljs-keyword">try</span>{ (attributes[key]) ? element.setAttribute(key, value) : element.dataset[key] = value; }
      <span class="hljs-keyword">catch</span>(e){
        <span class="hljs-built_in">console</span>.error(e.message);
      }
    }
  });</pre></div></div>
            
        </li>
        
        
        <li id="section-197">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-197">&#182;</a>
              </div>
              <p>Walk the dom, without traversing into other custom elements, and search for
<code>&lt;content&gt;</code> outlets to render templates into.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  $(element).walkTheDOM(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(el)</span></span>{
    <span class="hljs-keyword">if</span>(element === el) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">if</span>(el.tagName === <span class="hljs-string">'CONTENT'</span>) outlet = el;
    <span class="hljs-keyword">if</span>(el.tagName.indexOf(<span class="hljs-string">'-'</span>) &gt; -<span class="hljs-number">1</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  });</pre></div></div>
            
        </li>
        
        
        <li id="section-198">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-198">&#182;</a>
              </div>
              <p>If a <code>&lt;content&gt;</code> outlet is present in component’s template, and a template
is provided, render it into the outlet</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>(templates.default &amp;&amp; _.isElement(outlet)){
    outlet.innerHTML = <span class="hljs-string">''</span>;
    outlet.appendChild(render.default(templates.default, env, scope, {}).fragment);
  }

  morph.setNode(element);
  morph.componentIsRendered = <span class="hljs-literal">true</span>;

};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> hooks;</pre></div></div>
            
        </li>
        
        
        <li id="section-199">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-199">&#182;</a>
              </div>
              <h2 id="rebound-lazy-value">Rebound Lazy Value</h2>

            </div>
            
        </li>
        
        
        <li id="section-200">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-200">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">var</span> NIL = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">NIL</span><span class="hljs-params">()</span></span>{},
    EMPTY_ARRAY = [];

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">LazyValue</span><span class="hljs-params">(fn, options)</span> </span>{
  options || (options = {});
  <span class="hljs-keyword">this</span>.cid = _.uniqueId(<span class="hljs-string">'lazyValue'</span>);
  <span class="hljs-keyword">this</span>.valueFn = fn;
  <span class="hljs-keyword">this</span>.context = options.context || <span class="hljs-literal">null</span>;
}

LazyValue.prototype = {
  isLazyValue: <span class="hljs-literal">true</span>,
  children: <span class="hljs-literal">null</span>,
  observers: <span class="hljs-literal">null</span>,
  cache: NIL,
  valueFn: <span class="hljs-literal">null</span>,
  subscribers: <span class="hljs-literal">null</span>, <span class="hljs-comment">// TODO: do we need multiple subscribers?</span>
  _childValues: <span class="hljs-literal">null</span>, <span class="hljs-comment">// just for reusing the array, might not work well if children.length changes after computation</span>

  get value(){
    <span class="hljs-keyword">var</span> cache = <span class="hljs-keyword">this</span>.cache;
    <span class="hljs-keyword">if</span> (cache !== NIL) { <span class="hljs-keyword">return</span> cache; }

    <span class="hljs-keyword">var</span> children = <span class="hljs-keyword">this</span>.children;
    <span class="hljs-keyword">if</span> (children) {
      <span class="hljs-keyword">var</span> child,
          values = <span class="hljs-keyword">this</span>._childValues || <span class="hljs-keyword">new</span> <span class="hljs-built_in">Array</span>(children.length);

      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, l = children.length; i &lt; l; i++) {
        child = children[i];
        values[i] = (child &amp;&amp; child.isLazyValue) ? child.value : child;
      }
      <span class="hljs-keyword">this</span>.cache = <span class="hljs-keyword">this</span>.valueFn(values);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">this</span>.cache = <span class="hljs-keyword">this</span>.valueFn(EMPTY_ARRAY);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.cache;
  },

  set: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key, value, options)</span></span>{
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.context){
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.context.set(key, value, options);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  },

  addDependentValue: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value)</span> </span>{
    <span class="hljs-keyword">var</span> children = <span class="hljs-keyword">this</span>.children;
    <span class="hljs-keyword">if</span> (!children) {
      children = <span class="hljs-keyword">this</span>.children = [value];
    } <span class="hljs-keyword">else</span> {
      children.push(value);
    }

    <span class="hljs-keyword">if</span> (value &amp;&amp; value.isLazyValue) {
      value.onNotify(<span class="hljs-keyword">this</span>);
    }

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  },

  addObserver: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(path, context)</span> </span>{
    <span class="hljs-keyword">var</span> observers = <span class="hljs-keyword">this</span>.observers || (<span class="hljs-keyword">this</span>.observers = []),
        position, res;

    <span class="hljs-keyword">if</span>(!_.isObject(context) || !_.isString(path)) <span class="hljs-keyword">return</span> <span class="hljs-built_in">console</span>.error(<span class="hljs-string">'Error adding observer for'</span>, context, path);</pre></div></div>
            
        </li>
        
        
        <li id="section-201">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-201">&#182;</a>
              </div>
              <p>Ensure _observers exists and is an object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    context.__observers = context.__observers || {};</pre></div></div>
            
        </li>
        
        
        <li id="section-202">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-202">&#182;</a>
              </div>
              <p>Ensure __observers[path] exists and is an array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    context.__observers[path] = context.__observers[path] || {collection: [], model: []};</pre></div></div>
            
        </li>
        
        
        <li id="section-203">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-203">&#182;</a>
              </div>
              <p>Save the type of object events this observer is for</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    res = context.get(<span class="hljs-keyword">this</span>.path);
    res = (res &amp;&amp; res.isCollection) ? <span class="hljs-string">'collection'</span> : <span class="hljs-string">'model'</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-204">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-204">&#182;</a>
              </div>
              <p>Add our callback, save the position it is being inserted so we can garbage collect later.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    position = context.__observers[path][res].push(<span class="hljs-keyword">this</span>) - <span class="hljs-number">1</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-205">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-205">&#182;</a>
              </div>
              <p>Lazyvalue needs referance to its observers to remove listeners on destroy</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    observers.push({context: context, path: path, index: position});

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  },

  notify: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(sender)</span> </span>{
    <span class="hljs-keyword">var</span> cache = <span class="hljs-keyword">this</span>.cache,
        subscribers;

    <span class="hljs-keyword">if</span> (cache !== NIL) {
      subscribers = <span class="hljs-keyword">this</span>.subscribers;
      cache = <span class="hljs-keyword">this</span>.cache = NIL;
      <span class="hljs-keyword">if</span> (!subscribers) { <span class="hljs-keyword">return</span>; }
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, l = subscribers.length; i &lt; l; i++) {
        (subscribers[i].isLazyValue) ? subscribers[i].notify() : subscribers[i](<span class="hljs-keyword">this</span>);
      }
    }
  },

  onNotify: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(callback)</span> </span>{
    <span class="hljs-keyword">var</span> subscribers = <span class="hljs-keyword">this</span>.subscribers || (<span class="hljs-keyword">this</span>.subscribers = []);
    subscribers.push(callback);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  },

  destroy: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    _.each(<span class="hljs-keyword">this</span>.children, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(child)</span></span>{
      <span class="hljs-keyword">if</span> (child &amp;&amp; child.isLazyValue){ child.destroy(); }
    });
    _.each(<span class="hljs-keyword">this</span>.subscribers, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(subscriber)</span></span>{
      <span class="hljs-keyword">if</span> (subscriber &amp;&amp; subscriber.isLazyValue){ subscriber.destroy(); }
    });

    <span class="hljs-keyword">this</span>.children = <span class="hljs-keyword">this</span>.cache = <span class="hljs-keyword">this</span>.valueFn = <span class="hljs-keyword">this</span>.subscribers = <span class="hljs-keyword">this</span>._childValues = <span class="hljs-literal">null</span>;

    _.each(<span class="hljs-keyword">this</span>.observers, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(observer)</span></span>{
      <span class="hljs-keyword">if</span>(_.isObject(observer.context.__observers[observer.path])){
        <span class="hljs-keyword">delete</span> observer.context.__observers[observer.path][observer.index];
      }
    });

    <span class="hljs-keyword">this</span>.observers = <span class="hljs-literal">null</span>;
  }
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> LazyValue;</pre></div></div>
            
        </li>
        
        
        <li id="section-206">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-206">&#182;</a>
              </div>
              <h2 id="rebound-router">Rebound Router</h2>

            </div>
            
        </li>
        
        
        <li id="section-207">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-207">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">import</span> $ from <span class="hljs-string">"rebound-component/utils"</span>;
<span class="hljs-keyword">import</span> LazyComponent <span class="hljs-keyword">from</span> <span class="hljs-string">"rebound-router/lazy-component"</span>;

<span class="hljs-keyword">var</span> DEFAULT_404_PAGE =
<span class="hljs-string">`&lt;div style="display: block;text-align: center;font-size: 22px;"&gt;
  &lt;h1 style="margin-top: 60px;"&gt;
    Oops! We couldn't find this page.
  &lt;/h1&gt;
  &lt;a href="#" onclick="window.history.back();return false;" style="display: block;text-decoration: none;margin-top: 30px;"&gt;
    Take me back
  &lt;/a&gt;
&lt;/div&gt;`</span>;

<span class="hljs-keyword">var</span> ERROR_ROUTE_NAME = <span class="hljs-string">'error'</span>;
<span class="hljs-keyword">var</span> SUCCESS = <span class="hljs-string">'success'</span>;
<span class="hljs-keyword">var</span> ERROR = <span class="hljs-string">'error'</span>;
<span class="hljs-keyword">var</span> LOADING = <span class="hljs-string">'loading'</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-208">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-208">&#182;</a>
              </div>
              <p>Overload Backbone’s loadUrl so it returns the value of the routed callback
instead of undefined</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Backbone.history.loadUrl = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(fragment)</span> </span>{
  fragment = <span class="hljs-keyword">this</span>.fragment = <span class="hljs-keyword">this</span>.getFragment(fragment);
  <span class="hljs-keyword">var</span> resp = <span class="hljs-literal">false</span>;
  _.any(<span class="hljs-keyword">this</span>.handlers, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(handler)</span> </span>{
    <span class="hljs-keyword">if</span> (handler.route.test(fragment)) {
      resp = handler.callback(fragment);
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
  });
  <span class="hljs-keyword">return</span> resp;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-209">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-209">&#182;</a>
              </div>
              <p>ReboundRouter Constructor</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> ReboundRouter = Backbone.Router.extend({

  status: SUCCESS, <span class="hljs-comment">// loading, success or error</span></pre></div></div>
            
        </li>
        
        
        <li id="section-210">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-210">&#182;</a>
              </div>
              <p>By default there is one route. The wildcard route fetches the required
page assets based on user-defined naming convention.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  routes: {
    <span class="hljs-string">'*route'</span>: <span class="hljs-string">'wildcardRoute'</span>
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-211">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-211">&#182;</a>
              </div>
              <p>Called when no matching routes are found. Extracts root route and fetches it’s resources</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  wildcardRoute: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(route)</span> </span>{
    <span class="hljs-keyword">var</span> primaryRoute;</pre></div></div>
            
        </li>
        
        
        <li id="section-212">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-212">&#182;</a>
              </div>
              <p>If empty route sent, route home</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    route = route || <span class="hljs-string">''</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-213">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-213">&#182;</a>
              </div>
              <p>Get Root of Route</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    primaryRoute = (route) ? route.split(<span class="hljs-string">'/'</span>)[<span class="hljs-number">0</span>] : <span class="hljs-string">'index'</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-214">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-214">&#182;</a>
              </div>
              <p>Fetch Resources</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-built_in">document</span>.body.classList.add(<span class="hljs-string">"loading"</span>);

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._fetchResource(route, <span class="hljs-keyword">this</span>.config.container).then(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
      <span class="hljs-built_in">document</span>.body.classList.remove(<span class="hljs-string">'loading'</span>);
    }).catch(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{});
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-215">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-215">&#182;</a>
              </div>
              <p>Modify navigate to default to <code>trigger=true</code> and to return the value of
<code>Backbone.history.navigate</code> inside of a promise.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  navigate: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(fragment, options={})</span> </span>{
    (options.trigger === <span class="hljs-literal">undefined</span>) &amp;&amp; (options.trigger = <span class="hljs-literal">true</span>);
    <span class="hljs-keyword">var</span> resp = Backbone.history.navigate(fragment, options);</pre></div></div>
            
        </li>
        
        
        <li id="section-216">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-216">&#182;</a>
              </div>
              <p>Always return a promise</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(resolve, reject)</span> </span>{
      <span class="hljs-keyword">if</span>(resp &amp;&amp; resp.constructor === <span class="hljs-built_in">Promise</span>) resp.then(resolve, reject);
      resolve(resp);
    });
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-217">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-217">&#182;</a>
              </div>
              <p>Modify <code>router.execute</code> to return the value of our route callback</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  execute: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(callback, args, name)</span> </span>{
    <span class="hljs-keyword">if</span> (callback) <span class="hljs-keyword">return</span> callback.apply(<span class="hljs-keyword">this</span>, args);
  },

  route: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(route, name, callback)</span> </span>{
    <span class="hljs-keyword">if</span> (!_.isRegExp(route)) route = <span class="hljs-keyword">this</span>._routeToRegExp(route);
    <span class="hljs-keyword">if</span> (_.isFunction(name)) {
      callback = name;
      name = <span class="hljs-string">''</span>;
    }

    <span class="hljs-keyword">if</span> (!callback) callback = <span class="hljs-keyword">this</span>[name];
    Backbone.history.route(route, (fragment) =&gt; {
      <span class="hljs-keyword">var</span> args = <span class="hljs-keyword">this</span>._extractParameters(route, fragment);
      <span class="hljs-keyword">var</span> resp = <span class="hljs-keyword">this</span>.execute(callback, args, name);
      <span class="hljs-keyword">if</span> ( resp !== <span class="hljs-literal">false</span>) {
        <span class="hljs-keyword">this</span>.trigger.apply(<span class="hljs-keyword">this</span>, [<span class="hljs-string">'route:'</span> + name].concat(args));
        <span class="hljs-keyword">this</span>.trigger(<span class="hljs-string">'route'</span>, name, args);
        Backbone.history.trigger(<span class="hljs-string">'route'</span>, <span class="hljs-keyword">this</span>, name, args);
      }
      <span class="hljs-keyword">return</span> resp;
    });
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-218">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-218">&#182;</a>
              </div>
              <p>On startup, save our config object and start the router</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  initialize: function(options={}, callback=function(){}) {</pre></div></div>
            
        </li>
        
        
        <li id="section-219">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-219">&#182;</a>
              </div>
              <p>Let all of our components always have referance to our router</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    Rebound.Component.prototype.router = <span class="hljs-keyword">this</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-220">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-220">&#182;</a>
              </div>
              <p>Save our config referance</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.config = options;
    <span class="hljs-keyword">this</span>.config.handlers = [];</pre></div></div>
            
        </li>
        
        
        <li id="section-221">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-221">&#182;</a>
              </div>
              <p>Allow user to override error route</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    ERROR_ROUTE_NAME = <span class="hljs-keyword">this</span>.config.errorRoute || ERROR_ROUTE_NAME;</pre></div></div>
            
        </li>
        
        
        <li id="section-222">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-222">&#182;</a>
              </div>
              <p>Use the user provided container, or default to the closest <code>&lt;content&gt;</code> tag</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> container = <span class="hljs-keyword">this</span>.config.container = $((<span class="hljs-keyword">this</span>.config.container || <span class="hljs-string">'content'</span>))[<span class="hljs-number">0</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-223">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-223">&#182;</a>
              </div>
              <p>Convert our routeMappings to regexps and push to our handlers</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    _.each(<span class="hljs-keyword">this</span>.config.routeMapping, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value, route)</span></span>{
      <span class="hljs-keyword">if</span> (!_.isRegExp(route)) route = <span class="hljs-keyword">this</span>._routeToRegExp(route);
      <span class="hljs-keyword">this</span>.config.handlers.unshift({ route: route, primaryRoute: value });
    }, <span class="hljs-keyword">this</span>);

    <span class="hljs-keyword">this</span>._watchLinks(container);
    Rebound.services.page = <span class="hljs-keyword">new</span> LazyComponent();</pre></div></div>
            
        </li>
        
        
        <li id="section-224">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-224">&#182;</a>
              </div>
              <p>Install our global components</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    _.each(<span class="hljs-keyword">this</span>.config.services, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(selector, route)</span></span>{
      <span class="hljs-keyword">var</span> container = $(selector)[<span class="hljs-number">0</span>] || <span class="hljs-built_in">document</span>.createElement(selector || <span class="hljs-string">'span'</span>);
      <span class="hljs-keyword">this</span>._watchLinks(container);
      Rebound.services[route] = <span class="hljs-keyword">new</span> LazyComponent();
      <span class="hljs-keyword">this</span>._fetchResource(route, container).catch(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{});
    }, <span class="hljs-keyword">this</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-225">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-225">&#182;</a>
              </div>
              <p>Start the history and call the provided callback</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    Backbone.history.start({
      pushState: (<span class="hljs-keyword">this</span>.config.pushState === <span class="hljs-literal">undefined</span>) ? <span class="hljs-literal">true</span> : <span class="hljs-keyword">this</span>.config.pushState,
      root: <span class="hljs-keyword">this</span>.config.root
    }).then(callback);

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-226">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-226">&#182;</a>
              </div>
              <p>Given a dom element, watch for all click events on anchor tags.
If the clicked anchor has a relative url, attempt to route to that path.
Give all links on the page that match this path the class <code>active</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _watchLinks: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(container)</span></span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-227">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-227">&#182;</a>
              </div>
              <p>Navigate to route for any link with a relative href</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> remoteUrl = <span class="hljs-regexp">/^([a-z]+:)|^(\/\/)|^([^\/]+\.)/</span>;
    $(container).on(<span class="hljs-string">'click'</span>, <span class="hljs-string">'a'</span>, (e) =&gt; {
      <span class="hljs-keyword">var</span> path = e.target.getAttribute(<span class="hljs-string">'href'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-228">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-228">&#182;</a>
              </div>
              <p>If path is not an remote url, ends in .[a-z], or blank, try and navigate to that route.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span>( path &amp;&amp; path !== <span class="hljs-string">'#'</span> &amp;&amp; !remoteUrl.test(path) ) e.preventDefault();</pre></div></div>
            
        </li>
        
        
        <li id="section-229">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-229">&#182;</a>
              </div>
              <p>If this is not our current route, navigate to the new route</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span>(path !== <span class="hljs-string">'/'</span>+Backbone.history.fragment){
        $(container).unMarkLinks();
        <span class="hljs-keyword">this</span>.navigate(path, {trigger: <span class="hljs-literal">true</span>})
          .then(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{ $(container).markLinks(); });
      }
    });
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-230">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-230">&#182;</a>
              </div>
              <p>De-initializes the previous app before rendering a new app
This way we can ensure that every new page starts with a clean slate
This is crucial for scalability of a single page app.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _uninstallResource: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{

    <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>.current) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">var</span> oldPageName = <span class="hljs-keyword">this</span>.current.__name;</pre></div></div>
            
        </li>
        
        
        <li id="section-231">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-231">&#182;</a>
              </div>
              <p>Unset Previous Application’s Routes. For each route in the page app:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    _.each(<span class="hljs-keyword">this</span>.current.data.routes, (value, key) =&gt; {

      <span class="hljs-keyword">var</span> regExp = <span class="hljs-keyword">this</span>._routeToRegExp(key).toString();</pre></div></div>
            
        </li>
        
        
        <li id="section-232">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-232">&#182;</a>
              </div>
              <p>Remove the handler from our route object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      Backbone.history.handlers = _.filter(Backbone.history.handlers, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj)</span></span>{<span class="hljs-keyword">return</span> obj.route.toString() !== regExp;});</pre></div></div>
            
        </li>
        
        
        <li id="section-233">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-233">&#182;</a>
              </div>
              <p>Delete our referance to the route’s callback</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>[ <span class="hljs-string">'_function_'</span> + key ];

    });</pre></div></div>
            
        </li>
        
        
        <li id="section-234">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-234">&#182;</a>
              </div>
              <p>Un-hook Event Bindings, Delete Objects</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.current.data.deinitialize();</pre></div></div>
            
        </li>
        
        
        <li id="section-235">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-235">&#182;</a>
              </div>
              <p>Now we no longer have a page installed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.current = <span class="hljs-literal">undefined</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-236">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-236">&#182;</a>
              </div>
              <p>Disable old css if it exists</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    setTimeout(() =&gt; {
      <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.status === ERROR) <span class="hljs-keyword">return</span>;
      <span class="hljs-built_in">document</span>.getElementById(oldPageName + <span class="hljs-string">'-css'</span>).setAttribute(<span class="hljs-string">'disabled'</span>, <span class="hljs-literal">true</span>);
    }, <span class="hljs-number">500</span>);

  },</pre></div></div>
            
        </li>
        
        
        <li id="section-237">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-237">&#182;</a>
              </div>
              <p>Give our new page component, load routes and render a new instance of the
page component in the top level outlet.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _installResource: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(PageApp, primaryRoute, container)</span> </span>{
    <span class="hljs-keyword">var</span> oldPageName, pageInstance;
    <span class="hljs-keyword">var</span> isService = (container !== <span class="hljs-keyword">this</span>.config.container);
    container.classList.remove(<span class="hljs-string">'error'</span>, <span class="hljs-string">'loading'</span>);

    <span class="hljs-keyword">if</span>(!isService &amp;&amp; <span class="hljs-keyword">this</span>.current) <span class="hljs-keyword">this</span>._uninstallResource();</pre></div></div>
            
        </li>
        
        
        <li id="section-238">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-238">&#182;</a>
              </div>
              <p>Load New PageApp, give it it’s name so we know what css to remove when it deinitializes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    pageInstance = <span class="hljs-keyword">new</span> PageApp();
    pageInstance.__name = primaryRoute;</pre></div></div>
            
        </li>
        
        
        <li id="section-239">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-239">&#182;</a>
              </div>
              <p>Add to our page</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    container.innerHTML = <span class="hljs-string">''</span>;
    container.appendChild(pageInstance);</pre></div></div>
            
        </li>
        
        
        <li id="section-240">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-240">&#182;</a>
              </div>
              <p>Make sure we’re back at the top of the page</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-built_in">document</span>.body.scrollTop = <span class="hljs-number">0</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-241">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-241">&#182;</a>
              </div>
              <p>Augment ApplicationRouter with new routes from PageApp</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    _.each(pageInstance.data.routes, (value, key) =&gt; {</pre></div></div>
            
        </li>
        
        
        <li id="section-242">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-242">&#182;</a>
              </div>
              <p>Generate our route callback’s new name</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> routeFunctionName = <span class="hljs-string">'_function_'</span> + key,
          functionName;</pre></div></div>
            
        </li>
        
        
        <li id="section-243">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-243">&#182;</a>
              </div>
              <p>Add the new callback referance on to our router and add the route handler</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">this</span>[routeFunctionName] =  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{ pageInstance.data[value].apply(pageInstance.data, <span class="hljs-built_in">arguments</span>); };
      <span class="hljs-keyword">this</span>.route(key, value, <span class="hljs-keyword">this</span>[routeFunctionName]);
    }, <span class="hljs-keyword">this</span>);

    <span class="hljs-keyword">var</span> name = (isService) ? primaryRoute : <span class="hljs-string">'page'</span>;
    <span class="hljs-keyword">if</span>(!isService) <span class="hljs-keyword">this</span>.current = pageInstance;
    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">window</span>.Rebound.services[name].isService)
      <span class="hljs-built_in">window</span>.Rebound.services[name].hydrate(pageInstance.data);
    <span class="hljs-built_in">window</span>.Rebound.services[name] = pageInstance.data;</pre></div></div>
            
        </li>
        
        
        <li id="section-244">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-244">&#182;</a>
              </div>
              <p>Re-trigger route so the newly added route may execute if there’s a route match.
If no routes are matched, app will hit wildCard route which will then trigger 404</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(!isService){
      <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.config.triggerOnFirstLoad) Backbone.history.loadUrl(Backbone.history.fragment);
      <span class="hljs-keyword">this</span>.config.triggerOnFirstLoad = <span class="hljs-literal">true</span>;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-245">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-245">&#182;</a>
              </div>
              <p>Return our newly installed app</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">return</span> pageInstance;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-246">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-246">&#182;</a>
              </div>
              <p>Fetches HTML and CSS</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _fetchResource: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(route, container)</span> </span>{
    <span class="hljs-keyword">var</span> jsUrl, cssUrl,
        cssLoaded = <span class="hljs-literal">false</span>,
        jsLoaded = <span class="hljs-literal">false</span>,
        cssElement, jsElement,
        PageClass, appName, primaryRoute,
        isService = (container !== <span class="hljs-keyword">this</span>.config.container);</pre></div></div>
            
        </li>
        
        
        <li id="section-247">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-247">&#182;</a>
              </div>
              <p>Get the root of this route</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    appName = primaryRoute = (route) ? route.split(<span class="hljs-string">'/'</span>)[<span class="hljs-number">0</span>] : <span class="hljs-string">'index'</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-248">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-248">&#182;</a>
              </div>
              <p>Find Any Custom Route Mappings</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    _.any(<span class="hljs-keyword">this</span>.config.handlers, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(handler)</span> </span>{
      <span class="hljs-keyword">if</span> (handler.route.test(route)) {
        appName = handler.primaryRoute;
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
      }
    });

    jsUrl = <span class="hljs-keyword">this</span>.config.jsPath.replace(<span class="hljs-regexp">/:route/g</span>, primaryRoute).replace(<span class="hljs-regexp">/:app/g</span>, appName);
    cssUrl = <span class="hljs-keyword">this</span>.config.cssPath.replace(<span class="hljs-regexp">/:route/g</span>, primaryRoute).replace(<span class="hljs-regexp">/:app/g</span>, appName);
    cssElement = <span class="hljs-built_in">document</span>.getElementById(appName + <span class="hljs-string">'-css'</span>);
    jsElement = <span class="hljs-built_in">document</span>.getElementById(appName + <span class="hljs-string">'-js'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-249">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-249">&#182;</a>
              </div>
              <p>Wrap these async resource fetches in a promise and return it.
This promise resolves when both css and js resources are loaded
It rejects if either of the css or js resources fails to load.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>((resolve, reject) =&gt; {

      <span class="hljs-keyword">this</span>.status = LOADING;

      <span class="hljs-keyword">var</span> defaultError = (err) =&gt; {
        <span class="hljs-keyword">if</span>(!isService){
          <span class="hljs-keyword">this</span>._uninstallResource();
          container.innerHTML = DEFAULT_404_PAGE;
        }
        reject(err);
      };

      <span class="hljs-keyword">var</span> throwError = (err) =&gt; {
        <span class="hljs-keyword">if</span>(route === ERROR_ROUTE_NAME) <span class="hljs-keyword">return</span> defaultError();
        <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.status === ERROR) <span class="hljs-keyword">return</span>;
        <span class="hljs-keyword">this</span>.status = ERROR;
        <span class="hljs-built_in">console</span>.error(<span class="hljs-string">'Could not '</span> + ((isService) ? <span class="hljs-string">'load the '</span> + route + <span class="hljs-string">' service:'</span> : <span class="hljs-string">'find the '</span> + route + <span class="hljs-string">' page:'</span>) +
                      <span class="hljs-string">'\n  - CSS Url: '</span>+ cssUrl +
                      <span class="hljs-string">'\n  - JavaScript Url: '</span> + jsUrl);
        <span class="hljs-keyword">this</span>._fetchResource(ERROR_ROUTE_NAME, container).then(reject, reject);
      };</pre></div></div>
            
        </li>
        
        
        <li id="section-250">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-250">&#182;</a>
              </div>
              <p>If Page Is Already Loaded Then The Route Does Not Exist. 404 and Exit.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.current &amp;&amp; <span class="hljs-keyword">this</span>.current.name === primaryRoute) {
        <span class="hljs-keyword">return</span> throwError();
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-251">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-251">&#182;</a>
              </div>
              <p>If this css element is not on the page already, it hasn’t been loaded before -
create the element and load the css resource.
Else if the css resource has been loaded before, enable it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span>(cssElement === <span class="hljs-literal">null</span>){
        cssElement = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'link'</span>);
        cssElement.setAttribute(<span class="hljs-string">'type'</span>, <span class="hljs-string">'text/css'</span>);
        cssElement.setAttribute(<span class="hljs-string">'rel'</span>, <span class="hljs-string">'stylesheet'</span>);
        cssElement.setAttribute(<span class="hljs-string">'href'</span>, cssUrl);
        cssElement.setAttribute(<span class="hljs-string">'id'</span>, appName + <span class="hljs-string">'-css'</span>);
        $(cssElement).on(<span class="hljs-string">'load'</span>, (event) =&gt; {
            <span class="hljs-keyword">if</span>((cssLoaded = <span class="hljs-literal">true</span>) &amp;&amp; jsLoaded){
              <span class="hljs-keyword">this</span>.status = SUCCESS;
              <span class="hljs-keyword">this</span>._installResource(PageClass, appName, container);
              resolve(<span class="hljs-keyword">this</span>);
            }
          });
        $(cssElement).on(<span class="hljs-string">'error'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span></span>{
          cssElement.dataset.error = <span class="hljs-string">''</span>;
          throwError();
        });
        <span class="hljs-built_in">document</span>.head.appendChild(cssElement);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">if</span>(cssElement.hasAttribute(<span class="hljs-string">'data-error'</span>)){<span class="hljs-keyword">return</span> throwError();}
        <span class="hljs-keyword">if</span>((cssLoaded = <span class="hljs-literal">true</span>) &amp;&amp; jsLoaded){
          cssElement &amp;&amp; cssElement.removeAttribute(<span class="hljs-string">'disabled'</span>);
          cssLoaded = <span class="hljs-literal">true</span>;
        }
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-252">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-252">&#182;</a>
              </div>
              <p>AMD will manage dependancies for us. Load the JavaScript.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-built_in">window</span>.require([jsUrl], (c) =&gt; {
        jsElement = $(<span class="hljs-string">'script[src="'</span>+jsUrl+<span class="hljs-string">'"]'</span>)[<span class="hljs-number">0</span>];
        jsElement.setAttribute(<span class="hljs-string">'id'</span>, appName + <span class="hljs-string">'-js'</span>);
        <span class="hljs-keyword">if</span>((jsLoaded = <span class="hljs-literal">true</span>) &amp;&amp; (PageClass = c) &amp;&amp; cssLoaded){
          <span class="hljs-keyword">this</span>.status = SUCCESS;
          cssElement &amp;&amp; cssElement.removeAttribute(<span class="hljs-string">'disabled'</span>);
          <span class="hljs-keyword">this</span>._installResource(PageClass, appName, container);
          resolve(<span class="hljs-keyword">this</span>);
        }
      }, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
        jsElement = $(<span class="hljs-string">'script[src="'</span>+jsUrl+<span class="hljs-string">'"]'</span>)[<span class="hljs-number">0</span>];
        jsElement.setAttribute(<span class="hljs-string">'id'</span>, appName + <span class="hljs-string">'-js'</span>);
        jsElement.dataset.error = <span class="hljs-string">''</span>;
        throwError();
      });
    });
  }
});

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> ReboundRouter;</pre></div></div>
            
        </li>
        
        
        <li id="section-253">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-253">&#182;</a>
              </div>
              <h2 id="rebound-utils">Rebound Utils</h2>

            </div>
            
        </li>
        
        
        <li id="section-254">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-254">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">var</span> $ = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(query)</span></span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> utils(query);
};

<span class="hljs-keyword">var</span> utils = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(query)</span></span>{
  <span class="hljs-keyword">var</span> i, selector = _.isElement(query) &amp;&amp; [query] || (query === <span class="hljs-built_in">document</span>) &amp;&amp; [<span class="hljs-built_in">document</span>] || _.isString(query) &amp;&amp; <span class="hljs-built_in">document</span>.querySelectorAll(query) || [];
  <span class="hljs-keyword">this</span>.length = selector.length;</pre></div></div>
            
        </li>
        
        
        <li id="section-255">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-255">&#182;</a>
              </div>
              <p>Add selector to object for method chaining</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">for</span> (i=<span class="hljs-number">0</span>; i &lt; <span class="hljs-keyword">this</span>.length; i++) {
      <span class="hljs-keyword">this</span>[i] = selector[i];
  }

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">returnFalse</span><span class="hljs-params">()</span></span>{<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;}
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">returnTrue</span><span class="hljs-params">()</span></span>{<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;}</pre></div></div>
            
        </li>
        
        
        <li id="section-256">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-256">&#182;</a>
              </div>
              <p>Shim console for IE9</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">if</span>(!(<span class="hljs-built_in">window</span>.console &amp;&amp; <span class="hljs-built_in">console</span>.log)) {
  <span class="hljs-built_in">console</span> = {
    log: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{},
    debug: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{},
    info: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{},
    warn: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{},
    error: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{}
  };
}

$.Event = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( src, props )</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-257">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-257">&#182;</a>
              </div>
              <p>Allow instantiation without the ‘new’ keyword</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">if</span> ( !(<span class="hljs-keyword">this</span> <span class="hljs-keyword">instanceof</span> $.Event) ) {
		<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> $.Event( src, props );
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-258">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-258">&#182;</a>
              </div>
              <p>Event object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">if</span> ( src &amp;&amp; src.type ) {
		<span class="hljs-keyword">this</span>.originalEvent = src;
		<span class="hljs-keyword">this</span>.type = src.type;</pre></div></div>
            
        </li>
        
        
        <li id="section-259">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-259">&#182;</a>
              </div>
              <p>Events bubbling up the document may have been marked as prevented
by a handler lower down the tree; reflect the correct value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">this</span>.isDefaultPrevented = src.defaultPrevented ||
				src.defaultPrevented === <span class="hljs-literal">undefined</span> &amp;&amp;</pre></div></div>
            
        </li>
        
        
        <li id="section-260">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-260">&#182;</a>
              </div>
              <p>Support: Android&lt;4.0</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				src.returnValue === <span class="hljs-literal">false</span> ?
			returnTrue :
			returnFalse;</pre></div></div>
            
        </li>
        
        
        <li id="section-261">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-261">&#182;</a>
              </div>
              <p>Event type</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	} <span class="hljs-keyword">else</span> {
		<span class="hljs-keyword">this</span>.type = src;
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-262">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-262">&#182;</a>
              </div>
              <p>Put explicitly provided properties onto the event object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">if</span> ( props ) {
		_.extend( <span class="hljs-keyword">this</span>, props );
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-263">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-263">&#182;</a>
              </div>
              <p>Copy over all original event properties</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.extend(<span class="hljs-keyword">this</span>, _.pick( <span class="hljs-keyword">this</span>.originalEvent, [
      <span class="hljs-string">"altKey"</span>, <span class="hljs-string">"bubbles"</span>, <span class="hljs-string">"cancelable"</span>, <span class="hljs-string">"ctrlKey"</span>, <span class="hljs-string">"currentTarget"</span>, <span class="hljs-string">"eventPhase"</span>,
      <span class="hljs-string">"metaKey"</span>, <span class="hljs-string">"relatedTarget"</span>, <span class="hljs-string">"shiftKey"</span>, <span class="hljs-string">"target"</span>, <span class="hljs-string">"timeStamp"</span>, <span class="hljs-string">"view"</span>,
      <span class="hljs-string">"which"</span>, <span class="hljs-string">"char"</span>, <span class="hljs-string">"charCode"</span>, <span class="hljs-string">"key"</span>, <span class="hljs-string">"keyCode"</span>, <span class="hljs-string">"button"</span>, <span class="hljs-string">"buttons"</span>,
      <span class="hljs-string">"clientX"</span>, <span class="hljs-string">"clientY"</span>, <span class="hljs-string">""</span>, <span class="hljs-string">"offsetX"</span>, <span class="hljs-string">"offsetY"</span>, <span class="hljs-string">"pageX"</span>, <span class="hljs-string">"pageY"</span>, <span class="hljs-string">"screenX"</span>,
      <span class="hljs-string">"screenY"</span>, <span class="hljs-string">"toElement"</span>
    ]));</pre></div></div>
            
        </li>
        
        
        <li id="section-264">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-264">&#182;</a>
              </div>
              <p>Create a timestamp if incoming event doesn’t have one</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">this</span>.timeStamp = src &amp;&amp; src.timeStamp || (<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>()).getTime();</pre></div></div>
            
        </li>
        
        
        <li id="section-265">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-265">&#182;</a>
              </div>
              <p>Mark it as fixed</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">this</span>.isEvent = <span class="hljs-literal">true</span>;
};

$.Event.prototype = {
	constructor: $.Event,
	isDefaultPrevented: returnFalse,
	isPropagationStopped: returnFalse,
	isImmediatePropagationStopped: returnFalse,

	preventDefault: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
		<span class="hljs-keyword">var</span> e = <span class="hljs-keyword">this</span>.originalEvent;

		<span class="hljs-keyword">this</span>.isDefaultPrevented = returnTrue;

		<span class="hljs-keyword">if</span> ( e &amp;&amp; e.preventDefault ) {
			e.preventDefault();
		}
	},
	stopPropagation: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
		<span class="hljs-keyword">var</span> e = <span class="hljs-keyword">this</span>.originalEvent;

		<span class="hljs-keyword">this</span>.isPropagationStopped = returnTrue;

		<span class="hljs-keyword">if</span> ( e &amp;&amp; e.stopPropagation ) {
			e.stopPropagation();
		}
	},
	stopImmediatePropagation: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
		<span class="hljs-keyword">var</span> e = <span class="hljs-keyword">this</span>.originalEvent;

		<span class="hljs-keyword">this</span>.isImmediatePropagationStopped = returnTrue;

		<span class="hljs-keyword">if</span> ( e &amp;&amp; e.stopImmediatePropagation ) {
			e.stopImmediatePropagation();
		}

		<span class="hljs-keyword">this</span>.stopPropagation();
	}
};


utils.prototype = {</pre></div></div>
            
        </li>
        
        
        <li id="section-266">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-266">&#182;</a>
              </div>
              <p>Given a valid data path, split it into an array of its parts.
ex: foo.bar[0].baz —&gt; [‘foo’, ‘var’, ‘0’, ‘baz’]</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  splitPath: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(path)</span></span>{
    path = (<span class="hljs-string">'.'</span>+path+<span class="hljs-string">'.'</span>).split(<span class="hljs-regexp">/(?:\.|\[|\])+/</span>);
    path.pop();
    path.shift();
    <span class="hljs-keyword">return</span> path;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-267">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-267">&#182;</a>
              </div>
              <p>Applies function <code>func</code> depth first to every node in the subtree starting from <code>root</code>
If the callback returns <code>false</code>, short circuit that tree.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  walkTheDOM: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(func)</span> </span>{
    <span class="hljs-keyword">var</span> el, root, len = <span class="hljs-keyword">this</span>.length, result;
    <span class="hljs-keyword">while</span>(len--){
      root = <span class="hljs-keyword">this</span>[len];
      result = func(root);
      <span class="hljs-keyword">if</span>(result === <span class="hljs-literal">false</span>) <span class="hljs-keyword">return</span>;
      root = root.firstChild;
      <span class="hljs-keyword">while</span> (root) {
          $(root).walkTheDOM(func);
          root = root.nextSibling;
      }
    }
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-268">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-268">&#182;</a>
              </div>
              <p>Searches each key in an object and tests if the property has a lookupGetter or
lookupSetter. If either are preset convert the property into a computed property.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  extractComputedProps: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj)</span></span>{
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> key <span class="hljs-keyword">in</span> obj){
      <span class="hljs-keyword">let</span> get, set;
      <span class="hljs-keyword">if</span>(!obj.hasOwnProperty(key)) <span class="hljs-keyword">continue</span>;
      <span class="hljs-keyword">var</span> desc = <span class="hljs-built_in">Object</span>.getOwnPropertyDescriptor(obj, key);
      get = desc.hasOwnProperty(<span class="hljs-string">'get'</span>) &amp;&amp; desc.get;
      set = desc.hasOwnProperty(<span class="hljs-string">'set'</span>) &amp;&amp; desc.set;
      <span class="hljs-keyword">if</span>(get || set){
        <span class="hljs-keyword">delete</span> obj[key];
        obj[key] = {get: get, set: set, isComputedProto: <span class="hljs-literal">true</span>};
      }
    };
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-269">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-269">&#182;</a>
              </div>
              <p>Events registry. An object containing all events bound through this util shared among all instances.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _events: {},</pre></div></div>
            
        </li>
        
        
        <li id="section-270">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-270">&#182;</a>
              </div>
              <p>Takes the targed the event fired on and returns all callbacks for the delegated element</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _hasDelegate: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(target, delegate, eventType)</span></span>{
    <span class="hljs-keyword">var</span> callbacks = [];</pre></div></div>
            
        </li>
        
        
        <li id="section-271">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-271">&#182;</a>
              </div>
              <p>Get our callbacks</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(target.delegateGroup &amp;&amp; <span class="hljs-keyword">this</span>._events[target.delegateGroup][eventType]){
      _.each(<span class="hljs-keyword">this</span>._events[target.delegateGroup][eventType], <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(callbacksList, delegateId)</span></span>{
        <span class="hljs-keyword">if</span>(_.isArray(callbacksList) &amp;&amp; (delegateId === delegate.delegateId || ( delegate.matchesSelector &amp;&amp; delegate.matchesSelector(delegateId) )) ){
          callbacks = callbacks.concat(callbacksList);
        }
      });
    }

    <span class="hljs-keyword">return</span> callbacks;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-272">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-272">&#182;</a>
              </div>
              <p>Triggers an event on a given dom node</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  trigger: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(eventName, options)</span></span>{
    <span class="hljs-keyword">var</span> el, len = <span class="hljs-keyword">this</span>.length;
    <span class="hljs-keyword">while</span>(len--){
      el = <span class="hljs-keyword">this</span>[len];
      <span class="hljs-keyword">if</span> (<span class="hljs-built_in">document</span>.createEvent) {
        <span class="hljs-keyword">var</span> event = <span class="hljs-built_in">document</span>.createEvent(<span class="hljs-string">'HTMLEvents'</span>);
        event.initEvent(eventName, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>);
        el.dispatchEvent(event);
      } <span class="hljs-keyword">else</span> {
        el.fireEvent(<span class="hljs-string">'on'</span>+eventName);
      }
    }
  },

  off: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(eventType, handler)</span></span>{
    <span class="hljs-keyword">var</span> el, len = <span class="hljs-keyword">this</span>.length, eventCount;

    <span class="hljs-keyword">while</span>(len--){

      el = <span class="hljs-keyword">this</span>[len];
      eventCount = <span class="hljs-number">0</span>;

      <span class="hljs-keyword">if</span>(el.delegateGroup){
        <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>._events[el.delegateGroup][eventType] &amp;&amp; _.isArray(<span class="hljs-keyword">this</span>._events[el.delegateGroup][eventType][el.delegateId])){
          _.each(<span class="hljs-keyword">this</span>._events[el.delegateGroup][eventType], <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(delegate, index, delegateList)</span></span>{
            _.each(delegateList, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(callback, index, callbackList)</span></span>{
              <span class="hljs-keyword">if</span>(callback === handler){
                <span class="hljs-keyword">delete</span> callbackList[index];
                <span class="hljs-keyword">return</span>;
              }
              eventCount++;
            });
          });
        }
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-273">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-273">&#182;</a>
              </div>
              <p>If there are no more of this event type delegated for this group, remove the listener</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (eventCount === <span class="hljs-number">0</span> &amp;&amp; el.removeEventListener){
        el.removeEventListener(eventType, handler, <span class="hljs-literal">false</span>);
      }
      <span class="hljs-keyword">if</span> (eventCount === <span class="hljs-number">0</span> &amp;&amp; el.detachEvent){
        el.detachEvent(<span class="hljs-string">'on'</span>+eventType, handler);
      }

    }
  },

  on: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(eventName, delegate, data, handler)</span> </span>{
    <span class="hljs-keyword">var</span> el,
        events = <span class="hljs-keyword">this</span>._events,
        len = <span class="hljs-keyword">this</span>.length,
        eventNames = eventName.split(<span class="hljs-string">' '</span>),
        delegateId, delegateGroup;

    <span class="hljs-keyword">while</span>(len--){
      el = <span class="hljs-keyword">this</span>[len];</pre></div></div>
            
        </li>
        
        
        <li id="section-274">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-274">&#182;</a>
              </div>
              <p>Normalize data input</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span>(_.isFunction(delegate)){
        handler = delegate;
        delegate = el;
        data = {};
      }
      <span class="hljs-keyword">if</span>(_.isFunction(data)){
        handler = data;
        data = {};
      }
      <span class="hljs-keyword">if</span>(!_.isString(delegate) &amp;&amp; !_.isElement(delegate)){
        <span class="hljs-built_in">console</span>.error(<span class="hljs-string">"Delegate value passed to Rebound's $.on is neither an element or css selector"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
      }

      delegateId = _.isString(delegate) ? delegate : (delegate.delegateId = delegate.delegateId || _.uniqueId(<span class="hljs-string">'event'</span>));
      delegateGroup = el.delegateGroup = (el.delegateGroup || _.uniqueId(<span class="hljs-string">'delegateGroup'</span>));

      _.each(eventNames, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(eventName)</span></span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-275">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-275">&#182;</a>
              </div>
              <p>Ensure event obj existance</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        events[delegateGroup] = events[delegateGroup] || {};</pre></div></div>
            
        </li>
        
        
        <li id="section-276">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-276">&#182;</a>
              </div>
              <p>TODO: take out of loop</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> callback = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(event)</span></span>{
              <span class="hljs-keyword">var</span> target, i, len, eventList, callbacks, callback, falsy;
              event = <span class="hljs-keyword">new</span> $.Event((event || <span class="hljs-built_in">window</span>.event)); <span class="hljs-comment">// Convert to mutable event</span>
              target = event.target || event.srcElement;</pre></div></div>
            
        </li>
        
        
        <li id="section-277">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-277">&#182;</a>
              </div>
              <p>Travel from target up to parent firing event on delegate when it exists</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              <span class="hljs-keyword">while</span>(target){</pre></div></div>
            
        </li>
        
        
        <li id="section-278">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-278">&#182;</a>
              </div>
              <p>Get all specified callbacks (element specific and selector specified)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                callbacks = $._hasDelegate(<span class="hljs-keyword">this</span>, target, event.type);

                len = callbacks.length;
                <span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>;i&lt;len;i++){
                  event.target = event.srcElement = target;               <span class="hljs-comment">// Attach this level's target</span>
                  event.data = callbacks[i].data;                         <span class="hljs-comment">// Attach our data to the event</span>
                  event.result = callbacks[i].callback.call(el, event);   <span class="hljs-comment">// Call the callback</span>
                  falsy = ( event.result === <span class="hljs-literal">false</span> ) ? <span class="hljs-literal">true</span> : falsy;      <span class="hljs-comment">// If any callback returns false, log it as falsy</span>
                }</pre></div></div>
            
        </li>
        
        
        <li id="section-279">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-279">&#182;</a>
              </div>
              <p>If any of the callbacks returned false, prevent default and stop propagation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">if</span>(falsy){
                  event.preventDefault();
                  event.stopPropagation();
                  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
                }

                target = target.parentNode;
              }
            };</pre></div></div>
            
        </li>
        
        
        <li id="section-280">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-280">&#182;</a>
              </div>
              <p>If this is the first event of its type, add the event handler
AddEventListener supports IE9+</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span>(!events[delegateGroup][eventName]){</pre></div></div>
            
        </li>
        
        
        <li id="section-281">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-281">&#182;</a>
              </div>
              <p>Because we’re only attaching one callback per event type, this is okay.
This also allows jquery’s trigger method to actually fire delegated events
el[‘on’ + eventName] = callback;
If event is focus or blur, use capture to allow for event delegation.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          el.addEventListener(eventName, callback, (eventName === <span class="hljs-string">'focus'</span> || eventName === <span class="hljs-string">'blur'</span>));
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-282">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-282">&#182;</a>
              </div>
              <p>Add our listener</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        events[delegateGroup][eventName] = events[delegateGroup][eventName] || {};
        events[delegateGroup][eventName][delegateId] = events[delegateGroup][eventName][delegateId] || [];
        events[delegateGroup][eventName][delegateId].push({callback: handler, data: data});

      }, <span class="hljs-keyword">this</span>);
    }
  },

  flatten: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data)</span> </span>{
    <span class="hljs-keyword">var</span> result = {};
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">recurse</span> <span class="hljs-params">(cur, prop)</span> </span>{
      <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Object</span>(cur) !== cur) {
        result[prop] = cur;
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Array</span>.isArray(cur)) {
        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i=<span class="hljs-number">0</span>, l=cur.length; i&lt;l; i++)
          recurse(cur[i], prop + <span class="hljs-string">"["</span> + i + <span class="hljs-string">"]"</span>);
          <span class="hljs-keyword">if</span> (l === <span class="hljs-number">0</span>)
            result[prop] = [];
          } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">var</span> isEmpty = <span class="hljs-literal">true</span>;
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> p <span class="hljs-keyword">in</span> cur) {
              isEmpty = <span class="hljs-literal">false</span>;
              recurse(cur[p], prop ? prop+<span class="hljs-string">"."</span>+p : p);
            }
            <span class="hljs-keyword">if</span> (isEmpty &amp;&amp; prop)
              result[prop] = {};
            }
          }
          recurse(data, <span class="hljs-string">""</span>);
          <span class="hljs-keyword">return</span> result;
        },

  unMarkLinks: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
    <span class="hljs-keyword">var</span> links = <span class="hljs-keyword">this</span>[<span class="hljs-number">0</span>].querySelectorAll(<span class="hljs-string">'a[href="/'</span>+Backbone.history.fragment+<span class="hljs-string">'"]'</span>)
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i=<span class="hljs-number">0</span>;i&lt;links.length;i++){
      links.item(i).classList.remove(<span class="hljs-string">'active'</span>);
      links.item(i).active = <span class="hljs-literal">false</span>;
    }
  },
  markLinks: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
    <span class="hljs-keyword">var</span> links = <span class="hljs-keyword">this</span>[<span class="hljs-number">0</span>].querySelectorAll(<span class="hljs-string">'a[href="/'</span>+Backbone.history.fragment+<span class="hljs-string">'"]'</span>);
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i=<span class="hljs-number">0</span>;i&lt;links.length;i++){
      links.item(i).classList.add(<span class="hljs-string">'active'</span>);
      links.item(i).active = <span class="hljs-literal">true</span>;
    }
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-283">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-283">&#182;</a>
              </div>
              <p><a href="http://krasimirtsonev.com/blog/article/Cross-browser-handling-of-Ajax-requests-in-absurdjs">http://krasimirtsonev.com/blog/article/Cross-browser-handling-of-Ajax-requests-in-absurdjs</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  ajax: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(ops)</span> </span>{
      <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> ops == <span class="hljs-string">'string'</span>) ops = { url: ops };
      ops.url = ops.url || <span class="hljs-string">''</span>;
      ops.json = ops.json || <span class="hljs-literal">true</span>;
      ops.method = ops.method || <span class="hljs-string">'get'</span>;
      ops.data = ops.data || {};
      <span class="hljs-keyword">var</span> getParams = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data, url)</span> </span>{
          <span class="hljs-keyword">var</span> arr = [], str;
          <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> name <span class="hljs-keyword">in</span> data) {
              arr.push(name + <span class="hljs-string">'='</span> + <span class="hljs-built_in">encodeURIComponent</span>(data[name]));
          }
          str = arr.join(<span class="hljs-string">'&amp;'</span>);
          <span class="hljs-keyword">if</span>(str !== <span class="hljs-string">''</span>) {
              <span class="hljs-keyword">return</span> url ? (url.indexOf(<span class="hljs-string">'?'</span>) &lt; <span class="hljs-number">0</span> ? <span class="hljs-string">'?'</span> + str : <span class="hljs-string">'&amp;'</span> + str) : str;
          }
          <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>;
      };
      <span class="hljs-keyword">var</span> api = {
          host: {},
          process: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(ops)</span> </span>{
              <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
              <span class="hljs-keyword">this</span>.xhr = <span class="hljs-literal">null</span>;
              <span class="hljs-keyword">if</span>(<span class="hljs-built_in">window</span>.ActiveXObject) { <span class="hljs-keyword">this</span>.xhr = <span class="hljs-keyword">new</span> ActiveXObject(<span class="hljs-string">'Microsoft.XMLHTTP'</span>); }
              <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-built_in">window</span>.XMLHttpRequest) { <span class="hljs-keyword">this</span>.xhr = <span class="hljs-keyword">new</span> XMLHttpRequest(); }
              <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.xhr) {
                  <span class="hljs-keyword">this</span>.xhr.onreadystatechange = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
                      <span class="hljs-keyword">if</span>(self.xhr.readyState == <span class="hljs-number">4</span> &amp;&amp; self.xhr.status == <span class="hljs-number">200</span>) {
                          <span class="hljs-keyword">var</span> result = self.xhr.responseText;
                          <span class="hljs-keyword">if</span>(ops.json === <span class="hljs-literal">true</span> &amp;&amp; <span class="hljs-keyword">typeof</span> <span class="hljs-built_in">JSON</span> != <span class="hljs-string">'undefined'</span>) {
                              result = <span class="hljs-built_in">JSON</span>.parse(result);
                          }
                          self.doneCallback &amp;&amp; self.doneCallback.apply(self.host, [result, self.xhr]);
                          ops.success &amp;&amp; ops.success.apply(self.host, [result, self.xhr]);
                      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(self.xhr.readyState == <span class="hljs-number">4</span>) {
                          self.failCallback &amp;&amp; self.failCallback.apply(self.host, [self.xhr]);
                          ops.error &amp;&amp; ops.error.apply(self.host, [self.xhr]);
                      }
                      self.alwaysCallback &amp;&amp; self.alwaysCallback.apply(self.host, [self.xhr]);
                      ops.complete &amp;&amp; ops.complete.apply(self.host, [self.xhr]);
                  };
              }
              <span class="hljs-keyword">if</span>(ops.method == <span class="hljs-string">'get'</span>) {
                  <span class="hljs-keyword">this</span>.xhr.open(<span class="hljs-string">"GET"</span>, ops.url + getParams(ops.data, ops.url), <span class="hljs-literal">true</span>);
                  <span class="hljs-keyword">this</span>.setHeaders({
                    <span class="hljs-string">'X-Requested-With'</span>: <span class="hljs-string">'XMLHttpRequest'</span>
                  });
              } <span class="hljs-keyword">else</span> {
                  <span class="hljs-keyword">this</span>.xhr.open(ops.method, ops.url, <span class="hljs-literal">true</span>);
                  <span class="hljs-keyword">this</span>.setHeaders({
                      <span class="hljs-string">'X-Requested-With'</span>: <span class="hljs-string">'XMLHttpRequest'</span>,
                      <span class="hljs-string">'Content-type'</span>: <span class="hljs-string">'application/x-www-form-urlencoded'</span>
                  });
              }
              <span class="hljs-keyword">if</span>(ops.headers &amp;&amp; <span class="hljs-keyword">typeof</span> ops.headers == <span class="hljs-string">'object'</span>) {
                  <span class="hljs-keyword">this</span>.setHeaders(ops.headers);
              }
              setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
                  ops.method == <span class="hljs-string">'get'</span> ? self.xhr.send() : self.xhr.send(getParams(ops.data));
              }, <span class="hljs-number">20</span>);
              <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.xhr;
          },
          done: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(callback)</span> </span>{
              <span class="hljs-keyword">this</span>.doneCallback = callback;
              <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
          },
          fail: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(callback)</span> </span>{
              <span class="hljs-keyword">this</span>.failCallback = callback;
              <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
          },
          always: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(callback)</span> </span>{
              <span class="hljs-keyword">this</span>.alwaysCallback = callback;
              <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
          },
          setHeaders: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(headers)</span> </span>{
              <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> name <span class="hljs-keyword">in</span> headers) {
                  <span class="hljs-keyword">this</span>.xhr &amp;&amp; <span class="hljs-keyword">this</span>.xhr.setRequestHeader(name, headers[name]);
              }
          }
      };
      <span class="hljs-keyword">return</span> api.process(ops);
  }
};

_.extend($, utils.prototype);



<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> $;</pre></div></div>
            
        </li>
        
        
        <li id="section-284">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-284">&#182;</a>
              </div>
              <h2 id="property-compiler">Property Compiler</h2>

            </div>
            
        </li>
        
        
        <li id="section-285">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-285">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">import</span> tokenizer <span class="hljs-keyword">from</span> <span class="hljs-string">"property-compiler/tokenizer"</span>;

<span class="hljs-keyword">const</span> TERMINATORS = [<span class="hljs-string">';'</span>,<span class="hljs-string">','</span>,<span class="hljs-string">'=='</span>,<span class="hljs-string">'&gt;'</span>,<span class="hljs-string">'&lt;'</span>,<span class="hljs-string">'&gt;='</span>,<span class="hljs-string">'&lt;='</span>,<span class="hljs-string">'&gt;=='</span>,<span class="hljs-string">'&lt;=='</span>,<span class="hljs-string">'!='</span>,<span class="hljs-string">'!=='</span>, <span class="hljs-string">'==='</span>, <span class="hljs-string">'&amp;&amp;'</span>, <span class="hljs-string">'||'</span>, <span class="hljs-string">'+'</span>, <span class="hljs-string">'-'</span>, <span class="hljs-string">'/'</span>, <span class="hljs-string">'*'</span>, <span class="hljs-string">'{'</span>, <span class="hljs-string">'}'</span>];

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">reduceMemos</span><span class="hljs-params">(memo, paths)</span></span>{
  <span class="hljs-keyword">var</span> newMemo = [];
  paths = (!_.isArray(paths)) ? [paths] : paths;
  _.each(paths, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(path)</span></span>{
    _.each(memo, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(mem)</span></span>{
      newMemo.push(_.compact([mem, path]).join(<span class="hljs-string">'.'</span>).replace(<span class="hljs-string">'.['</span>, <span class="hljs-string">'['</span>));
    });
  });
  <span class="hljs-keyword">return</span> newMemo;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-286">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-286">&#182;</a>
              </div>
              <p>TODO: Make this farrrrrr more robust…very minimal right now</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">compile</span><span class="hljs-params">(prop, name)</span></span>{
  <span class="hljs-keyword">var</span> output = {};

  <span class="hljs-keyword">if</span>(prop.__params) <span class="hljs-keyword">return</span> prop.__params;

  <span class="hljs-keyword">var</span> str = prop.toString(), <span class="hljs-comment">//.replace(/(?:\/\*(?:[\s\S]*?)\*\/)|(?:([\s;])+\/\/(?:.*)$)/gm, '$1'), // String representation of function sans comments</span>
      nextToken = tokenizer.tokenize(str),
      token,
      finishedPaths = [],
      listening = <span class="hljs-number">0</span>,
      paths = [],
      path,
      attrs = [],
      workingpath = [];
  <span class="hljs-keyword">do</span>{

    token = nextToken();

    <span class="hljs-keyword">if</span>(token.value === <span class="hljs-string">'this'</span>){
      listening++;
      workingpath = [];
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-287">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-287">&#182;</a>
              </div>
              <p>TODO: handle gets on collections</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(token.value === <span class="hljs-string">'get'</span>){
      path = nextToken();
      <span class="hljs-keyword">while</span>(_.isUndefined(path.value)){
        path = nextToken();
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-288">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-288">&#182;</a>
              </div>
              <p>Replace any access to a collection with the generic @each placeholder and push dependancy</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      workingpath.push(path.value.replace(<span class="hljs-regexp">/\[.+\]/g</span>, <span class="hljs-string">".@each"</span>).replace(<span class="hljs-regexp">/^\./</span>, <span class="hljs-string">''</span>));
    }

    <span class="hljs-keyword">if</span>(token.value === <span class="hljs-string">'pluck'</span>){
      path = nextToken();
      <span class="hljs-keyword">while</span>(_.isUndefined(path.value)){
        path = nextToken();
      }

      workingpath.push(<span class="hljs-string">'@each.'</span> + path.value);
    }

    <span class="hljs-keyword">if</span>(token.value === <span class="hljs-string">'slice'</span> || token.value === <span class="hljs-string">'clone'</span> || token.value === <span class="hljs-string">'filter'</span>){
      path = nextToken();
      <span class="hljs-keyword">if</span>(path.type.type === <span class="hljs-string">'('</span>) workingpath.push(<span class="hljs-string">'@each'</span>);
    }

    <span class="hljs-keyword">if</span>(token.value === <span class="hljs-string">'at'</span>){
      path = nextToken();
      <span class="hljs-keyword">while</span>(_.isUndefined(path.value)){
        path = nextToken();
      }
      workingpath.push(<span class="hljs-string">'@each'</span>);
    }

    <span class="hljs-keyword">if</span>(token.value === <span class="hljs-string">'where'</span> || token.value === <span class="hljs-string">'findWhere'</span>){
      workingpath.push(<span class="hljs-string">'@each'</span>);
      path = nextToken();
      attrs = [];
      <span class="hljs-keyword">var</span> itr = <span class="hljs-number">0</span>;
      <span class="hljs-keyword">while</span>(path.type.type !== <span class="hljs-string">')'</span>){
        <span class="hljs-keyword">if</span>(path.value){
          <span class="hljs-keyword">if</span>(itr%<span class="hljs-number">2</span> === <span class="hljs-number">0</span>){
            attrs.push(path.value);
          }
          itr++;
        }
        path = nextToken();
      }
      workingpath.push(attrs);
    }

    <span class="hljs-keyword">if</span>(listening &amp;&amp; (_.indexOf(TERMINATORS, token.type.type) &gt; -<span class="hljs-number">1</span> || _.indexOf(TERMINATORS, token.value) &gt; -<span class="hljs-number">1</span>)){
      workingpath = _.reduce(workingpath, reduceMemos, [<span class="hljs-string">''</span>]);
      finishedPaths = _.compact(_.union(finishedPaths, workingpath));
      workingpath = [];
      listening--;
    }

  } <span class="hljs-keyword">while</span>(token.start !== token.end);

  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'COMPUTED PROPERTY'</span>, name, <span class="hljs-string">'registered with these dependancy paths:'</span>, finishedPaths);</pre></div></div>
            
        </li>
        
        
        <li id="section-289">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-289">&#182;</a>
              </div>
              <p>Save our finished paths directly on the function</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  prop.__params = finishedPaths;</pre></div></div>
            
        </li>
        
        
        <li id="section-290">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-290">&#182;</a>
              </div>
              <p>Return the dependancies list</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">return</span> finishedPaths;

}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> { compile: compile };</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
