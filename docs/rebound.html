<!DOCTYPE html>

<html>
<head>
  <title>rebound.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>rebound.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <pre><code>Rebound.js v%VER%
</code></pre>
            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <pre><code>(c) <span class="hljs-number">2015</span> Adam Miller
Rebound may be freely distributed under the MIT license.
For all details and documentation:
http:<span class="hljs-comment">//reboundjs.com</span>
</code></pre>
            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <h2 id="rebound-runtime">Rebound Runtime</h2>

            </div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Import Backbone</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">import</span> Backbone <span class="hljs-keyword">from</span> <span class="hljs-string">"backbone"</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Load our <strong>Utils</strong>, helper environment, <strong>Rebound Data</strong>,
<strong>Rebound Components</strong> and the <strong>Rebound Router</strong></p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">import</span> utils <span class="hljs-keyword">from</span> <span class="hljs-string">"rebound-utils/rebound-utils"</span>;
<span class="hljs-keyword">import</span> { Model, Collection, ComputedProperty } <span class="hljs-keyword">from</span> <span class="hljs-string">"rebound-data/rebound-data"</span>;
<span class="hljs-keyword">import</span> { services, Router } <span class="hljs-keyword">from</span> <span class="hljs-string">"rebound-router/rebound-router"</span>;
<span class="hljs-keyword">import</span> { registerHelper, registerPartial } <span class="hljs-keyword">from</span> <span class="hljs-string">"rebound-htmlbars/rebound-htmlbars"</span>;
<span class="hljs-keyword">import</span> { ComponentFactory, registerComponent } <span class="hljs-keyword">from</span> <span class="hljs-string">"rebound-component/factory"</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Because of our bundle and how it plays with Backbone’s UMD header, we need to
be a little more explicit with out DOM library search.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Backbone.$ = <span class="hljs-built_in">window</span>.$;</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>If Backbone doesn’t have an ajax method from an external DOM library, use ours</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Backbone.ajax = Backbone.$ &amp;&amp; Backbone.$.ajax &amp;&amp; Backbone.ajax || utils.ajax;</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Fetch Rebound’s Config Object from Rebound’s <code>script</code> tag</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> Config = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'Rebound'</span>);
    Config = (Config) ? <span class="hljs-built_in">JSON</span>.parse(Config.innerHTML) : <span class="hljs-literal">false</span>;


<span class="hljs-keyword">var</span> Rebound = <span class="hljs-built_in">window</span>.Rebound = {
  version: <span class="hljs-string">'%VER%'</span>,
  testing: (<span class="hljs-built_in">window</span>.Rebound &amp;&amp; <span class="hljs-built_in">window</span>.Rebound.testing) || (Config &amp;&amp; Config.testing) || <span class="hljs-literal">false</span>,

  registerHelper: registerHelper,
  registerPartial: registerPartial,
  registerComponent: registerComponent,

  Component: ComponentFactory,
  Model: Model,
  Collection: Collection,
  ComputedProperty: ComputedProperty,

  history: Backbone.history,
  services: services,
  start: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">start</span>(<span class="hljs-params">options</span>)</span>{
    <span class="hljs-keyword">var</span> R = <span class="hljs-keyword">this</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">resolve, reject</span>)</span>{
      <span class="hljs-keyword">var</span> run = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
        <span class="hljs-keyword">if</span>(!<span class="hljs-built_in">document</span>.body){ <span class="hljs-keyword">return</span> setTimeout(run.bind(R), <span class="hljs-number">1</span>); }
        <span class="hljs-keyword">delete</span> R.router;
        R.router = <span class="hljs-keyword">new</span> Router(options, resolve);
      };
      run();
    });
  },
  stop: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">stop</span>(<span class="hljs-params"></span>)</span>{
    <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>.router) <span class="hljs-keyword">return</span> <span class="hljs-built_in">console</span>.error(<span class="hljs-string">'No running Rebound router found!'</span>);
    <span class="hljs-keyword">this</span>.router.stop();
  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Start the router if a config object is preset</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">if</span>(Config){ Rebound.start(Config); }

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> Rebound;</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <h2 id="rebound-data">Rebound Data</h2>

            </div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>These are methods inherited by all Rebound data types: <strong>Models</strong>,
<strong>Collections</strong> and <strong>Computed Properties</strong>. Controls tree ancestry
tracking, deep event propagation and tree destruction.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">import</span> Model <span class="hljs-keyword">from</span> <span class="hljs-string">"rebound-data/model"</span>;
<span class="hljs-keyword">import</span> Collection <span class="hljs-keyword">from</span> <span class="hljs-string">"rebound-data/collection"</span>;
<span class="hljs-keyword">import</span> ComputedProperty <span class="hljs-keyword">from</span> <span class="hljs-string">"rebound-data/computed-property"</span>;
<span class="hljs-keyword">import</span> $ <span class="hljs-keyword">from</span> <span class="hljs-string">"rebound-utils/rebound-utils"</span>;

<span class="hljs-keyword">var</span> sharedMethods = {</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>When a change event propagates up the tree it modifies the path part of
<code>change:&lt;path&gt;</code> to reflect the fully qualified path relative to that object.
Ex: Would trigger <code>change:val</code>, <code>change:[0].val</code>, <code>change:arr[0].val</code> and <code>obj.arr[0].val</code>
on each parent as it is propagated up the tree.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  propagateEvent: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">type, model</span>)</span>{
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.__parent__ === <span class="hljs-keyword">this</span> || type === <span class="hljs-string">'dirty'</span>){ <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>; }
    <span class="hljs-keyword">if</span>(type.indexOf(<span class="hljs-string">'change:'</span>) === <span class="hljs-number">0</span> &amp;&amp; model.isModel){
      <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.isCollection &amp;&amp; ~type.indexOf(<span class="hljs-string">'change:['</span>)){ <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>; }
      <span class="hljs-keyword">var</span> key,
          path = model.__path().replace(<span class="hljs-keyword">this</span>.__parent__.__path(), <span class="hljs-string">''</span>).replace(<span class="hljs-regexp">/^\./</span>, <span class="hljs-string">''</span>),
          changed = model.changedAttributes();

      <span class="hljs-keyword">for</span>(key <span class="hljs-keyword">in</span> changed){</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>TODO: Modifying arguments array is bad. change this</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-built_in">arguments</span>[<span class="hljs-number">0</span>] = (<span class="hljs-string">'change:'</span> + path + (path &amp;&amp; <span class="hljs-string">'.'</span>) + key); <span class="hljs-comment">// jshint ignore:line</span>
        <span class="hljs-keyword">this</span>.__parent__.trigger.apply(<span class="hljs-keyword">this</span>.__parent__, <span class="hljs-built_in">arguments</span>);
      }
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.__parent__.trigger.apply(<span class="hljs-keyword">this</span>.__parent__, <span class="hljs-built_in">arguments</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Set this data object’s parent to <code>parent</code> and, as long as a data object is
not its own parent, propagate every event triggered on <code>this</code> up the tree.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  setParent: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">parent</span>)</span>{
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.__parent__){ <span class="hljs-keyword">this</span>.off(<span class="hljs-string">'all'</span>, <span class="hljs-keyword">this</span>.propagateEvent); }
    <span class="hljs-keyword">this</span>.__parent__ = parent;
    <span class="hljs-keyword">this</span>._hasAncestry = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">if</span>(parent !== <span class="hljs-keyword">this</span>){ <span class="hljs-keyword">this</span>.on(<span class="hljs-string">'all'</span>, <span class="hljs-keyword">this</span>.__parent__.propagateEvent); }
    <span class="hljs-keyword">return</span> parent;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Recursively set a data tree’s root element starting with <code>this</code> to the deepest child.
TODO: I dont like this recursively setting elements root when one element’s root changes. Fix this.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  setRoot: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">root</span>)</span>{
    <span class="hljs-keyword">var</span> obj = <span class="hljs-keyword">this</span>;
    obj.__root__ = root;
    <span class="hljs-keyword">var</span> val = obj.models ||  obj.attributes || obj.cache;
    _.each(val, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">value, key</span>)</span>{
      <span class="hljs-keyword">if</span>(value &amp;&amp; value.isData){
        value.setRoot(root);
      }
    });
    <span class="hljs-keyword">return</span> root;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Tests to see if <code>this</code> has a parent <code>obj</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  hasParent: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">obj</span>)</span>{
    <span class="hljs-keyword">var</span> tmp = <span class="hljs-keyword">this</span>;
    <span class="hljs-keyword">while</span>(tmp !== obj){
      tmp = tmp.__parent__;
      <span class="hljs-keyword">if</span>(_.isUndefined(tmp)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
      <span class="hljs-keyword">if</span>(tmp === obj) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
      <span class="hljs-keyword">if</span>(tmp.__parent__ === tmp) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>De-initializes a data tree starting with <code>this</code> and recursively calling <code>deinitialize()</code> on each child.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  deinitialize: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Undelegate Backbone Events from this data object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.undelegateEvents){ <span class="hljs-keyword">this</span>.undelegateEvents(); }
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.stopListening){ <span class="hljs-keyword">this</span>.stopListening(); }
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.off){ <span class="hljs-keyword">this</span>.off(); }
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.unwire){ <span class="hljs-keyword">this</span>.unwire(); }</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Destroy this data object’s lineage</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.__parent__;
    <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.__root__;
    <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.__path;</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>If there is a dom element associated with this data object, destroy all listeners associated with it.
Remove all event listeners from this dom element, recursively remove element lazyvalues,
and then remove the element referance itself.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.el){
      _.each(<span class="hljs-keyword">this</span>.el.__listeners, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">handler, eventType</span>)</span>{
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.el.removeEventListener){ <span class="hljs-keyword">this</span>.el.removeEventListener(eventType, handler, <span class="hljs-literal">false</span>); }
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.el.detachEvent){ <span class="hljs-keyword">this</span>.el.detachEvent(<span class="hljs-string">'on'</span>+eventType, handler); }
      }, <span class="hljs-keyword">this</span>);
      $(<span class="hljs-keyword">this</span>.el).walkTheDOM(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">el</span>)</span>{
        <span class="hljs-keyword">if</span>(el.__lazyValue &amp;&amp; el.__lazyValue.destroy()){ n.__lazyValue.destroy(); }
      });
      <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.el.__listeners;
      <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.el.__events;
      <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.$el;
      <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.el;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Clean up Hook callback references</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.__observers;</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Mark as deinitialized so we don’t loop on cyclic dependancies.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.deinitialized = <span class="hljs-literal">true</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Destroy all children of this data object.
If a Collection, de-init all of its Models, if a Model, de-init all of its
Attributes that aren’t services, if a Computed Property, de-init its Cache objects.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    _.each(<span class="hljs-keyword">this</span>.models, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">val</span>)</span>{ val &amp;&amp; val.deinitialize &amp;&amp; val.deinitialize(); });
    <span class="hljs-keyword">this</span>.models &amp;&amp; (<span class="hljs-keyword">this</span>.models.length = <span class="hljs-number">0</span>);
    _.each(<span class="hljs-keyword">this</span>.attributes, (val, key) =&gt; {
      <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.attributes[key];
      val &amp;&amp; !val.isComponent &amp;&amp; val.deinitialize &amp;&amp; val.deinitialize();
    });
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.cache){
      <span class="hljs-keyword">this</span>.cache.collection.deinitialize();
      <span class="hljs-keyword">this</span>.cache.model.deinitialize();
    }
  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Extend all of the <strong>Rebound Data</strong> prototypes with these shared methods</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>_.extend(Model.prototype, sharedMethods);
_.extend(Collection.prototype, sharedMethods);
_.extend(ComputedProperty.prototype, sharedMethods);

<span class="hljs-keyword">export</span> { Model <span class="hljs-keyword">as</span> Model };
<span class="hljs-keyword">export</span> { Collection <span class="hljs-keyword">as</span> Collection };
<span class="hljs-keyword">export</span> { ComputedProperty <span class="hljs-keyword">as</span> ComputedProperty };
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> { Model, Collection, ComputedProperty };</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <h2 id="rebound-model">Rebound Model</h2>

            </div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>Rebound <strong>Models</strong> are the basic data object in the framework - frequently
representing a row in a table in a database on your server. The inherit from
Backbone Models and have all of the same useful methods you are used to for
performing computations and transformations on that data. Rebound augments
Backbone Models by enabling deep data nesting. You can now have <strong>Rebound Collections</strong>
and <strong>Rebound Computed Properties</strong> as properties of the Model.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">import</span> Backbone <span class="hljs-keyword">from</span> <span class="hljs-string">"backbone"</span>;
<span class="hljs-keyword">import</span> ComputedProperty <span class="hljs-keyword">from</span> <span class="hljs-string">"rebound-data/computed-property"</span>;
<span class="hljs-keyword">import</span> $ <span class="hljs-keyword">from</span> <span class="hljs-string">"rebound-utils/rebound-utils"</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>Returns a function that, when called, generates a path constructed from its
parent’s path and the key it is assigned to. Keeps us from re-naming children
when parents change.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">pathGenerator</span>(<span class="hljs-params">parent, key</span>)</span>{
  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
    <span class="hljs-keyword">var</span> path = parent.__path();
    <span class="hljs-keyword">return</span> path + ((path === <span class="hljs-string">''</span>) ? <span class="hljs-string">''</span> : <span class="hljs-string">'.'</span>) + key;
  };
}

<span class="hljs-keyword">var</span> Model = Backbone.Model.extend({</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>Set this object’s data types</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  isModel: <span class="hljs-literal">true</span>,
  isData: <span class="hljs-literal">true</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>A method that returns a root path by default. Meant to be overridden on
instantiation.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  __path: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{ <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>; },</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>Create a new Model with the specified attributes. The Model’s lineage is set
up here to keep track of it’s place in the data tree.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">constructor</span>: function(attributes, options={}){
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
    <span class="hljs-keyword">if</span>(attributes === <span class="hljs-literal">null</span> || attributes === <span class="hljs-literal">undefined</span>){ attributes = {}; }
    attributes.isModel &amp;&amp; (attributes = attributes.attributes);
    <span class="hljs-keyword">this</span>.helpers = {};
    <span class="hljs-keyword">this</span>.defaults = <span class="hljs-keyword">this</span>.defaults || {};
    <span class="hljs-keyword">this</span>.setParent( options.parent || <span class="hljs-keyword">this</span> );
    <span class="hljs-keyword">this</span>.setRoot( options.root || <span class="hljs-keyword">this</span> );
    <span class="hljs-keyword">this</span>.__path = options.path || <span class="hljs-keyword">this</span>.__path;</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>Convert getters and setters to computed properties</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    $.extractComputedProps(attributes);

    Backbone.Model.call( <span class="hljs-keyword">this</span>, attributes, options );

  },</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>New convenience function to toggle boolean values in the Model.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  toggle: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">attr, options</span>) </span>{
    options = options ? _.clone(options) : {};
    <span class="hljs-keyword">var</span> val = <span class="hljs-keyword">this</span>.get(attr);
    <span class="hljs-keyword">if</span>(!_.isBoolean(val)) <span class="hljs-built_in">console</span>.error(<span class="hljs-string">'Tried to toggle non-boolean value '</span> + attr +<span class="hljs-string">'!'</span>, <span class="hljs-keyword">this</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.set(attr, !val, options);
  },

  destroy: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">options</span>) </span>{
    options = options ? _.clone(options) : {};
    <span class="hljs-keyword">var</span> model = <span class="hljs-keyword">this</span>;
    <span class="hljs-keyword">var</span> success = options.success;
    <span class="hljs-keyword">var</span> wait = options.wait;

    <span class="hljs-keyword">var</span> destroy = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      model.trigger(<span class="hljs-string">'destroy'</span>, model, model.collection, options);
    };

    options.success = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">resp</span>) </span>{
      <span class="hljs-keyword">if</span> (wait){ destroy(); }
      <span class="hljs-keyword">if</span> (success){ success.call(options.context, model, resp, options); }
      <span class="hljs-keyword">if</span> (!model.isNew()){ model.trigger(<span class="hljs-string">'sync'</span>, model, resp, options); }
    };

    <span class="hljs-keyword">var</span> xhr = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isNew()) {
      _.defer(options.success);
    } <span class="hljs-keyword">else</span> {
      wrapError(<span class="hljs-keyword">this</span>, options);
      xhr = <span class="hljs-keyword">this</span>.sync(<span class="hljs-string">'delete'</span>, <span class="hljs-keyword">this</span>, options);
    }
    <span class="hljs-keyword">if</span> (!wait){ destroy(); }
    <span class="hljs-keyword">return</span> xhr;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>Model Reset does a deep reset on the data tree starting at this Model.
A <code>previousAttributes</code> property is set on the <code>options</code> property with the Model’s
old values.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  reset: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">obj, options</span>)</span>{
    <span class="hljs-keyword">var</span> changed = {}, key, value;
    options || (options = {});
    options.reset = <span class="hljs-literal">true</span>;
    obj = (obj &amp;&amp; obj.isModel &amp;&amp; obj.attributes) || obj || {};
    options.previousAttributes = _.clone(<span class="hljs-keyword">this</span>.attributes);</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>Any unset previously existing values will be set back to default</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    _.each(<span class="hljs-keyword">this</span>.defaults, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">val, key</span>)</span>{
      <span class="hljs-keyword">if</span>(!obj.hasOwnProperty(key)){ obj[key] = val; }
    }, <span class="hljs-keyword">this</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>Iterate over the Model’s attributes:</p>
<ul>
<li>If the property is the <code>idAttribute</code>, skip.</li>
<li>If the properties are already the same, skip</li>
<li>If the property is currently undefined and being changed, assign</li>
<li>If the property is a <code>Model</code>, <code>Collection</code>, or <code>ComputedProperty</code>, reset it.</li>
<li>If the passed object has the property, set it to the new value.</li>
<li>If the Model has a default value for this property, set it back to default.</li>
<li>Otherwise, unset the attribute.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">for</span>(key <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span>.attributes){
      value = <span class="hljs-keyword">this</span>.attributes[key];
      <span class="hljs-keyword">if</span>(value === obj[key]){ <span class="hljs-keyword">continue</span>; }
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(_.isUndefined(value) &amp;&amp; !_.isUndefined(obj[key])){ changed[key] = obj[key]; }
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (value.isComponent){ <span class="hljs-keyword">continue</span>; }
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (value.isCollection || value.isModel || value.isComputedProperty){
        value.reset((obj[key] || []), {silent: <span class="hljs-literal">true</span>});
        <span class="hljs-keyword">if</span>(value.isCollection) changed[key] = value.previousModels;
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(value.isModel &amp;&amp; value.isComputedProperty) changed[key] = value.cache.model.changedAttributes();
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(value.isModel) changed[key] = value.changedAttributes();
      }
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (obj.hasOwnProperty(key)){ changed[key] = obj[key]; }
      <span class="hljs-keyword">else</span>{
        changed[key] = <span class="hljs-literal">undefined</span>;
        <span class="hljs-keyword">this</span>.unset(key, {silent: <span class="hljs-literal">true</span>});
      }
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>Any new values will be set to on the model</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    _.each(obj, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">val, key</span>)</span>{
      <span class="hljs-keyword">if</span>(_.isUndefined(changed[key])){ changed[key] = val; }
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>Reset our model</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    obj = <span class="hljs-keyword">this</span>.set(obj, _.extend({}, options, {silent: <span class="hljs-literal">true</span>, reset: <span class="hljs-literal">false</span>}));</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>Trigger custom reset event</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.changed = changed;
    <span class="hljs-keyword">if</span> (!options.silent){ <span class="hljs-keyword">this</span>.trigger(<span class="hljs-string">'reset'</span>, <span class="hljs-keyword">this</span>, options); }</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>Return new values</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">return</span> obj;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p><strong>Model.Get</strong> is overridden to provide support for getting from a deep data tree.
<code>key</code> may now be any valid json-like identifier. Ex: <code>obj.coll[3].value</code>.
It needs to traverse <code>Models</code>, <code>Collections</code> and <code>Computed Properties</code> to
find the correct value.</p>
<ul>
<li>If key is undefined, return <code>undefined</code>.</li>
<li>If key is empty string, return <code>this</code>.</li>
</ul>
<p>For each part:</p>
<ul>
<li>If a <code>Computed Property</code> and <code>options.raw</code> is true, return it.</li>
<li>If a <code>Computed Property</code> traverse to its value.</li>
<li>If not set, return its falsy value.</li>
<li>If a <code>Model</code> or <code>Collection</code>, traverse to it.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  get: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">key, options</span>)</span>{
    options || (options = {});
    <span class="hljs-keyword">var</span> parts  = $.splitPath(key),
        result = <span class="hljs-keyword">this</span>,
        i, l=parts.length;

    <span class="hljs-keyword">if</span>(_.isUndefined(key) || _.isNull(key)){ <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>; }
    <span class="hljs-keyword">if</span>(key === <span class="hljs-string">''</span> || parts.length === <span class="hljs-number">0</span>){ <span class="hljs-keyword">return</span> result; }

    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; l; i++) {
      <span class="hljs-keyword">if</span>(result &amp;&amp; result.isComputedProperty &amp;&amp; options.raw) <span class="hljs-keyword">return</span> result;
      <span class="hljs-keyword">if</span>(result &amp;&amp; result.isComputedProperty) result = result.value();
      <span class="hljs-keyword">if</span>(_.isUndefined(result) || _.isNull(result)) <span class="hljs-keyword">return</span> result;
      <span class="hljs-keyword">if</span>(parts[i] === <span class="hljs-string">'@parent'</span>) result = result.__parent__;
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(result.isCollection) result = result.models[parts[i]];
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(result.isModel) result = result.attributes[parts[i]];
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(result &amp;&amp; result.hasOwnProperty(parts[i])) result = result[parts[i]];
    }

    <span class="hljs-keyword">if</span>(result &amp;&amp; result.isComputedProperty &amp;&amp; !options.raw) result = result.value();
    <span class="hljs-keyword">return</span> result;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p><strong>Model.Set</strong> is overridden to provide support for getting from a deep data tree.
<code>key</code> may now be any valid json-like identifier. Ex: <code>obj.coll[3].value</code>.
It needs to traverse <code>Models</code>, <code>Collections</code> and <code>Computed Properties</code> to
find the correct value to call the original <code>Backbone.Set</code> on.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  set: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">key, value, options</span>)</span>{

    <span class="hljs-keyword">var</span> attrs, newKey, destination, props = [];

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> key === <span class="hljs-string">'object'</span>) {
      attrs = (key.isModel) ? key.attributes : key;
      options = value;
    }
    <span class="hljs-keyword">else</span> (attrs = {})[key] = value;
    options || (options = {});</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>Convert getters and setters to computed properties</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    $.extractComputedProps(attrs);</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>If reset option passed, do a reset. If nothing passed, return.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(options.reset === <span class="hljs-literal">true</span>) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.reset(attrs, options);
    <span class="hljs-keyword">if</span>(options.defaults === <span class="hljs-literal">true</span>) <span class="hljs-keyword">this</span>.defaults = attrs;
    <span class="hljs-keyword">if</span>(_.isEmpty(attrs)){ <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>; }</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>For each attribute passed:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">for</span>(key <span class="hljs-keyword">in</span> attrs){
      <span class="hljs-keyword">let</span> val = attrs[key],
          paths = $.splitPath(key),
          attr  = (paths.pop() || <span class="hljs-string">''</span>),       <span class="hljs-comment">// The key          ex: foo[0].bar --&gt; bar</span>
          target = <span class="hljs-keyword">this</span>.get(paths.join(<span class="hljs-string">'.'</span>)),  <span class="hljs-comment">// The element    ex: foo.bar.baz --&gt; foo.bar</span>
          lineage;</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>If target currently doesnt exist, construct its tree</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span>(_.isUndefined(target)){
        target = <span class="hljs-keyword">this</span>;
        _.each(paths, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">part</span>)</span>{
          <span class="hljs-keyword">var</span> tmp = target.get(part);
          <span class="hljs-keyword">if</span>(_.isUndefined(tmp)) tmp = target.set(part, {}).get(part);
          target = tmp;
        }, <span class="hljs-keyword">this</span>);
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>The old value of <code>attr</code> in <code>target</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      destination = target.get(attr, {raw: <span class="hljs-literal">true</span>}) || {};</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>Create this new object’s lineage.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      lineage = {
        name: key,
        parent: target,
        root: <span class="hljs-keyword">this</span>.__root__,
        path: pathGenerator(target, attr),
        silent: <span class="hljs-literal">true</span>,
        defaults: options.defaults
      };</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <ul>
<li>If val is <code>null</code> or <code>undefined</code>, set to default value.</li>
<li>If val is a <code>Computed Property</code>, get its current cache object.</li>
<li>If val (default value or evaluated computed property) is <code>null</code>, set to default value or (fallback <code>undefined</code>).</li>
<li>Else If val is a primitive object instance, convert to primitive value.</li>
<li>Else If <code>{raw: true}</code> option is passed, set the exact object that was passed. No promotion to a Rebound Data object.</li>
<li>Else If this function is the same as the current computed property, continue.</li>
<li>Else If this value is a <code>Function</code>, turn it into a <code>Computed Property</code>.</li>
<li>Else If this is going to be a cyclical dependancy, use the original object, don’t make a copy.</li>
<li>Else If updating an existing object with its respective data type, let Backbone handle the merge.</li>
<li>Else If this value is a <code>Model</code> or <code>Collection</code>, create a new copy of it using its constructor, preserving its defaults while ensuring no shared memory between objects.</li>
<li>Else If this value is an <code>Array</code>, turn it into a <code>Collection</code>.</li>
<li>Else If this value is a <code>Object</code>, turn it into a <code>Model</code>.</li>
<li>Else val is a primitive value, set it accordingly.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>

      <span class="hljs-keyword">if</span>(_.isNull(val) || _.isUndefined(val)) val = <span class="hljs-keyword">this</span>.defaults[key];
      <span class="hljs-keyword">if</span>(val &amp;&amp; val.isComputedProperty) val = val.value();
      <span class="hljs-keyword">if</span>(_.isNull(val) || _.isUndefined(val)) val = <span class="hljs-literal">undefined</span>;
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(val <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">String</span>) val = <span class="hljs-built_in">String</span>(val);
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(val <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Number</span>) val = <span class="hljs-built_in">Number</span>(val);
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(val <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Boolean</span>) val = <span class="hljs-built_in">Boolean</span>(val.valueOf());
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(options.raw === <span class="hljs-literal">true</span>) val = val;
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(destination.isComputedProperty &amp;&amp; destination.func === val) <span class="hljs-keyword">continue</span>;
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(val.isComputedProto) val = <span class="hljs-keyword">new</span> ComputedProperty(val.get, val.set, lineage);
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(val.isData &amp;&amp; target.hasParent(val)) val = val;
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>( destination.isComputedProperty ||
              ( destination.isCollection &amp;&amp; ( _.isArray(val) || val.isCollection )) ||
              ( destination.isModel &amp;&amp; ( _.isObject(val) || val.isModel ))){
        destination.set(val, options);
        <span class="hljs-keyword">continue</span>;
      }
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(val.isData &amp;&amp; options.clone !== <span class="hljs-literal">false</span>) val = <span class="hljs-keyword">new</span> val.constructor(val.attributes || val.models, lineage);
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(_.isArray(val)) val = <span class="hljs-keyword">new</span> Rebound.Collection(val, lineage); <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> Remove global referance</span>
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(_.isObject(val)) val = <span class="hljs-keyword">new</span> Model(val, lineage);</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>If val is a data object, let this object know it is now a parent</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">this</span>._hasAncestry = (val &amp;&amp; val.isData || <span class="hljs-literal">false</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>Set the value</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      Backbone.Model.prototype.set.call(target, attr, val, options); <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> Event cleanup when replacing a model or collection with another value</span>

    }

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;

  },</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>Recursive <code>toJSON</code> function traverses the data tree returning a JSON object.
If there are any cyclic dependancies the object’s <code>cid</code> is used instead of looping infinitely.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  toJSON: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._isSerializing){ <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.id || <span class="hljs-keyword">this</span>.cid; }
    <span class="hljs-keyword">this</span>._isSerializing = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">var</span> json = _.clone(<span class="hljs-keyword">this</span>.attributes);
    _.each(json, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">value, name</span>) </span>{
        <span class="hljs-keyword">if</span>( _.isNull(value) || _.isUndefined(value) ){ <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>; }
        _.isFunction(value.toJSON) &amp;&amp; (json[name] = value.toJSON());
    });
    <span class="hljs-keyword">this</span>._isSerializing = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">return</span> json;
  }

});</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>If default properties are passed into extend, process the computed properties</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Model.extend = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">protoProps, staticProps</span>) </span>{
  $.extractComputedProps(protoProps.defaults);
  <span class="hljs-keyword">return</span> Backbone.Model.extend.call(<span class="hljs-keyword">this</span>, protoProps, staticProps);
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> Model;</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <h2 id="rebound-collection">Rebound Collection</h2>

            </div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">import</span> Backbone <span class="hljs-keyword">from</span> <span class="hljs-string">"backbone"</span>;
<span class="hljs-keyword">import</span> Model <span class="hljs-keyword">from</span> <span class="hljs-string">"rebound-data/model"</span>;
<span class="hljs-keyword">import</span> $ <span class="hljs-keyword">from</span> <span class="hljs-string">"rebound-utils/rebound-utils"</span>;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">pathGenerator</span>(<span class="hljs-params">collection</span>)</span>{
  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
    <span class="hljs-keyword">return</span> collection.__path() + <span class="hljs-string">'['</span> + collection.indexOf(collection._byId[<span class="hljs-keyword">this</span>.cid]) + <span class="hljs-string">']'</span>;
  };
}

<span class="hljs-keyword">var</span> Collection = Backbone.Collection.extend({

  isCollection: <span class="hljs-literal">true</span>,
  isData: <span class="hljs-literal">true</span>,

  model: Model,

  __path: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{<span class="hljs-keyword">return</span> <span class="hljs-string">''</span>;},

  <span class="hljs-keyword">constructor</span>: function(models, options){
    models || (models = []);
    options || (options = {});
    <span class="hljs-keyword">this</span>._byValue = {};
    <span class="hljs-keyword">this</span>.helpers = {};
    <span class="hljs-keyword">this</span>.cid = $.uniqueId(<span class="hljs-string">'collection'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>Set lineage</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.setParent( options.parent || <span class="hljs-keyword">this</span> );
    <span class="hljs-keyword">this</span>.setRoot( options.root || <span class="hljs-keyword">this</span> );
    <span class="hljs-keyword">this</span>.__path = options.path || <span class="hljs-keyword">this</span>.__path;

    Backbone.Collection.apply( <span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span> );</pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>When a model is removed from its original collection, destroy it
TODO: Fix this. Computed properties now somehow allow collection to share a model. They may be removed from one but not the other. That is bad.
The clone = false options is the culprit. Find a better way to copy all of the collections custom attributes over to the clone.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.on(<span class="hljs-string">'remove'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">model, collection, options</span>)</span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>model.deinitialize();</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    });

  },

  get: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">key, options</span>)</span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p>Split the path at all ‘.’, ‘[‘ and ‘]’ and find the value referanced.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> parts = _.isString(key) ? $.splitPath(key) : [],
        result = <span class="hljs-keyword">this</span>,
        l=parts.length,
        i=<span class="hljs-number">0</span>;
        options || (options = {});</pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p>If the key is a number or object, or just a single string that is not a path,
get by id and return the first occurance</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> key == <span class="hljs-string">'number'</span> || <span class="hljs-keyword">typeof</span> key == <span class="hljs-string">'object'</span> || (parts.length == <span class="hljs-number">1</span> &amp;&amp; !options.isPath)){
      <span class="hljs-keyword">if</span> (key === <span class="hljs-literal">null</span>){ <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>; }
      <span class="hljs-keyword">var</span> id = <span class="hljs-keyword">this</span>.modelId(<span class="hljs-keyword">this</span>._isModel(key) ? key.attributes : key);
      <span class="hljs-keyword">var</span> responses = [].concat(<span class="hljs-keyword">this</span>._byValue[key], (<span class="hljs-keyword">this</span>._byId[key] || <span class="hljs-keyword">this</span>._byId[id] || <span class="hljs-keyword">this</span>._byId[key.cid]));
      <span class="hljs-keyword">var</span> res = responses[<span class="hljs-number">0</span>], idx = <span class="hljs-literal">Infinity</span>;

      responses.forEach((value) =&gt; {
        <span class="hljs-keyword">if</span>(!value){ <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>; }
        <span class="hljs-keyword">let</span> i = _.indexOf(<span class="hljs-keyword">this</span>.models, value);
        <span class="hljs-keyword">if</span>(i &gt; <span class="hljs-number">-1</span> &amp;&amp; i &lt; idx){ idx = i; res = value;}
      });

      <span class="hljs-keyword">return</span> res;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p>If key is not a string, return undefined</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (!_.isString(key)){ <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>; }

    <span class="hljs-keyword">if</span>(_.isUndefined(key) || _.isNull(key)){ <span class="hljs-keyword">return</span> key; }
    <span class="hljs-keyword">if</span>(key === <span class="hljs-string">''</span> || parts.length === <span class="hljs-number">0</span>){ <span class="hljs-keyword">return</span> result; }

    <span class="hljs-keyword">if</span> (parts.length &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>; i &lt; l; i++) {</pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <p>If returning raw, always return the first computed property found. If undefined, you’re done.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span>(result &amp;&amp; result.isComputedProperty &amp;&amp; options.raw) <span class="hljs-keyword">return</span> result;
        <span class="hljs-keyword">if</span>(result &amp;&amp; result.isComputedProperty) result = result.value();
        <span class="hljs-keyword">if</span>(_.isUndefined(result) || _.isNull(result)) <span class="hljs-keyword">return</span> result;
        <span class="hljs-keyword">if</span>(parts[i] === <span class="hljs-string">'@parent'</span>) result = result.__parent__;
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(result.isCollection) result = result.models[parts[i]];
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(result.isModel) result = result.attributes[parts[i]];
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(result.hasOwnProperty(parts[i])) result = result[parts[i]];
      }
    }

    <span class="hljs-keyword">if</span>(result &amp;&amp; result.isComputedProperty &amp;&amp; !options.raw) result = result.value();

    <span class="hljs-keyword">return</span> result;
  },

  set: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">models, options</span>)</span>{
    <span class="hljs-keyword">var</span> newModels = [],
        parts = _.isString(models) ? $.splitPath(models) : [],
        res,
        lineage = {
          parent: <span class="hljs-keyword">this</span>,
          root: <span class="hljs-keyword">this</span>.__root__,
          path: pathGenerator(<span class="hljs-keyword">this</span>),
          silent: <span class="hljs-literal">true</span>
        };
        options = options || {},</pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <p>If no models passed, implies an empty array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    models || (models = []);</pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <p>If models is a string, and it has parts, call set at that path</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(_.isString(models) &amp;&amp; parts.length &gt; <span class="hljs-number">1</span> &amp;&amp; !<span class="hljs-built_in">isNaN</span>(<span class="hljs-built_in">Number</span>(parts[<span class="hljs-number">0</span>]))){
      <span class="hljs-keyword">let</span> index = <span class="hljs-built_in">Number</span>(parts[<span class="hljs-number">0</span>]);
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.at(index).set(parts.splice(<span class="hljs-number">1</span>, parts.length).join(<span class="hljs-string">'.'</span>), options);
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <p>If another collection, treat like an array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    models = (models.isCollection) ? models.models : models;</pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <p>Ensure models is an array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    models = (!_.isArray(models)) ? [models] : models;</pre></div></div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <p>If the model already exists in this collection, or we are told not to clone it, let Backbone handle the merge
Otherwise, create our copy of this model, give them the same cid so our helpers treat them as the same object
Use the more unique of the two constructors. If our Model has a custom constructor, use that. Otherwise, use
Collection default Model constructor.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    _.each(models, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data, index</span>)</span>{
      <span class="hljs-keyword">if</span>(data.isModel &amp;&amp; options.clone === <span class="hljs-literal">false</span> || <span class="hljs-keyword">this</span>._byId[data.cid]) <span class="hljs-keyword">return</span> newModels[index] = data;
      <span class="hljs-keyword">var</span> <span class="hljs-keyword">constructor</span> = (data.<span class="hljs-keyword">constructor</span> !== Object &amp;&amp; data.<span class="hljs-keyword">constructor</span> !== Rebound.Model) ? data.<span class="hljs-keyword">constructor</span> : this.model;
      newModels[index] = new <span class="hljs-keyword">constructor</span>(data, _.defaults(lineage, options));
      data.isModel &amp;&amp; (newModels[index].cid = data.cid);
    }, this);</pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <p>Ensure that this element now knows that it has children now. Without this cyclic dependancies cause issues</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>._hasAncestry || (<span class="hljs-keyword">this</span>._hasAncestry = newModels.length &gt; <span class="hljs-number">0</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              <p>Call original set function with model duplicates</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">return</span> Backbone.Collection.prototype.set.call(<span class="hljs-keyword">this</span>, newModels, options);

  }

});

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> Collection;</pre></div></div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              <h2 id="rebound-computed-property">Rebound Computed Property</h2>

            </div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">import</span> Backbone <span class="hljs-keyword">from</span> <span class="hljs-string">"backbone"</span>;
<span class="hljs-keyword">import</span> propertyCompiler <span class="hljs-keyword">from</span> <span class="hljs-string">"property-compiler/property-compiler"</span>;
<span class="hljs-keyword">import</span> $ <span class="hljs-keyword">from</span> <span class="hljs-string">"rebound-utils/rebound-utils"</span>;

<span class="hljs-keyword">var</span> NOOP = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{ <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>; };

<span class="hljs-keyword">var</span> TO_CALL = [];
<span class="hljs-keyword">var</span> CALL_TIMEOUT;</pre></div></div>
            
        </li>
        
        
        <li id="section-73">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-73">&#182;</a>
              </div>
              <p>Returns true if str starts with test</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">startsWith</span>(<span class="hljs-params">str, test</span>)</span>{
  <span class="hljs-keyword">if</span>(str === test){ <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; }
  <span class="hljs-keyword">return</span> str.substring(<span class="hljs-number">0</span>, test.length+<span class="hljs-number">1</span>) === test+<span class="hljs-string">'.'</span>;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-74">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-74">&#182;</a>
              </div>
              <p>Push all elements in <code>arr</code> to the end of an array. Mark all Computed Properties
as dirty on their way in.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">push</span>(<span class="hljs-params">arr</span>)</span>{
  <span class="hljs-keyword">var</span> i, len = arr.length;
  <span class="hljs-keyword">this</span>.added || (<span class="hljs-keyword">this</span>.added = {});
  <span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>;i&lt;len;i++){
    arr[i].markDirty();
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.added[arr[i].cid]) <span class="hljs-keyword">continue</span>;
    <span class="hljs-keyword">this</span>.added[arr[i].cid] = <span class="hljs-number">1</span>;
    <span class="hljs-keyword">this</span>.push(arr[i]);
  }
}</pre></div></div>
            
        </li>
        
        
        <li id="section-75">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-75">&#182;</a>
              </div>
              <p>Called after callstack is exausted to call all of this computed property’s
dependants that need to be recomputed</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">recomputeCallback</span>(<span class="hljs-params"></span>)</span>{
  <span class="hljs-keyword">var</span> len = TO_CALL.length;
  CALL_TIMEOUT = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">while</span>(len--){
    (TO_CALL.shift() || NOOP).call();
  }

  TO_CALL.added = {};
}

<span class="hljs-keyword">var</span> ComputedProperty = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">getter, setter, options={}</span>)</span>{

  <span class="hljs-keyword">if</span>(!_.isFunction(getter) &amp;&amp; !_.isFunction(setter)){
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">console</span>.error(<span class="hljs-string">'ComputedProperty constructor must be passed getter and setter functions!'</span>, getter, <span class="hljs-string">'and'</span>, setter, <span class="hljs-string">'Found instead.'</span>);
  }

  <span class="hljs-keyword">this</span>.cid = $.uniqueId(<span class="hljs-string">'computedPropety'</span>);
  <span class="hljs-keyword">this</span>.name = options.name;
  <span class="hljs-keyword">this</span>.returnType = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">this</span>.waiting = {};

  <span class="hljs-keyword">this</span>.isChanging = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">this</span>.isDirty = <span class="hljs-literal">true</span>;
  _.bindAll(<span class="hljs-keyword">this</span>, <span class="hljs-string">'onModify'</span>, <span class="hljs-string">'markDirty'</span>);

  <span class="hljs-keyword">if</span>(getter){ <span class="hljs-keyword">this</span>.getter = getter; }
  <span class="hljs-keyword">if</span>(setter){ <span class="hljs-keyword">this</span>.setter = setter; }
  <span class="hljs-keyword">this</span>.deps = propertyCompiler.compile(<span class="hljs-keyword">this</span>.getter, <span class="hljs-keyword">this</span>.name);</pre></div></div>
            
        </li>
        
        
        <li id="section-76">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-76">&#182;</a>
              </div>
              <p>Create lineage to pass to our cache objects</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> lineage = {
    parent: <span class="hljs-keyword">this</span>.setParent( options.parent || <span class="hljs-keyword">this</span> ),
    root: <span class="hljs-keyword">this</span>.setRoot( options.root || options.parent || <span class="hljs-keyword">this</span> ),
    path: <span class="hljs-keyword">this</span>.__path = options.path || <span class="hljs-keyword">this</span>.__path
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-77">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-77">&#182;</a>
              </div>
              <p>Results Cache Objects
These data objects will never be re-created for the lifetime of the Computed Proeprty
On Recompute they are updated with new values.
On Change their new values are pushed to the object it is tracking</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">this</span>.cache = {
    model: <span class="hljs-keyword">new</span> Rebound.Model({}, lineage),
    collection: <span class="hljs-keyword">new</span> Rebound.Collection([], lineage),
    value: <span class="hljs-literal">undefined</span>
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-78">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-78">&#182;</a>
              </div>
              <p>Listen to objects in the cache and push changes to them on modify</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">this</span>.listenTo(<span class="hljs-keyword">this</span>.cache.model, <span class="hljs-string">'all'</span>, <span class="hljs-keyword">this</span>.onModify);
  <span class="hljs-keyword">this</span>.listenTo(<span class="hljs-keyword">this</span>.cache.collection, <span class="hljs-string">'all'</span>, <span class="hljs-keyword">this</span>.onModify);

  <span class="hljs-keyword">this</span>.wire();

};

_.extend(ComputedProperty.prototype, Backbone.Events, {

  isComputedProperty: <span class="hljs-literal">true</span>,
  isData: <span class="hljs-literal">true</span>,
  __path: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{ <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>; },

  getter: NOOP,
  setter: NOOP,</pre></div></div>
            
        </li>
        
        
        <li id="section-79">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-79">&#182;</a>
              </div>
              <p>If the Computed Property is not already dirty, mark it as such and trigger
a <code>dirty</code> event.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  markDirty: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.isDirty){ <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>; }
    <span class="hljs-keyword">this</span>.isDirty = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">this</span>.trigger(<span class="hljs-string">'dirty'</span>, <span class="hljs-keyword">this</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-80">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-80">&#182;</a>
              </div>
              <p>Attached to listen to all events where this Computed Property’s dependancies
are stored. See wire(). Will re-evaluate any computed properties that
depend on the changed data value which triggered this callback.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  onRecompute: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">type, model, collection, options</span>)</span>{
    <span class="hljs-keyword">var</span> shortcircuit = { change: <span class="hljs-number">1</span>, sort: <span class="hljs-number">1</span>, request: <span class="hljs-number">1</span>, destroy: <span class="hljs-number">1</span>, sync: <span class="hljs-number">1</span>, error: <span class="hljs-number">1</span>, invalid: <span class="hljs-number">1</span>, route: <span class="hljs-number">1</span>, dirty: <span class="hljs-number">1</span> };
    <span class="hljs-keyword">if</span>( shortcircuit[type] || !model.isData ){ <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>; }
    model || (model = {});
    collection || (collection = {});
    options || (options = {});
    !collection.isData &amp;&amp; (options = collection) &amp;&amp; (collection = model);
    <span class="hljs-keyword">var</span> path, vector;</pre></div></div>
            
        </li>
        
        
        <li id="section-81">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-81">&#182;</a>
              </div>
              <p>Compute the path to this data object that triggered the event
TODO: Figure out a better way to prefix service data paths with their local path name</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    vector = path = ((options.service) ? <span class="hljs-string">`<span class="hljs-subst">${options.service}</span>.`</span>: <span class="hljs-string">''</span>) + collection.__path().replace(<span class="hljs-regexp">/\.?\[.*\]/ig</span>, <span class="hljs-string">'.@each'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-82">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-82">&#182;</a>
              </div>
              <p>If a reset event on a Model, check for computed properties that depend
on each changed attribute’s full path.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(type === <span class="hljs-string">'reset'</span> &amp;&amp; options.previousAttributes){
      _.each(options.previousAttributes, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">value, key</span>)</span>{
        vector = path + (path &amp;&amp; <span class="hljs-string">'.'</span>) + key;
        _.each(<span class="hljs-keyword">this</span>.__computedDeps, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">dependants, dependancy</span>)</span>{
          startsWith(vector, dependancy) &amp;&amp; push.call(TO_CALL, dependants);
        }, <span class="hljs-keyword">this</span>);
      }, <span class="hljs-keyword">this</span>);
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-83">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-83">&#182;</a>
              </div>
              <p>If a reset event on a Collction, check for computed properties that depend
on anything inside that collection.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(type === <span class="hljs-string">'reset'</span> &amp;&amp; options.previousModels){
      _.each(<span class="hljs-keyword">this</span>.__computedDeps, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">dependants, dependancy</span>)</span>{
        startsWith(dependancy, vector) &amp;&amp; push.call(TO_CALL, dependants);
      }, <span class="hljs-keyword">this</span>);
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-84">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-84">&#182;</a>
              </div>
              <p>If an add or remove event, check for computed properties that depend on
anything inside that collection or that contains that collection.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(type === <span class="hljs-string">'add'</span> || type === <span class="hljs-string">'remove'</span>){
      _.each(<span class="hljs-keyword">this</span>.__computedDeps, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">dependants, dependancy</span>)</span>{
        <span class="hljs-keyword">if</span>( startsWith(dependancy, vector) || startsWith(vector, dependancy) ) push.call(TO_CALL, dependants);
      }, <span class="hljs-keyword">this</span>);
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-85">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-85">&#182;</a>
              </div>
              <p>If a change event, trigger anything that depends on that changed path.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(type.indexOf(<span class="hljs-string">'change:'</span>) === <span class="hljs-number">0</span>){
      vector = type.replace(<span class="hljs-string">'change:'</span>, <span class="hljs-string">''</span>).replace(<span class="hljs-regexp">/\.?\[.*\]/ig</span>, <span class="hljs-string">'.@each'</span>);
      _.each(<span class="hljs-keyword">this</span>.__computedDeps, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">dependants, dependancy</span>)</span>{
        startsWith(vector, dependancy) &amp;&amp; push.call(TO_CALL, dependants);
      }, <span class="hljs-keyword">this</span>);
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-86">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-86">&#182;</a>
              </div>
              <p>Notifies all computed properties in the dependants array to recompute.
Push all recomputes to the end of our stack trace so all Computed Properties
already queued for recompute get a chance to.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(!CALL_TIMEOUT){ CALL_TIMEOUT = setTimeout(_.bind(recomputeCallback, <span class="hljs-keyword">this</span>), <span class="hljs-number">0</span>); }

  },</pre></div></div>
            
        </li>
        
        
        <li id="section-87">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-87">&#182;</a>
              </div>
              <p>Called when a Computed Property’s active cache object changes.
Pushes any changes to Computed Property that returns a data object back to
the original object.
TODO: Will be a hair faster with individual callbacks for each event type</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  onModify: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">type, model={}, collection={}, options={}</span>)</span>{
    <span class="hljs-keyword">var</span> shortcircuit = { sort: <span class="hljs-number">1</span>, request: <span class="hljs-number">1</span>, destroy: <span class="hljs-number">1</span>, sync: <span class="hljs-number">1</span>, error: <span class="hljs-number">1</span>, invalid: <span class="hljs-number">1</span>, route: <span class="hljs-number">1</span> };
    <span class="hljs-keyword">if</span>( <span class="hljs-keyword">this</span>.isChanging || !<span class="hljs-keyword">this</span>.tracking || shortcircuit[type] || ~type.indexOf(<span class="hljs-string">'change:'</span>) ){ <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>; }
    !collection.isData &amp;&amp; _.isObject(collection) &amp;&amp; (options = collection) &amp;&amp; (collection = model);

    <span class="hljs-keyword">var</span> path = collection.__path().replace(<span class="hljs-keyword">this</span>.__path(), <span class="hljs-string">''</span>).replace(<span class="hljs-regexp">/^\./</span>, <span class="hljs-string">''</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-88">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-88">&#182;</a>
              </div>
              <p>Need to pass isPath: true here because when syncing across computed properties
that return collections we may just be passing the model index for the path.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> dest = <span class="hljs-keyword">this</span>.tracking.get(path, {raw: <span class="hljs-literal">true</span>, isPath: <span class="hljs-literal">true</span>});

    <span class="hljs-keyword">if</span>(_.isUndefined(dest)){ <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>; }
    <span class="hljs-keyword">if</span>(type === <span class="hljs-string">'change'</span> &amp;&amp; model.changedAttributes()){ dest.set &amp;&amp; dest.set(model.changedAttributes()); }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(type === <span class="hljs-string">'reset'</span>){ dest.reset &amp;&amp; dest.reset(model); }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(type === <span class="hljs-string">'update'</span>){ dest.set &amp;&amp; dest.set(model); }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(type === <span class="hljs-string">'add'</span>){ dest.add &amp;&amp; dest.add(model); }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(type === <span class="hljs-string">'remove'</span>){ dest.remove &amp;&amp; dest.remove(model); }</pre></div></div>
            
        </li>
        
        
        <li id="section-89">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-89">&#182;</a>
              </div>
              <p>TODO: Add sort</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-90">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-90">&#182;</a>
              </div>
              <p>Adds a litener to the root object and tells it what properties this
Computed Property depend on.
The listener will re-compute this Computed Property when any are changed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  wire: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
    <span class="hljs-keyword">var</span> root = <span class="hljs-keyword">this</span>.__root__;
    <span class="hljs-keyword">var</span> context = <span class="hljs-keyword">this</span>.__parent__;
    root.__computedDeps || (root.__computedDeps = {});

    _.each(<span class="hljs-keyword">this</span>.deps, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">path</span>)</span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-91">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-91">&#182;</a>
              </div>
              <p>For each dependancy, mark ourselves as dirty if they become dirty</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> dep = root.get(path, {raw: <span class="hljs-literal">true</span>, isPath: <span class="hljs-literal">true</span>});
      <span class="hljs-keyword">if</span>(dep &amp;&amp; dep.isComputedProperty){ dep.on(<span class="hljs-string">'dirty'</span>, <span class="hljs-keyword">this</span>.markDirty); }</pre></div></div>
            
        </li>
        
        
        <li id="section-92">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-92">&#182;</a>
              </div>
              <p>Find actual context and path from relative paths</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> split = $.splitPath(path);
      <span class="hljs-keyword">while</span>(split[<span class="hljs-number">0</span>] === <span class="hljs-string">'@parent'</span>){
        context = context.__parent__;
        split.shift();
      }
      path = context.__path().replace(<span class="hljs-regexp">/\.?\[.*\]/ig</span>, <span class="hljs-string">'.@each'</span>);
      path = path + (path &amp;&amp; <span class="hljs-string">'.'</span>) + split.join(<span class="hljs-string">'.'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-93">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-93">&#182;</a>
              </div>
              <p>Add ourselves as dependants</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      root.__computedDeps[path] || (root.__computedDeps[path] = []);
      root.__computedDeps[path].push(<span class="hljs-keyword">this</span>);
    }, <span class="hljs-keyword">this</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-94">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-94">&#182;</a>
              </div>
              <p>Ensure we only have one listener per Model at a time.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    context.off(<span class="hljs-string">'all'</span>, <span class="hljs-keyword">this</span>.onRecompute).on(<span class="hljs-string">'all'</span>, <span class="hljs-keyword">this</span>.onRecompute);
  },

  unwire: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
    <span class="hljs-keyword">var</span> root = <span class="hljs-keyword">this</span>.__root__;
    <span class="hljs-keyword">var</span> context = <span class="hljs-keyword">this</span>.__parent__;

    _.each(<span class="hljs-keyword">this</span>.deps, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">path</span>)</span>{
      <span class="hljs-keyword">var</span> dep = root.get(path, {raw: <span class="hljs-literal">true</span>, isPath: <span class="hljs-literal">true</span>});
      <span class="hljs-keyword">if</span>(!dep || !dep.isComputedProperty){ <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>; }
      dep.off(<span class="hljs-string">'dirty'</span>, <span class="hljs-keyword">this</span>.markDirty);
    }, <span class="hljs-keyword">this</span>);

    context.off(<span class="hljs-string">'all'</span>, <span class="hljs-keyword">this</span>.onRecompute);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-95">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-95">&#182;</a>
              </div>
              <p>Call this computed property like you would with Function.call()</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  call: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
    <span class="hljs-keyword">var</span> args = <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>),
        context = args.shift();
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.apply(context, args);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-96">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-96">&#182;</a>
              </div>
              <p>Call this computed property like you would with Function.apply()
Only properties that are marked as dirty and are not already computing
themselves are evaluated to prevent cyclic callbacks. If any dependants
aren’t finished computeding, we add ourselved to their waiting list.
Vanilla objects returned from the function are promoted to Rebound Objects.
Then, set the proper return type for future fetches from the cache and set
the new computed value. Track changes to the cache to push it back up to
the original object and return the value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  apply: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">context, params</span>)</span>{

    context || (context = <span class="hljs-keyword">this</span>.__parent__);</pre></div></div>
            
        </li>
        
        
        <li id="section-97">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-97">&#182;</a>
              </div>
              <p>Only re-evaluate this Computed Property if this value is dirty, not already
evaluating, and part of a data tree.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>( !<span class="hljs-keyword">this</span>.isDirty || <span class="hljs-keyword">this</span>.isChanging || !context ){ <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>; }</pre></div></div>
            
        </li>
        
        
        <li id="section-98">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-98">&#182;</a>
              </div>
              <p>Mark this Computed Property as in the process of changing</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.isChanging = <span class="hljs-literal">true</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-99">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-99">&#182;</a>
              </div>
              <p>Check all of our dependancies to see if they are evaluating.
If we have a dependancy that is dirty and this isnt its first run,
Let this dependancy know that we are waiting for it.
It will re-run this Computed Property after it finishes.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    _.each(<span class="hljs-keyword">this</span>.deps, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">dep</span>)</span>{
      <span class="hljs-keyword">var</span> dependancy = context.get(dep, {raw: <span class="hljs-literal">true</span>, isPath: <span class="hljs-literal">true</span>});
      <span class="hljs-keyword">if</span>( !dependancy || !dependancy.isComputedProperty ){ <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>; }
      <span class="hljs-keyword">if</span>(dependancy.isDirty &amp;&amp; dependancy.returnType !== <span class="hljs-literal">null</span>){
        dependancy.waiting[<span class="hljs-keyword">this</span>.cid] = <span class="hljs-keyword">this</span>;
        dependancy.apply(); <span class="hljs-comment">// Try to re-evaluate this dependancy if it is dirty</span>
        <span class="hljs-keyword">if</span>(dependancy.isDirty){ <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.isChanging = <span class="hljs-literal">false</span>; }
      }
      <span class="hljs-keyword">delete</span> dependancy.waiting[<span class="hljs-keyword">this</span>.cid];</pre></div></div>
            
        </li>
        
        
        <li id="section-100">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-100">&#182;</a>
              </div>
              <p>TODO: There can be a check here looking for cyclic dependancies.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    }, <span class="hljs-keyword">this</span>);

    <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>.isChanging){ <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>; }</pre></div></div>
            
        </li>
        
        
        <li id="section-101">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-101">&#182;</a>
              </div>
              <p>Run our getter method to fetch the new result value and retreive current
value from the cache</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> result = <span class="hljs-keyword">this</span>.getter.apply(context, params);
    <span class="hljs-keyword">var</span> value = <span class="hljs-keyword">this</span>.cache[<span class="hljs-keyword">this</span>.returnType];</pre></div></div>
            
        </li>
        
        
        <li id="section-102">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-102">&#182;</a>
              </div>
              <p>Promote vanilla objects to Rebound Data keeping the same original objects</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(_.isArray(result)){ result = <span class="hljs-keyword">new</span> Rebound.Collection(result, {clone: <span class="hljs-literal">false</span>}); }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(_.isObject(result) &amp;&amp; !result.isData){ result = <span class="hljs-keyword">new</span> Rebound.Model(result, {clone: <span class="hljs-literal">false</span>}); }</pre></div></div>
            
        </li>
        
        
        <li id="section-103">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-103">&#182;</a>
              </div>
              <p>If result is undefined, reset our cache item</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(_.isUndefined(result) || _.isNull(result)){
      <span class="hljs-keyword">this</span>.returnType = <span class="hljs-string">'value'</span>;
      <span class="hljs-keyword">this</span>.isCollection = <span class="hljs-keyword">this</span>.isModel = <span class="hljs-literal">false</span>;
      <span class="hljs-keyword">this</span>.set(<span class="hljs-literal">undefined</span>);
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-104">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-104">&#182;</a>
              </div>
              <p>Set result and return types, bind events
Use .set instead of .reset to trigger individual changes for internal models</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(result.isCollection){
      <span class="hljs-keyword">this</span>.returnType = <span class="hljs-string">'collection'</span>;
      <span class="hljs-keyword">this</span>.isCollection = <span class="hljs-literal">true</span>;
      <span class="hljs-keyword">this</span>.isModel = <span class="hljs-literal">false</span>;
      <span class="hljs-keyword">this</span>.set(result);
      <span class="hljs-keyword">this</span>.track(result);
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-105">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-105">&#182;</a>
              </div>
              <p>If this is a model, set the return types and bind events.
If this model is the same as a previus run, just apply the changes to it.
If this is a different model, reset all of the values to the new ones.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(result.isModel){
      <span class="hljs-keyword">this</span>.returnType = <span class="hljs-string">'model'</span>;
      <span class="hljs-keyword">this</span>.isCollection = <span class="hljs-literal">false</span>;
      <span class="hljs-keyword">this</span>.isModel = <span class="hljs-literal">true</span>;
      <span class="hljs-keyword">this</span>.reset(result);
      <span class="hljs-keyword">this</span>.track(result);
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-106">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-106">&#182;</a>
              </div>
              <p>Otherwise, result is a primitive. Set values appropreately.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">else</span>{
      <span class="hljs-keyword">this</span>.returnType = <span class="hljs-string">'value'</span>;
      <span class="hljs-keyword">this</span>.isCollection = <span class="hljs-keyword">this</span>.isModel = <span class="hljs-literal">false</span>;
      <span class="hljs-keyword">this</span>.set(result);
    }

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.value();
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-107">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-107">&#182;</a>
              </div>
              <p>When we receive a new model to set in our cache, unbind the tracker from
the previous cache object, sync the objects’ cids so helpers think they
are the same object, save a referance to the object we are tracking,
and re-bind our onModify hook.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  track: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">object</span>)</span>{
    <span class="hljs-keyword">var</span> target = <span class="hljs-keyword">this</span>.value();
    <span class="hljs-keyword">if</span>(!object || !target || !target.isData || !object.isData){ <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>; }
    target._cid || (target._cid = target.cid);
    object._cid || (object._cid = object.cid);
    target.cid = object.cid;
    <span class="hljs-keyword">this</span>.tracking = object;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-108">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-108">&#182;</a>
              </div>
              <p>Get from the Computed Property’s cache</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  get: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">key, options={}</span>)</span>{
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.returnType === <span class="hljs-string">'value'</span>){ <span class="hljs-keyword">return</span> <span class="hljs-built_in">console</span>.error(<span class="hljs-string">'Called get on the `'</span>+ <span class="hljs-keyword">this</span>.name +<span class="hljs-string">'` computed property which returns a primitive value.'</span>); }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.value().get(key, options);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-109">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-109">&#182;</a>
              </div>
              <p>Set the Computed Property’s cache to a new value and trigger appropreate events.
Changes will propagate back to the original object if a Rebound Data Object and re-compute.
If Computed Property returns a value, all downstream dependancies will re-compute.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  set: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">key, val, options={}</span>)</span>{

    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.returnType === <span class="hljs-literal">null</span>){ <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>; }
    <span class="hljs-keyword">var</span> attrs = key;
    <span class="hljs-keyword">var</span> value = <span class="hljs-keyword">this</span>.value();</pre></div></div>
            
        </li>
        
        
        <li id="section-110">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-110">&#182;</a>
              </div>
              <p>Noralize the data passed in</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.returnType === <span class="hljs-string">'model'</span>){
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> key === <span class="hljs-string">'object'</span>) {
        attrs = (key.isModel) ? key.attributes : key;
        options = val || {};
      } <span class="hljs-keyword">else</span> {
        (attrs = {})[key] = val;
      }
    }
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.returnType !== <span class="hljs-string">'model'</span>){ options = val || {}; }
    attrs = (attrs &amp;&amp; attrs.isComputedProperty) ? attrs.value() : attrs;</pre></div></div>
            
        </li>
        
        
        <li id="section-111">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-111">&#182;</a>
              </div>
              <p>If a new value, set it and trigger events</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.setter &amp;&amp; <span class="hljs-keyword">this</span>.setter.call(<span class="hljs-keyword">this</span>.__root__, attrs);

    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.returnType === <span class="hljs-string">'value'</span> &amp;&amp; <span class="hljs-keyword">this</span>.cache.value !== attrs) {
      <span class="hljs-keyword">this</span>.cache.value = attrs;
      <span class="hljs-keyword">if</span>(!options.quiet){</pre></div></div>
            
        </li>
        
        
        <li id="section-112">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-112">&#182;</a>
              </div>
              <p>If set was called not through computedProperty.call(), this is a fresh new event burst.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>.isDirty &amp;&amp; !<span class="hljs-keyword">this</span>.isChanging) <span class="hljs-keyword">this</span>.__parent__.changed = {};
        <span class="hljs-keyword">this</span>.__parent__.changed[<span class="hljs-keyword">this</span>.name] = attrs;
        <span class="hljs-keyword">this</span>.trigger(<span class="hljs-string">'change'</span>, <span class="hljs-keyword">this</span>.__parent__);
        <span class="hljs-keyword">this</span>.trigger(<span class="hljs-string">'change:'</span>+<span class="hljs-keyword">this</span>.name, <span class="hljs-keyword">this</span>.__parent__, attrs);
        <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.__parent__.changed[<span class="hljs-keyword">this</span>.name];
      }
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.returnType !== <span class="hljs-string">'value'</span> &amp;&amp; options.reset){ key = value.reset(attrs, options); }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.returnType !== <span class="hljs-string">'value'</span>){ key = value.set(attrs, options); }
    <span class="hljs-keyword">this</span>.isDirty = <span class="hljs-keyword">this</span>.isChanging = <span class="hljs-literal">false</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-113">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-113">&#182;</a>
              </div>
              <p>Call all reamining computed properties waiting for this value to resolve.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    _.each(<span class="hljs-keyword">this</span>.waiting, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">prop</span>)</span>{ prop &amp;&amp; prop.call(); });

    <span class="hljs-keyword">return</span> key;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-114">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-114">&#182;</a>
              </div>
              <p>Return the current value from the cache, running if dirty.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  value: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.isDirty){ <span class="hljs-keyword">this</span>.apply(); }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.cache[<span class="hljs-keyword">this</span>.returnType];
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-115">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-115">&#182;</a>
              </div>
              <p>Reset the current value in the cache, unless if first run.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  reset: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">obj, options={}</span>)</span>{
    <span class="hljs-keyword">if</span>(_.isNull(<span class="hljs-keyword">this</span>.returnType)){ <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>; }
    options.reset = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.set(obj, options);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-116">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-116">&#182;</a>
              </div>
              <p>Cyclic dependancy safe toJSON method.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  toJSON: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._isSerializing){ <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.cid; }
    <span class="hljs-keyword">var</span> val = <span class="hljs-keyword">this</span>.value();
    <span class="hljs-keyword">this</span>._isSerializing = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">var</span> json = (val &amp;&amp; _.isFunction(val.toJSON)) ? val.toJSON() : val;
    <span class="hljs-keyword">this</span>._isSerializing = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">return</span> json;
  }

});

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> ComputedProperty;</pre></div></div>
            
        </li>
        
        
        <li id="section-117">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-117">&#182;</a>
              </div>
              <h2 id="rebound-component">Rebound Component</h2>

            </div>
            
        </li>
        
        
        <li id="section-118">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-118">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">import</span> Backbone <span class="hljs-keyword">from</span> <span class="hljs-string">"backbone"</span>;
<span class="hljs-keyword">import</span> {$, REBOUND_SYMBOL} <span class="hljs-keyword">from</span> <span class="hljs-string">"rebound-utils/rebound-utils"</span>;
<span class="hljs-keyword">import</span> { Model } <span class="hljs-keyword">from</span> <span class="hljs-string">"rebound-data/rebound-data"</span>;
<span class="hljs-keyword">import</span> render <span class="hljs-keyword">from</span> <span class="hljs-string">"rebound-htmlbars/render"</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-119">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-119">&#182;</a>
              </div>
              <p>New Backbone Component</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> Component = Model.extend({

  isComponent: <span class="hljs-literal">true</span>,
  isHydrated: <span class="hljs-literal">true</span>,
  defaults: {},</pre></div></div>
            
        </li>
        
        
        <li id="section-120">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-120">&#182;</a>
              </div>
              <p>A method that returns a root scope by default. Meant to be overridden on
instantiation if applicable.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  __path: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{ <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._scope || <span class="hljs-string">''</span>; },


  <span class="hljs-keyword">constructor</span>(el, data, options){</pre></div></div>
            
        </li>
        
        
        <li id="section-121">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-121">&#182;</a>
              </div>
              <p>Ensure options is an object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    options || (options = {});</pre></div></div>
            
        </li>
        
        
        <li id="section-122">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-122">&#182;</a>
              </div>
              <p>Bind certian methods to ensure they are run in the context of our Component</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    _.bindAll(<span class="hljs-keyword">this</span>, <span class="hljs-string">'_callOnComponent'</span>, <span class="hljs-string">'_listenToService'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-123">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-123">&#182;</a>
              </div>
              <p>Set instance cid and caches for this Component</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.cid = $.uniqueId(<span class="hljs-string">'component'</span>);
    <span class="hljs-keyword">this</span>.attributes = {};
    <span class="hljs-keyword">this</span>.changed = {};
    <span class="hljs-keyword">this</span>.consumers = [];
    <span class="hljs-keyword">this</span>.services = {};
    <span class="hljs-keyword">this</span>.loadCallbacks = [];
    <span class="hljs-keyword">this</span>.options = options;</pre></div></div>
            
        </li>
        
        
        <li id="section-124">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-124">&#182;</a>
              </div>
              <p>If we are told this is not a hydrated component, mark it as such</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(options.isHydrated === <span class="hljs-literal">false</span>){ <span class="hljs-keyword">this</span>.isHydrated = <span class="hljs-literal">false</span>; }</pre></div></div>
            
        </li>
        
        
        <li id="section-125">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-125">&#182;</a>
              </div>
              <p>Components are always the top of their data tree. Set parent and root to itself.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.__parent__ = <span class="hljs-keyword">this</span>.__root__ = <span class="hljs-keyword">this</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-126">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-126">&#182;</a>
              </div>
              <p>Take our parsed data and add it to our backbone data structure. Does a deep defaults set.
In the model, primatives (arrays, objects, etc) are converted to Backbone Objects
Functions are compiled to find their dependancies and added as computed properties
Set our component’s context with the passed data merged with the component’s defaults</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.set((<span class="hljs-keyword">this</span>.defaults || {}));
    <span class="hljs-keyword">this</span>.set((data || {}));</pre></div></div>
            
        </li>
        
        
        <li id="section-127">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-127">&#182;</a>
              </div>
              <p>Get any additional routes passed in from options</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.routes =  _.defaults((options.routes || {}), <span class="hljs-keyword">this</span>.routes);</pre></div></div>
            
        </li>
        
        
        <li id="section-128">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-128">&#182;</a>
              </div>
              <p>Ensure that all route functions exist</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    _.each(<span class="hljs-keyword">this</span>.routes, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">value, key, routes</span>)</span>{
        <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> value !== <span class="hljs-string">'string'</span>){ <span class="hljs-keyword">throw</span>(<span class="hljs-string">'Function name passed to routes in  '</span> + <span class="hljs-keyword">this</span>.tagName + <span class="hljs-string">' component must be a string!'</span>); }
        <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>[value]){ <span class="hljs-keyword">throw</span>(<span class="hljs-string">'Callback function '</span>+value+<span class="hljs-string">' does not exist on the  '</span> + <span class="hljs-keyword">this</span>.tagName + <span class="hljs-string">' component!'</span>); }
    }, <span class="hljs-keyword">this</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-129">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-129">&#182;</a>
              </div>
              <p>Set or create our element and template if we have them</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.el = el || <span class="hljs-built_in">document</span>.createDocumentFragment();
    <span class="hljs-keyword">this</span>.$el = (_.isFunction(Backbone.$)) ? Backbone.$(<span class="hljs-keyword">this</span>.el) : <span class="hljs-literal">false</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-130">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-130">&#182;</a>
              </div>
              <p>Render our dom and place the dom in our custom element</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.render();</pre></div></div>
            
        </li>
        
        
        <li id="section-131">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-131">&#182;</a>
              </div>
              <p>Add active class to this newly rendered template’s link elements that require it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    $(<span class="hljs-keyword">this</span>.el).markLinks();</pre></div></div>
            
        </li>
        
        
        <li id="section-132">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-132">&#182;</a>
              </div>
              <p>Call user provided initialize</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.initialize();

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  },

  _callOnComponent(name, event){
    <span class="hljs-keyword">if</span>(!_.isFunction(<span class="hljs-keyword">this</span>[name])){ <span class="hljs-keyword">throw</span> <span class="hljs-string">"ERROR: No method named "</span> + name + <span class="hljs-string">" on component "</span> + <span class="hljs-keyword">this</span>.tagName + <span class="hljs-string">"!"</span>; }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>[name].call(<span class="hljs-keyword">this</span>, event);
  },

  _listenToService(key, service){
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
    <span class="hljs-keyword">this</span>.listenTo(service, <span class="hljs-string">'all'</span>, (type, model, value, options={}) =&gt; {
      <span class="hljs-keyword">var</span> attr, oldScope = service._scope,
          path = model.__path(),
          changed;</pre></div></div>
            
        </li>
        
        
        <li id="section-133">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-133">&#182;</a>
              </div>
              <p>TODO: Find a better way to get service keys in their path() method based on call Scope
Services may be installed at any location. In order for the __path() method
to include this location in the correct context, it needs to have contextual
knowledge of what called it. For the lifetime of this event tree, re-write
its scope property appropreately. Re-set it to previous value when done.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      service._scope = key;

      <span class="hljs-keyword">if</span>(type.indexOf(<span class="hljs-string">'change:'</span>) === <span class="hljs-number">0</span>){
        changed = model.changedAttributes();
        <span class="hljs-keyword">for</span>(attr <span class="hljs-keyword">in</span> changed){</pre></div></div>
            
        </li>
        
        
        <li id="section-134">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-134">&#182;</a>
              </div>
              <p>TODO: Modifying arguments array is bad. change this</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          type = (<span class="hljs-string">'change:'</span> + key + <span class="hljs-string">'.'</span> + path + (path &amp;&amp; <span class="hljs-string">'.'</span>) + attr); <span class="hljs-comment">// jshint ignore:line</span>
          <span class="hljs-keyword">this</span>.trigger.call(<span class="hljs-keyword">this</span>, type, model, value, options);
        }
      }
      <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">this</span>.trigger.call(<span class="hljs-keyword">this</span>, type, model, value, options);
      }
      service._scope = oldScope;
    });
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-135">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-135">&#182;</a>
              </div>
              <p>Render our dom and place the dom in our custom element
TODO: Check if template is a string, and if the compiler exists on the page, and compile if needed</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  render(){
    $(<span class="hljs-keyword">this</span>.el).empty();
    render(<span class="hljs-keyword">this</span>.el, <span class="hljs-keyword">this</span>[REBOUND_SYMBOL].template, <span class="hljs-keyword">this</span>);
  },

  deinitialize(){
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.consumers.length){ <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>; }
    _.each(<span class="hljs-keyword">this</span>.services, (service, key) =&gt; {
      _.each(service.consumers, (consumer, index) =&gt; {
        <span class="hljs-keyword">if</span>(consumer.component === <span class="hljs-keyword">this</span>) service.consumers.splice(index, <span class="hljs-number">1</span>);
      });
    });
    <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.services;
    Model.prototype.deinitialize.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-136">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-136">&#182;</a>
              </div>
              <p>LazyComponents have an onLoad function that calls all the registered callbacks
after it has been hydrated. If we are calling onLoad on an already loaded
component, just call the callback provided.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  onLoad(cb){
    <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>.isHydrated){ <span class="hljs-keyword">this</span>.loadCallbacks.push(cb); }
    <span class="hljs-keyword">else</span>{ cb(<span class="hljs-keyword">this</span>); }
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-137">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-137">&#182;</a>
              </div>
              <p>Set is overridden on components to accept components as a valid input type.
Components set on other Components are mixed in as a shared object. {raw: true}
It also marks itself as a consumer of this component</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  set(key, val, options){
    <span class="hljs-keyword">var</span> attrs, attr, serviceOptions;
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> key === <span class="hljs-string">'object'</span>) {
      attrs = (key.isModel) ? key.attributes : key;
      options = val;
    } <span class="hljs-keyword">else</span> (attrs = {})[key] = val;
    options || (options = {});</pre></div></div>
            
        </li>
        
        
        <li id="section-138">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-138">&#182;</a>
              </div>
              <p>If reset option passed, do a reset. If nothing passed, return.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(options.reset === <span class="hljs-literal">true</span>) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.reset(attrs, options);
    <span class="hljs-keyword">if</span>(options.defaults === <span class="hljs-literal">true</span>) <span class="hljs-keyword">this</span>.defaults = attrs;
    <span class="hljs-keyword">if</span>(_.isEmpty(attrs)){ <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>; }</pre></div></div>
            
        </li>
        
        
        <li id="section-139">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-139">&#182;</a>
              </div>
              <p>For each attribute passed:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">for</span>(key <span class="hljs-keyword">in</span> attrs){
      attr = attrs[key];
      <span class="hljs-keyword">if</span>(attr &amp;&amp; attr.isComponent){
        <span class="hljs-keyword">if</span>(attr.isLazyComponent &amp;&amp; attr._component){ attr = attr._component; }
        serviceOptions || (serviceOptions = _.defaults(_.clone(options), {raw: <span class="hljs-literal">true</span>}));
        attr.consumers.push({key: key, component: <span class="hljs-keyword">this</span>});
        <span class="hljs-keyword">this</span>.services[key] = attr;
        <span class="hljs-keyword">this</span>._listenToService(key, attr);
        Model.prototype.set.call(<span class="hljs-keyword">this</span>, key, attr, serviceOptions);
      }
      Model.prototype.set.call(<span class="hljs-keyword">this</span>, key, attr, options);
    }

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  },

  $(selector) {
    <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>.$el){
      <span class="hljs-keyword">return</span> <span class="hljs-built_in">console</span>.error(<span class="hljs-string">'No DOM manipulation library on the page!'</span>);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.$el.find(selector);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-140">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-140">&#182;</a>
              </div>
              <p>Trigger all events on both the component and the element</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  trigger(eventName){
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.el){
      $(<span class="hljs-keyword">this</span>.el).trigger(eventName, <span class="hljs-built_in">arguments</span>);
    }
    Backbone.Model.prototype.trigger.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);
  },

  _onAttributeChange(attrName, oldVal, newVal){</pre></div></div>
            
        </li>
        
        
        <li id="section-141">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-141">&#182;</a>
              </div>
              <p>Commented out because tracking attribute changes and making sure they dont infinite loop is hard.
TODO: Make work.
try{ newVal = JSON.parse(newVal); } catch (e){ newVal = newVal; }</p>
<p>// data attributes should be referanced by their camel case name
attrName = attrName.replace(/^data-/g, “”).replace(/-([a-z])/g, function (g) { return g[1].toUpperCase(); });</p>
<p>oldVal = this.get(attrName);</p>
<p>if(newVal === null){ this.unset(attrName); }</p>
<p>// If oldVal is a number, and newVal is only numerical, preserve type
if(<em>.isNumber(oldVal) &amp;&amp; </em>.isString(newVal) &amp;&amp; newVal.match(/^[0-9]*$/i)){
  newVal = parseInt(newVal);
}</p>
<p>else{ this.set(attrName, newVal, {quiet: true}); }</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  }

});


<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">processProps</span>(<span class="hljs-params">protoProps, staticProps</span>)</span>{

  <span class="hljs-keyword">var</span> reservedMethods = {
    <span class="hljs-string">'trigger'</span>:<span class="hljs-number">1</span>,    <span class="hljs-string">'get'</span>:<span class="hljs-number">1</span>,      <span class="hljs-string">'set'</span>:<span class="hljs-number">1</span>,     <span class="hljs-string">'has'</span>:<span class="hljs-number">1</span>,        <span class="hljs-string">'escape'</span>:<span class="hljs-number">1</span>,
    <span class="hljs-string">'unset'</span>:<span class="hljs-number">1</span>,      <span class="hljs-string">'clear'</span>:<span class="hljs-number">1</span>,    <span class="hljs-string">'cid'</span>:<span class="hljs-number">1</span>,     <span class="hljs-string">'attributes'</span>:<span class="hljs-number">1</span>, <span class="hljs-string">'hasChanged'</span>:<span class="hljs-number">1</span>,
    <span class="hljs-string">'changed'</span>:<span class="hljs-number">1</span>,    <span class="hljs-string">'toJSON'</span>:<span class="hljs-number">1</span>,   <span class="hljs-string">'isValid'</span>:<span class="hljs-number">1</span>, <span class="hljs-string">'isNew'</span>:<span class="hljs-number">1</span>,      <span class="hljs-string">'validationError'</span>:<span class="hljs-number">1</span>,
    <span class="hljs-string">'previous'</span>:<span class="hljs-number">1</span>,   <span class="hljs-string">'toggle'</span>:<span class="hljs-number">1</span>,   <span class="hljs-string">'previousAttributes'</span>:<span class="hljs-number">1</span>,      <span class="hljs-string">'changedAttributes'</span>:<span class="hljs-number">1</span>,
  },
  configProperties = {
    <span class="hljs-string">'id'</span>:<span class="hljs-number">1</span>,        <span class="hljs-string">'idAttribute'</span>:<span class="hljs-number">1</span>,      <span class="hljs-string">'url'</span>:<span class="hljs-number">1</span>,              <span class="hljs-string">'urlRoot'</span>:<span class="hljs-number">1</span>,
    <span class="hljs-string">'routes'</span>:<span class="hljs-number">1</span>,    <span class="hljs-string">'createdCallback'</span>:<span class="hljs-number">1</span>,  <span class="hljs-string">'attachedCallback'</span>:<span class="hljs-number">1</span>, <span class="hljs-string">'detachedCallback'</span>:<span class="hljs-number">1</span>,
    <span class="hljs-string">'attributeChangedCallback'</span>:<span class="hljs-number">1</span>, <span class="hljs-string">'defaults'</span>: <span class="hljs-number">1</span>
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-142">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-142">&#182;</a>
              </div>
              <p>These properties exist on all instances of the Component</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  protoProps || (protoProps = {});
  protoProps.defaults = {};</pre></div></div>
            
        </li>
        
        
        <li id="section-143">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-143">&#182;</a>
              </div>
              <p>These properties exist on the custom Component constructor
Ensure every constructor has a template and stylesheet</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  staticProps || (staticProps = {});
  staticProps.template || (staticProps.template = <span class="hljs-literal">null</span>);
  staticProps.stylesheet || (staticProps.stylesheet = <span class="hljs-string">''</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-144">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-144">&#182;</a>
              </div>
              <p>Convert computed properties (getters and setters on this object) to Computed
Property primitives</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  $.extractComputedProps(protoProps);</pre></div></div>
            
        </li>
        
        
        <li id="section-145">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-145">&#182;</a>
              </div>
              <p>For each property passed into our component base class determine if it is
intended as a default value (move it into the defaults hash) or a component
method (leave it alone).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> key <span class="hljs-keyword">in</span> protoProps){
  <span class="hljs-keyword">let</span> value = protoProps[key];</pre></div></div>
            
        </li>
        
        
        <li id="section-146">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-146">&#182;</a>
              </div>
              <p>If this isn’t an actual property, keep going</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>(!protoProps.hasOwnProperty(key)){ <span class="hljs-keyword">continue</span>; }</pre></div></div>
            
        </li>
        
        
        <li id="section-147">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-147">&#182;</a>
              </div>
              <p>If this is a reserved property name, yell</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>(reservedMethods[key]){ <span class="hljs-keyword">throw</span> <span class="hljs-string">"ERROR: "</span> + key + <span class="hljs-string">" is a reserved method name in "</span> + staticProps.type + <span class="hljs-string">"!"</span>; }</pre></div></div>
            
        </li>
        
        
        <li id="section-148">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-148">&#182;</a>
              </div>
              <p>If a configuration property, or not actually on the obj, ignore it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>(!protoProps.hasOwnProperty(key) || configProperties[key]){ <span class="hljs-keyword">continue</span>; }</pre></div></div>
            
        </li>
        
        
        <li id="section-149">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-149">&#182;</a>
              </div>
              <p>If a primative, backbone type object, or computed property, move it to our defaults</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>(!_.isFunction(value) || value.isComputedProto || value.isModel || value.isComponent){
    protoProps.defaults[key] = value;
    <span class="hljs-keyword">delete</span> protoProps[key];
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-150">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-150">&#182;</a>
              </div>
              <p>All other values are component methods, leave them be.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  }

}

Component.hydrate = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">hydrateComponent</span>(<span class="hljs-params">protoProps={}, staticProps={}</span>)</span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-151">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-151">&#182;</a>
              </div>
              <p>If already hydrated, return.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.isHydrated){ <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>; }</pre></div></div>
            
        </li>
        
        
        <li id="section-152">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-152">&#182;</a>
              </div>
              <p>Process our new properties objects</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  processProps(protoProps, staticProps);</pre></div></div>
            
        </li>
        
        
        <li id="section-153">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-153">&#182;</a>
              </div>
              <p>Extend our prototype with any protoProps, overriting pre-defined ones</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (protoProps){ _.extend(<span class="hljs-keyword">this</span>.prototype, protoProps); }</pre></div></div>
            
        </li>
        
        
        <li id="section-154">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-154">&#182;</a>
              </div>
              <p>Add any static props to the function object itself</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (staticProps){ _.extend(<span class="hljs-keyword">this</span>, staticProps); }</pre></div></div>
            
        </li>
        
        
        <li id="section-155">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-155">&#182;</a>
              </div>
              <p>Ensure we have a type, template and stylesheet</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">this</span>.prototype[REBOUND_SYMBOL] = {
    type: staticProps.type || <span class="hljs-string">'anonymous-component'</span>,
    template: staticProps.template || <span class="hljs-literal">null</span>,
    stylesheet: staticProps.stylesheet || <span class="hljs-string">''</span>,
    isHydrated: <span class="hljs-literal">true</span>
  };

};

Component.extend = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">extendComponent</span>(<span class="hljs-params">protoProps={}, staticProps={}</span>)</span>{
  <span class="hljs-keyword">var</span> parent = <span class="hljs-keyword">this</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-156">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-156">&#182;</a>
              </div>
              <p>Call our parent Component constructor and pass through the instance specific
name, template and stylesheet via options if no other name, template or
stylesheet is present.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      Component = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Component</span>(<span class="hljs-params">type, data={}, options={}</span>)</span>{
        <span class="hljs-keyword">return</span> parent.call(<span class="hljs-keyword">this</span>, type, data, options);
      },</pre></div></div>
            
        </li>
        
        
        <li id="section-157">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-157">&#182;</a>
              </div>
              <p>Surrogate constructor allows us to inherit everything from the parent and
retain a referance to our component specific constructor as <code>this.constructor</code>
on component instances’ prototype chains. This is also the object we augment
with additional protoProps on component hydration if needed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      Surrogate = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Surrogate</span>(<span class="hljs-params"></span>)</span>{ <span class="hljs-keyword">this</span>.constructor = Component; };</pre></div></div>
            
        </li>
        
        
        <li id="section-158">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-158">&#182;</a>
              </div>
              <p>Our class should inherit everything from its parent, defined above</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  Surrogate.prototype = parent.prototype;
  Component.prototype = <span class="hljs-keyword">new</span> Surrogate();</pre></div></div>
            
        </li>
        
        
        <li id="section-159">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-159">&#182;</a>
              </div>
              <p>Set our ancestry</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  Component.__super__ = parent.prototype;</pre></div></div>
            
        </li>
        
        
        <li id="section-160">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-160">&#182;</a>
              </div>
              <p>Process our new properties objects</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  processProps(protoProps, staticProps);</pre></div></div>
            
        </li>
        
        
        <li id="section-161">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-161">&#182;</a>
              </div>
              <p>Extend our prototype with any remaining protoProps, overriting pre-defined ones</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (protoProps){ _.extend(Component.prototype, protoProps ); }</pre></div></div>
            
        </li>
        
        
        <li id="section-162">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-162">&#182;</a>
              </div>
              <p>Add any static props to the function object itself</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (staticProps){ _.extend(Component, parent, staticProps); }</pre></div></div>
            
        </li>
        
        
        <li id="section-163">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-163">&#182;</a>
              </div>
              <p>Ensure we hae a type, template and stylesheet</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  Component.prototype[REBOUND_SYMBOL] = {
    type: staticProps.type || <span class="hljs-string">'anonymous-component'</span>,
    template: staticProps.template || <span class="hljs-literal">null</span>,
    stylesheet: staticProps.stylesheet || <span class="hljs-string">''</span>,
    isHydrated: staticProps.hasOwnProperty(<span class="hljs-string">'isHydrated'</span>) ? staticProps.isHydrated : <span class="hljs-literal">true</span>
  };

  <span class="hljs-keyword">return</span> Component;
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> Component;</pre></div></div>
            
        </li>
        
        
        <li id="section-164">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-164">&#182;</a>
              </div>
              <h2 id="rebound-component-factory">Rebound Component Factory</h2>

            </div>
            
        </li>
        
        
        <li id="section-165">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-165">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">import</span> { $, REBOUND_SYMBOL } <span class="hljs-keyword">from</span> <span class="hljs-string">"rebound-utils/rebound-utils"</span>;
<span class="hljs-keyword">import</span> Component <span class="hljs-keyword">from</span> <span class="hljs-string">"rebound-component/component"</span>;

<span class="hljs-keyword">var</span> REGISTRY = {};
<span class="hljs-keyword">const</span> DUMMY_TEMPLATE = <span class="hljs-literal">false</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-166">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-166">&#182;</a>
              </div>
              <p>Used to transport component specific data to the native element created callback
in leu of a good API for passing initialization data to document.createElement.
When registry.create is called, it stashes instance data on this object in a
shared scope. After createElement is finished, it cleans this transport object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> ELEMENT_DATA;

<span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">registerComponent</span>(<span class="hljs-params">type, options={}</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-167">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-167">&#182;</a>
              </div>
              <p>Ensure our options are set nicely and extract the prototype provided to us</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> proto = options.prototype || {};
      <span class="hljs-keyword">delete</span> options.prototype;
      options.type = type;
      options.isHydrated = <span class="hljs-literal">true</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-168">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-168">&#182;</a>
              </div>
              <p>If the component exists in the registry, and is already hydrated, then this
is a conflicting component name – exit and log an error.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>(REGISTRY[type] &amp;&amp; REGISTRY[type].isHydrated){
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">console</span>.error(<span class="hljs-string">'A component of type'</span>, type, <span class="hljs-string">'already exists!'</span>);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-169">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-169">&#182;</a>
              </div>
              <p>If there is a non-hydrated component in the registry, hydrate it with the
newly provided prototype.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>(REGISTRY[type]){
    REGISTRY[type].hydrate(proto, options);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-170">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-170">&#182;</a>
              </div>
              <p>Otherwise, create and save a new component subclass and register the element</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">else</span> {
    REGISTRY[type] = Component.extend(proto, options);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-171">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-171">&#182;</a>
              </div>
              <p>Create our new element prototype object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> element = <span class="hljs-built_in">Object</span>.create(HTMLElement.prototype, {});</pre></div></div>
            
        </li>
        
        
        <li id="section-172">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-172">&#182;</a>
              </div>
              <p>On element creation, make a new instance of the component and attach it
to the element object as <code>data</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  element.createdCallback = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-173">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-173">&#182;</a>
              </div>
              <p>If <code>this.data</code> already exists on this element, then it was present on the
page via a <code>new Component(component-name);</code> call before this component was
actually registered. Now, we need to finish hydrating this instance of the
component data object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.data){</pre></div></div>
            
        </li>
        
        
        <li id="section-174">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-174">&#182;</a>
              </div>
              <p>Anything that is not already set on our component should be set to our
new default if it exists
TODO: If a default value perscribes a certain user-defined subclass
of Component or Model for a property already passed into a component,
the existing vanila Component or Model should be upgraded to that subclass</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> current = <span class="hljs-keyword">this</span>.data.toJSON();
      <span class="hljs-keyword">var</span> defaults = <span class="hljs-keyword">this</span>.data.defaults;
      <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> key <span class="hljs-keyword">in</span> defaults){
        <span class="hljs-keyword">if</span>(!current.hasOwnProperty(key) &amp;&amp; defaults.hasOwnProperty(key)){
          <span class="hljs-keyword">this</span>.data.set(key, defaults[key]);
        }
      }
      <span class="hljs-keyword">this</span>.data.render();
      <span class="hljs-keyword">this</span>.data.isHydrated = <span class="hljs-literal">true</span>;
      <span class="hljs-keyword">this</span>.data.loadCallbacks.forEach( (cb)=&gt;{ cb(<span class="hljs-keyword">this</span>.data); } );
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-175">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-175">&#182;</a>
              </div>
              <p>If we have element data, then we have come from a <code>new Component(component-name);</code>
call and may have been provided data to initialize with. Call the component
constructor with the provided properties. We don’t need <code>new</code> here because
the instance we are building is provided for us, so we use <code>component.call</code>
to call the component constructor using that scope.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(ELEMENT_DATA){
      <span class="hljs-keyword">this</span>.data = <span class="hljs-keyword">new</span> REGISTRY[type](<span class="hljs-keyword">this</span>, ELEMENT_DATA.data, ELEMENT_DATA.options);
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-176">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-176">&#182;</a>
              </div>
              <p>Otherwise, this is an upgraded instance of the element that was pre-existing
in the dom, or just created using <code>document.createElement</code>. Go ahead and
give it a new component object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">else</span> { <span class="hljs-keyword">this</span>.data = <span class="hljs-keyword">new</span> REGISTRY[type](<span class="hljs-keyword">this</span>); }</pre></div></div>
            
        </li>
        
        
        <li id="section-177">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-177">&#182;</a>
              </div>
              <p>Call user provided <code>attachedCallback</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    _.isFunction(proto.createdCallback) &amp;&amp; proto.createdCallback.call(<span class="hljs-keyword">this</span>.data);
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-178">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-178">&#182;</a>
              </div>
              <p>Call user provided <code>attachedCallback</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  element.attachedCallback = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    _.isFunction(proto.attachedCallback) &amp;&amp; proto.attachedCallback.call(<span class="hljs-keyword">this</span>.data);
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-179">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-179">&#182;</a>
              </div>
              <p>Call user provided <code>detachedCallback</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  element.detachedCallback = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    _.isFunction(proto.detachedCallback) &amp;&amp; proto.detachedCallback.call(<span class="hljs-keyword">this</span>.data);
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-180">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-180">&#182;</a>
              </div>
              <p>Call user provided <code>attributeChangedCallback</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  element.attributeChangedCallback = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">attrName, oldVal, newVal</span>) </span>{
    <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>.data){ <span class="hljs-keyword">return</span>; }
    <span class="hljs-keyword">this</span>.data._onAttributeChange(attrName, oldVal, newVal);
    _.isFunction(proto.attributeChangedCallback) &amp;&amp; proto.attributeChangedCallback.call(<span class="hljs-keyword">this</span>.data, attrName, oldVal, newVal);
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-181">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-181">&#182;</a>
              </div>
              <p>Register our new element</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-built_in">document</span>.registerElement(type, { prototype: element });</pre></div></div>
            
        </li>
        
        
        <li id="section-182">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-182">&#182;</a>
              </div>
              <p>Return the new component constructor</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">return</span> REGISTRY[type];
}


<span class="hljs-keyword">export</span> <span class="hljs-keyword">var</span> ComponentFactory = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ComponentFactory</span>(<span class="hljs-params">type, data={}, options={}</span>)</span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-183">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-183">&#182;</a>
              </div>
              <p>If type is not a valid component name, error</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> type !== <span class="hljs-string">'string'</span>){ <span class="hljs-keyword">return</span> <span class="hljs-built_in">console</span>.error(<span class="hljs-string">'Invalid component type provided to createComponent. Instead received:'</span>, type); }

  <span class="hljs-keyword">var</span> el;</pre></div></div>
            
        </li>
        
        
        <li id="section-184">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-184">&#182;</a>
              </div>
              <p>If this component is not in the registry, register a dehydrated component
as a placeholder. Once the actual component is loaded, all running instances
of this component type will be hydrated.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>(!REGISTRY[type] || !REGISTRY[type].isHydrated){
    el = <span class="hljs-built_in">document</span>.createElement(type);
    options.isHydrated = <span class="hljs-literal">false</span>;
    REGISTRY[type] = REGISTRY[type] || Component.extend({}, {
      isHydrated: <span class="hljs-literal">false</span>,
      type: type,
      template: DUMMY_TEMPLATE
    }, options);
    el.data = <span class="hljs-keyword">new</span> REGISTRY[type](el, data, options);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-185">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-185">&#182;</a>
              </div>
              <p>If this component is in the registry, save the instance specific data to
deliver to the createElement call, and create the element. As part of the
<code>createdCallback</code> a new instance of</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">else</span> {
    ELEMENT_DATA = { data: data, options: options };
    el = <span class="hljs-built_in">document</span>.createElement(type);
    ELEMENT_DATA = <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>;
  }

  <span class="hljs-keyword">return</span> el.data;

};

ComponentFactory.registerComponent = registerComponent;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> ComponentFactory;

<span class="hljs-keyword">import</span> hooks <span class="hljs-keyword">from</span> <span class="hljs-string">"rebound-htmlbars/hooks"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">var</span> registerHelper = hooks.registerHelper;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">var</span> registerPartial = hooks.registerPartial;</pre></div></div>
            
        </li>
        
        
        <li id="section-186">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-186">&#182;</a>
              </div>
              <h2 id="rebound-lazy-value">Rebound Lazy Value</h2>

            </div>
            
        </li>
        
        
        <li id="section-187">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-187">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">import</span> $ <span class="hljs-keyword">from</span> <span class="hljs-string">"rebound-utils/rebound-utils"</span>;

<span class="hljs-keyword">var</span> NIL = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">NIL</span>(<span class="hljs-params"></span>)</span>{},
    EMPTY_ARRAY = [];

    <span class="hljs-keyword">var</span> LAZYVALUE_COUNT = <span class="hljs-number">0</span>;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">LazyValue</span>(<span class="hljs-params">fn, options={}</span>) </span>{
  <span class="hljs-keyword">this</span>.cid = $.uniqueId(<span class="hljs-string">'lazyValue'</span>);
  <span class="hljs-keyword">this</span>.valueFn = fn;
  <span class="hljs-keyword">this</span>.cache = NIL;
  <span class="hljs-keyword">this</span>.context = options.context || <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">this</span>.children = [];
  <span class="hljs-keyword">this</span>.hash = {};
  <span class="hljs-keyword">this</span>.subscribers = [];
  <span class="hljs-keyword">this</span>.observers = [];
  <span class="hljs-keyword">this</span>.referance = <span class="hljs-number">0</span>;
  _.extend(<span class="hljs-keyword">this</span>, options);</pre></div></div>
            
        </li>
        
        
        <li id="section-188">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-188">&#182;</a>
              </div>
              <p>For each param or hash value passed to our helper’s LazyValue, add it to the
dependant list. The helper’s LazyValue will re-evaluate when one changes.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.each(options.params, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">param, index</span>)</span>{
    param || (param = <span class="hljs-string">''</span>);
    <span class="hljs-keyword">this</span>.children.push(param);
    param.isLazyValue &amp;&amp; param.onNotify(<span class="hljs-keyword">this</span>);
  }, <span class="hljs-keyword">this</span>);

  _.each(options.hash, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">value, key</span>)</span>{
    value || (value = <span class="hljs-string">''</span>);
    value.isLazyValue &amp;&amp; value.onNotify(<span class="hljs-keyword">this</span>);
    <span class="hljs-keyword">this</span>.hash[key] = value;
  }, <span class="hljs-keyword">this</span>);

}

LazyValue.prototype = {

  isLazyValue: <span class="hljs-literal">true</span>,

  get value(){</pre></div></div>
            
        </li>
        
        
        <li id="section-189">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-189">&#182;</a>
              </div>
              <p>If cache is already computed, return it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.cache !== NIL) { <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.cache; }</pre></div></div>
            
        </li>
        
        
        <li id="section-190">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-190">&#182;</a>
              </div>
              <p>Assemble our args and hash variables for the helper. For each LazyValue
param or hash, insert the evaluated value so helpers don’t need to have any
concept of lazyvalues.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> params = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Array</span>(<span class="hljs-keyword">this</span>.children.length),
        hash = {};

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, l = <span class="hljs-keyword">this</span>.children.length; i &lt; l; i++) {
      <span class="hljs-keyword">let</span> child = <span class="hljs-keyword">this</span>.children[i];
      params[i] = (child &amp;&amp; child.isLazyValue) ? child.value : child;
    }

    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> key <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span>.hash){
      <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>.hash.hasOwnProperty(key)){ <span class="hljs-keyword">continue</span>; }
      <span class="hljs-keyword">let</span> child = <span class="hljs-keyword">this</span>.hash[key];
      hash[key] = (child &amp;&amp; child.isLazyValue) ? child.value : child;
    }

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.cache = <span class="hljs-keyword">this</span>.valueFn(params, hash);
  },

  set: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">key, value, options</span>)</span>{
    <span class="hljs-keyword">return</span> (<span class="hljs-keyword">this</span>.context &amp;&amp; <span class="hljs-keyword">this</span>.context.set(key, value, options)) || <span class="hljs-literal">null</span>;
  },

  addObserver: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">path, context, env</span>) </span>{

    <span class="hljs-keyword">if</span>(!_.isObject(context) || !_.isString(path)){ <span class="hljs-keyword">return</span> <span class="hljs-built_in">console</span>.error(<span class="hljs-string">'Error adding observer for'</span>, context, path); }
    path = path.trim();
    <span class="hljs-keyword">var</span> origin = context.__path().replace(<span class="hljs-regexp">/\[[^\]]+\]/g</span>, <span class="hljs-string">".@each"</span>).trim();
    <span class="hljs-keyword">var</span> cache = env.observers[origin] || (env.observers[origin] = {});
    cache[path] || (cache[path] = []);
    <span class="hljs-keyword">var</span> position = cache[path].push(<span class="hljs-keyword">this</span>) - <span class="hljs-number">1</span>;

    <span class="hljs-keyword">this</span>.observers.push({env: env, origin: origin, path: path, index: position});

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;

  },</pre></div></div>
            
        </li>
        
        
        <li id="section-191">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-191">&#182;</a>
              </div>
              <p>Mark this LazyValue, and all who depend on it, as dirty by setting its cache
to NIL. This will force a full re-compute of its value when next requests rather
than just returning the cache object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  makeDirty: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.cache === NIL){ <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>; }
    <span class="hljs-keyword">this</span>.cache = NIL;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, l = <span class="hljs-keyword">this</span>.subscribers.length; i &lt; l; i++) {
      <span class="hljs-keyword">this</span>.subscribers[i].isLazyValue &amp;&amp; <span class="hljs-keyword">this</span>.subscribers[i].makeDirty();
    }
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-192">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-192">&#182;</a>
              </div>
              <p>Ensure that this node and all of its dependants are dirty, then call each
of its dependants. If a dependant is a LazyValue, and marked as destroyed,
remove it fromt the array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  notify: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">this</span>.makeDirty();
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, l = <span class="hljs-keyword">this</span>.subscribers.length; i &lt; l; i++) {
      <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>.subscribers[i]){ <span class="hljs-keyword">continue</span>; }
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.subscribers[i].isLazyValue){
        <span class="hljs-keyword">this</span>.subscribers[i].destroyed ? (<span class="hljs-keyword">this</span>.subscribers[i] = <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>) : <span class="hljs-keyword">this</span>.subscribers[i].notify();
      }
      <span class="hljs-keyword">else</span>{
        <span class="hljs-keyword">this</span>.subscribers[i](<span class="hljs-keyword">this</span>);
      }
    }
  },

  onNotify: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">callback</span>) </span>{
    <span class="hljs-keyword">this</span>.subscribers.push(callback);
    <span class="hljs-keyword">this</span>.referance++;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  },

  destroy: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">destroyLazyValue</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">this</span>.destroyed = <span class="hljs-literal">true</span>;

    _.each(<span class="hljs-keyword">this</span>.children, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">child</span>)</span>{
      <span class="hljs-keyword">if</span>(!child || !child.isLazyValue){ <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>; }
      <span class="hljs-keyword">if</span>(--child.referance === <span class="hljs-number">0</span>){ child.destroy(); }
    });
    _.each(<span class="hljs-keyword">this</span>.hash, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">child</span>)</span>{
      <span class="hljs-keyword">if</span>(!child || !child.isLazyValue){ <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>; }
      <span class="hljs-keyword">if</span>(--child.referance === <span class="hljs-number">0</span>){ child.destroy(); }
    });

    <span class="hljs-keyword">this</span>.subscribers = [];
    <span class="hljs-keyword">this</span>.valueFn = NIL;
    <span class="hljs-keyword">this</span>.cache = NIL;
    <span class="hljs-keyword">this</span>.children = [];
    <span class="hljs-keyword">this</span>.cache = {};

    _.each(<span class="hljs-keyword">this</span>.observers, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">observer</span>)</span>{
      <span class="hljs-keyword">if</span>(observer.env.observers[observer.origin] &amp;&amp; observer.env.observers[observer.origin][observer.path]){
        <span class="hljs-keyword">delete</span> observer.env.observers[observer.origin][observer.path][observer.index];
      }
      <span class="hljs-keyword">delete</span> observer.env;
    });

    <span class="hljs-keyword">this</span>.observers = <span class="hljs-literal">null</span>;
  }
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> LazyValue;</pre></div></div>
            
        </li>
        
        
        <li id="section-193">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-193">&#182;</a>
              </div>
              <h2 id="rebound-hooks">Rebound Hooks</h2>

            </div>
            
        </li>
        
        
        <li id="section-194">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-194">&#182;</a>
              </div>
              <p>Here we augment HTMLBars’ default hooks to make use of Rebound’s evented data
objects for automatic databinding.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">import</span> $ <span class="hljs-keyword">from</span> <span class="hljs-string">"rebound-utils/rebound-utils"</span>;
<span class="hljs-keyword">import</span> hooks <span class="hljs-keyword">from</span> <span class="hljs-string">"htmlbars-runtime/hooks"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-keyword">default</span> <span class="hljs-keyword">as</span> _render } <span class="hljs-keyword">from</span> <span class="hljs-string">"htmlbars-runtime/render"</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-195">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-195">&#182;</a>
              </div>
              <p><strong>Environment Hooks</strong> create and modify the template environment objects</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">import</span> createFreshEnv <span class="hljs-keyword">from</span> <span class="hljs-string">"rebound-htmlbars/hooks/createFreshEnv"</span>;
<span class="hljs-keyword">import</span> createChildEnv <span class="hljs-keyword">from</span> <span class="hljs-string">"rebound-htmlbars/hooks/createChildEnv"</span>;
hooks.createFreshEnv = createFreshEnv;
hooks.createChildEnv = createChildEnv;</pre></div></div>
            
        </li>
        
        
        <li id="section-196">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-196">&#182;</a>
              </div>
              <p><strong>Scope Hooks</strong> create, access and modify the template scope and data objects</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">import</span> createFreshScope <span class="hljs-keyword">from</span> <span class="hljs-string">"rebound-htmlbars/hooks/createFreshScope"</span>;
<span class="hljs-keyword">import</span> createChildScope <span class="hljs-keyword">from</span> <span class="hljs-string">"rebound-htmlbars/hooks/createChildScope"</span>;
<span class="hljs-keyword">import</span> bindScope <span class="hljs-keyword">from</span> <span class="hljs-string">"rebound-htmlbars/hooks/bindScope"</span>;
hooks.createFreshScope = createFreshScope;
hooks.createChildScope = createChildScope;
hooks.bindScope = bindScope;</pre></div></div>
            
        </li>
        
        
        <li id="section-197">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-197">&#182;</a>
              </div>
              <p><strong>Lifecycle Hooks</strong> construct, deconstruct and clean up render nodes over their lifecycles</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">import</span> linkRenderNode <span class="hljs-keyword">from</span> <span class="hljs-string">"rebound-htmlbars/hooks/linkRenderNode"</span>;
<span class="hljs-keyword">import</span> cleanupRenderNode <span class="hljs-keyword">from</span> <span class="hljs-string">"rebound-htmlbars/hooks/cleanupRenderNode"</span>;
<span class="hljs-keyword">import</span> destroyRenderNode <span class="hljs-keyword">from</span> <span class="hljs-string">"rebound-htmlbars/hooks/destroyRenderNode"</span>;
<span class="hljs-keyword">import</span> willCleanupTree <span class="hljs-keyword">from</span> <span class="hljs-string">"rebound-htmlbars/hooks/willCleanupTree"</span>;
<span class="hljs-keyword">import</span> didCleanupTree <span class="hljs-keyword">from</span> <span class="hljs-string">"rebound-htmlbars/hooks/didCleanupTree"</span>;
hooks.linkRenderNode = linkRenderNode;
hooks.willCleanupTree = willCleanupTree;
hooks.cleanupRenderNode = cleanupRenderNode;
hooks.destroyRenderNode = cleanupRenderNode;
hooks.didCleanupTree = didCleanupTree;</pre></div></div>
            
        </li>
        
        
        <li id="section-198">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-198">&#182;</a>
              </div>
              <p><strong>Streaming Hooks</strong> create streams via LazyValues for data values, helpers, subexpressions and concat groups</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">import</span> get <span class="hljs-keyword">from</span> <span class="hljs-string">"rebound-htmlbars/hooks/get"</span>;
<span class="hljs-keyword">import</span> getValue <span class="hljs-keyword">from</span> <span class="hljs-string">"rebound-htmlbars/hooks/getValue"</span>;
<span class="hljs-keyword">import</span> invokeHelper <span class="hljs-keyword">from</span> <span class="hljs-string">"rebound-htmlbars/hooks/invokeHelper"</span>;
<span class="hljs-keyword">import</span> subexpr <span class="hljs-keyword">from</span> <span class="hljs-string">"rebound-htmlbars/hooks/subexpr"</span>;
<span class="hljs-keyword">import</span> concat <span class="hljs-keyword">from</span> <span class="hljs-string">"rebound-htmlbars/hooks/concat"</span>;
hooks.get = get;
hooks.getValue = getValue;
hooks.invokeHelper = invokeHelper;
hooks.subexpr = subexpr;
hooks.concat = concat;</pre></div></div>
            
        </li>
        
        
        <li id="section-199">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-199">&#182;</a>
              </div>
              <p><strong>Render Hooks</strong> interact with the DOM to output content and bind to form elements for two way databinding</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">import</span> content <span class="hljs-keyword">from</span> <span class="hljs-string">"rebound-htmlbars/hooks/content"</span>;
<span class="hljs-keyword">import</span> attribute <span class="hljs-keyword">from</span> <span class="hljs-string">"rebound-htmlbars/hooks/attribute"</span>;
<span class="hljs-keyword">import</span> partial, { registerPartial } <span class="hljs-keyword">from</span> <span class="hljs-string">"rebound-htmlbars/hooks/partial"</span>;
<span class="hljs-keyword">import</span> component <span class="hljs-keyword">from</span> <span class="hljs-string">"rebound-htmlbars/hooks/component"</span>;
hooks.content = content;
hooks.attribute = attribute;
hooks.partial = partial;
hooks.registerPartial = registerPartial;
hooks.component = component;</pre></div></div>
            
        </li>
        
        
        <li id="section-200">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-200">&#182;</a>
              </div>
              <p><strong>Helper Hooks</strong> manage the environment’s registered helpers</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">import</span> { hasHelper, lookupHelper, registerHelper } <span class="hljs-keyword">from</span> <span class="hljs-string">"rebound-htmlbars/helpers"</span>;
hooks.hasHelper = hasHelper;
hooks.lookupHelper = lookupHelper;
hooks.registerHelper = registerHelper;</pre></div></div>
            
        </li>
        
        
        <li id="section-201">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-201">&#182;</a>
              </div>
              <p>Bind local binds a local variable to the scope object and tracks the scope
level at which that local was added. See <code>createChildScope</code> for description
of scope levels</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>hooks.bindLocal = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">bindLocal</span>(<span class="hljs-params">env, scope, name, value</span>)</span>{
  scope.localPresent[name] = scope.level;
  scope.locals[name] = value;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-202">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-202">&#182;</a>
              </div>
              <p><strong>buildRenderResult</strong> is a wrapper for the native HTMLBars render function. It
ensures every template is rendered with its own child environment, every environment
saves a referance to its unique render result for re-renders, and every render
result has a unique id.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>hooks.buildRenderResult = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">buildRenderResult</span>(<span class="hljs-params">template, env, scope, options</span>)</span>{
  <span class="hljs-keyword">var</span> render = _render.default || _render; <span class="hljs-comment">// Fix for stupid Babel imports</span>
  env = hooks.createChildEnv(env);
  env.template = render(template, env, scope, options);
  env.template.uid = $.uniqueId(<span class="hljs-string">'template'</span>);
  <span class="hljs-keyword">return</span> env.template;
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> hooks;</pre></div></div>
            
        </li>
        
        
        <li id="section-203">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-203">&#182;</a>
              </div>
              <h3 id="create-fresh-environment-hook">Create-Fresh-Environment Hook</h3>

            </div>
            
        </li>
        
        
        <li id="section-204">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-204">&#182;</a>
              </div>
              <p>Rebound’s default environment
The application environment is propagated down each render call and
augmented with helpers as it goes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">import</span> { <span class="hljs-keyword">default</span> <span class="hljs-keyword">as</span> _DOMHelper } <span class="hljs-keyword">from</span> <span class="hljs-string">"dom-helper"</span>;
<span class="hljs-keyword">import</span> helpers <span class="hljs-keyword">from</span> <span class="hljs-string">"rebound-htmlbars/helpers"</span>;

<span class="hljs-keyword">var</span> DOMHelper = _DOMHelper.default || _DOMHelper; <span class="hljs-comment">// Fix for stupid Babel imports</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createFreshEnv</span>(<span class="hljs-params"></span>)</span>{
  <span class="hljs-keyword">return</span> {
    isReboundEnv: <span class="hljs-literal">true</span>,
    cid: _.uniqueId(<span class="hljs-string">'env'</span>),
    root: <span class="hljs-literal">null</span>,
    helpers: helpers,
    hooks: <span class="hljs-keyword">this</span>,
    dom: <span class="hljs-keyword">new</span> DOMHelper(),
    revalidateQueue: {},
    observers: {},
  };
}</pre></div></div>
            
        </li>
        
        
        <li id="section-205">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-205">&#182;</a>
              </div>
              <h3 id="create-child-environment-hook">Create-Child-Environment Hook</h3>

            </div>
            
        </li>
        
        
        <li id="section-206">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-206">&#182;</a>
              </div>
              <p>Create an environment object that will inherit everything from its parent
environment until written over with a local variable.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createChildEnv</span>(<span class="hljs-params">parent</span>)</span>{
  <span class="hljs-keyword">var</span> env = <span class="hljs-built_in">Object</span>.create(parent);
  env.helpers = <span class="hljs-built_in">Object</span>.create(parent.helpers);
  <span class="hljs-keyword">return</span> env;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-207">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-207">&#182;</a>
              </div>
              <h3 id="create-fresh-scope-hook">Create-Fresh-Scope Hook</h3>

            </div>
            
        </li>
        
        
        <li id="section-208">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-208">&#182;</a>
              </div>
              <p>Rebound’s default scope object.
The scope object is propagated down each block expression or render call and
augmented with local variables as it goes. LazyValues are cached as streams
here as well. Because <code>in</code> checks have unpredictable performance, keep a
separate dictionary to track whether a local was bound.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createFreshScope</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">return</span> {
    level: <span class="hljs-number">1</span>,
    self: <span class="hljs-literal">null</span>,
    locals: {},
    localPresent: {},
    streams: {},
    blocks: {}
  };
}</pre></div></div>
            
        </li>
        
        
        <li id="section-209">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-209">&#182;</a>
              </div>
              <h3 id="create-child-scope-hook">Create-Child-Scope Hook</h3>

            </div>
            
        </li>
        
        
        <li id="section-210">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-210">&#182;</a>
              </div>
              <p>Create a scope object that will inherit everything from its parent
scope until written over with a local variable.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createChildScope</span>(<span class="hljs-params">parent</span>) </span>{
  <span class="hljs-keyword">var</span> scope = <span class="hljs-built_in">Object</span>.create(parent);
  scope.level = parent.level + <span class="hljs-number">1</span>;
  scope.locals = <span class="hljs-built_in">Object</span>.create(parent.locals);
  scope.localPresent = <span class="hljs-built_in">Object</span>.create(parent.localPresent);
  scope.streams = <span class="hljs-built_in">Object</span>.create(parent.streams);
  scope.blocks = <span class="hljs-built_in">Object</span>.create(parent.blocks);
  <span class="hljs-keyword">return</span> scope;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-211">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-211">&#182;</a>
              </div>
              <h3 id="bind-scope-hook">Bind-Scope Hook</h3>

            </div>
            
        </li>
        
        
        <li id="section-212">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-212">&#182;</a>
              </div>
              <p>Make scope available on the environment object to allow hooks to cache streams on it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">bindScope</span>(<span class="hljs-params">env, scope</span>)</span>{
  env.scope = scope;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-213">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-213">&#182;</a>
              </div>
              <h3 id="link-render-node-hook">Link-Render-Node Hook</h3>

            </div>
            
        </li>
        
        
        <li id="section-214">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-214">&#182;</a>
              </div>
              <p>Called on first creation of any expressions that interact directly with the DOM.
Whenever it is notified of any changes to it’s dependant values, mark the node
as dirty and add it to the environment’s revalidation queue to be rerendered
during the next animation frame.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">linkRenderNode</span>(<span class="hljs-params">renderNode, env, scope, path, params, hash</span>)</span>{

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">rerender</span>(<span class="hljs-params">path, node, lazyValue, env</span>)</span>{
    lazyValue.onNotify(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
      node.isDirty = <span class="hljs-literal">true</span>;
      env.template &amp;&amp; (env.revalidateQueue[env.template.uid] = env.template);
    });
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-215">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-215">&#182;</a>
              </div>
              <p>Save the path on our render node for easier debugging</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  renderNode.path = path;</pre></div></div>
            
        </li>
        
        
        <li id="section-216">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-216">&#182;</a>
              </div>
              <p>For every parameter or hash value passed to this render node, if it is a data
stream, subscribe to notifications from it and when notified of a change,
mark the node as dirty and queue it up for revalidation.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (params &amp;&amp; params.length) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; params.length; i++) {
      <span class="hljs-keyword">if</span>(params[i].isLazyValue){
        rerender(path, renderNode, params[i], env);
      }
    }
  }
  <span class="hljs-keyword">if</span> (hash) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> key <span class="hljs-keyword">in</span> hash) {
      <span class="hljs-keyword">if</span>(hash.hasOwnProperty(key) &amp;&amp; hash[key].isLazyValue){
        rerender(path, renderNode, hash[key], env);
      }
    }
  }
  <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-217">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-217">&#182;</a>
              </div>
              <h3 id="will-cleanup-tree-hook">Will-Cleanup-Tree Hook</h3>

            </div>
            
        </li>
        
        
        <li id="section-218">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-218">&#182;</a>
              </div>
              <p>Called before destroying any node tree</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">willCleanupTree</span>(<span class="hljs-params">env, morph, destroySelf</span>)</span>{

}</pre></div></div>
            
        </li>
        
        
        <li id="section-219">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-219">&#182;</a>
              </div>
              <h3 id="cleanup-render-node-hook">Cleanup-Render-Node Hook</h3>

            </div>
            
        </li>
        
        
        <li id="section-220">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-220">&#182;</a>
              </div>
              <p>Called before destroying any render node</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cleanupRenderNode</span>(<span class="hljs-params">morph</span>)</span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-221">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-221">&#182;</a>
              </div>
              <p>morph.lazyValue &amp;&amp; morph.lazyValue.destroy();</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>}</pre></div></div>
            
        </li>
        
        
        <li id="section-222">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-222">&#182;</a>
              </div>
              <h3 id="destroy-render-node-hook">Destroy-Render-Node Hook</h3>

            </div>
            
        </li>
        
        
        <li id="section-223">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-223">&#182;</a>
              </div>
              <p>Called when destroying a render node</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">destroyRenderNode</span>(<span class="hljs-params">morph</span>)</span>{

}</pre></div></div>
            
        </li>
        
        
        <li id="section-224">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-224">&#182;</a>
              </div>
              <h3 id="did-cleanup-tree-hook">Did-Cleanup-Tree Hook</h3>

            </div>
            
        </li>
        
        
        <li id="section-225">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-225">&#182;</a>
              </div>
              <p>Called after destroying any node tree</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">didCleanupTree</span>(<span class="hljs-params">env, morph, destroySelf</span>)</span>{

}</pre></div></div>
            
        </li>
        
        
        <li id="section-226">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-226">&#182;</a>
              </div>
              <h3 id="get-hook">Get Hook</h3>

            </div>
            
        </li>
        
        
        <li id="section-227">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-227">&#182;</a>
              </div>
              <p>The get hook streams a property at a named path from a given scope. It returns
a <code>LazyValue</code> that other code can subscribe to and be alerted when values change.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">import</span> $ <span class="hljs-keyword">from</span> <span class="hljs-string">"rebound-utils/rebound-utils"</span>;
<span class="hljs-keyword">import</span> LazyValue <span class="hljs-keyword">from</span> <span class="hljs-string">"rebound-htmlbars/lazy-value"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get</span>(<span class="hljs-params">env, scope, path</span>)</span>{
  <span class="hljs-keyword">var</span> context = scope.self;</pre></div></div>
            
        </li>
        
        
        <li id="section-228">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-228">&#182;</a>
              </div>
              <p>The special word <code>this</code> should referance empty string</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>(path === <span class="hljs-string">'this'</span>){ path = <span class="hljs-string">''</span>; }</pre></div></div>
            
        </li>
        
        
        <li id="section-229">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-229">&#182;</a>
              </div>
              <p>If this path referances a block param, use that as the context instead.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> rest = $.splitPath(path);
  <span class="hljs-keyword">var</span> key = rest.shift();
  <span class="hljs-keyword">if</span>(scope.localPresent[key]){
    context = scope.locals[key];
    path = rest.join(<span class="hljs-string">'.'</span>);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-230">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-230">&#182;</a>
              </div>
              <p>If this value is not a local value, and there is a stream present
If this value is a local, but not at this scope layer, and there is</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>(scope.streams[path] &amp;&amp;
      (!scope.streams[path].layer &amp;&amp; !scope.localPresent[key] || scope.streams[path].layer === scope.localPresent[key])){ <span class="hljs-keyword">return</span> scope.streams[path]; }</pre></div></div>
            
        </li>
        
        
        <li id="section-231">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-231">&#182;</a>
              </div>
              <p>Given a context and a path, create a LazyValue object that returns
the value of object at path and add an observer to the context at path.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">return</span> scope.streams[path] = <span class="hljs-keyword">new</span> LazyValue(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.context.get(<span class="hljs-keyword">this</span>.path, {isPath: <span class="hljs-literal">true</span>});
    }, {
      context: context,
      path: path,
      layer: scope.localPresent[key]
    }).addObserver(path, context, env);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-232">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-232">&#182;</a>
              </div>
              <h3 id="invoke-helper-hook">Invoke-Helper Hook</h3>

            </div>
            
        </li>
        
        
        <li id="section-233">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-233">&#182;</a>
              </div>
              <p>The <code>invokeHelper</code> hook streams a the result of a helper function. It returns
a <code>LazyValue</code> that other code can subscribe to and be alerted when values change.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">import</span> $ <span class="hljs-keyword">from</span> <span class="hljs-string">"rebound-utils/rebound-utils"</span>;
<span class="hljs-keyword">import</span> LazyValue <span class="hljs-keyword">from</span> <span class="hljs-string">"rebound-htmlbars/lazy-value"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">invokeHelper</span>(<span class="hljs-params">morph, env, scope, visitor, params, hash, helper, templates, context</span>)</span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-234">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-234">&#182;</a>
              </div>
              <p>If this is not a valid helper, log an error and return an empty string value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>(!_.isFunction(helper)){
    <span class="hljs-built_in">console</span>.error(<span class="hljs-string">'Invalid helper!'</span>, helper);
    <span class="hljs-keyword">return</span> {value: <span class="hljs-string">''</span>};
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-235">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-235">&#182;</a>
              </div>
              <p>Each helper LazyValue is unique to its inputs. Compute it’s unique name.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> name = <span class="hljs-string">`<span class="hljs-subst">${helper.name}</span>:`</span>;
  _.each(params, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">param, index</span>)</span>{
    name += <span class="hljs-string">` <span class="hljs-subst">${(param &amp;&amp; param.isLazyValue) ? param.cid : param}</span>`</span>;
  });
  _.each(hash, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">hash, key</span>)</span>{
    name += <span class="hljs-string">` <span class="hljs-subst">${key}</span>=<span class="hljs-subst">${hash.cid}</span>`</span>;
  });</pre></div></div>
            
        </li>
        
        
        <li id="section-236">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-236">&#182;</a>
              </div>
              <p>Check the stream cache for this LazyValue, return it if it exists.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>(scope.streams[name]){ <span class="hljs-keyword">return</span> scope.streams[name]; }</pre></div></div>
            
        </li>
        
        
        <li id="section-237">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-237">&#182;</a>
              </div>
              <p>Create a LazyValue that returns the value of our evaluated helper.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> lazyValue = <span class="hljs-keyword">new</span> LazyValue(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">params, hash</span>)</span>{
    <span class="hljs-keyword">return</span> helper.call((context || {}), params, hash, templates, env);
  }, {
    path: name,
    params: params,
    hash: hash
  });</pre></div></div>
            
        </li>
        
        
        <li id="section-238">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-238">&#182;</a>
              </div>
              <p>If this is not a block or element helper, cache the new lazyValue.
Only block helpers will have a context set passed. Non-element helpers will
have the morph set. Block and morph helpers have re-rendered dom that must
be fresh in the LazyValue’s closure each run.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>(!context &amp;&amp; morph){ scope.streams[name] = lazyValue; }</pre></div></div>
            
        </li>
        
        
        <li id="section-239">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-239">&#182;</a>
              </div>
              <p>Seed the cache and return the new LazyValue</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  lazyValue.value;
  <span class="hljs-keyword">return</span> lazyValue;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-240">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-240">&#182;</a>
              </div>
              <h3 id="get-value-hook">Get Value Hook</h3>

            </div>
            
        </li>
        
        
        <li id="section-241">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-241">&#182;</a>
              </div>
              <p>The getValue hook retreives the value of the passed in referance.
It will return the propper value regardless of if the referance passed is the
value itself, or a LazyValue.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getValue</span>(<span class="hljs-params">referance</span>)</span>{
  <span class="hljs-keyword">return</span> (referance &amp;&amp; referance.isLazyValue) ? referance.value : referance;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-242">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-242">&#182;</a>
              </div>
              <h3 id="subexpr-hook">Subexpr Hook</h3>

            </div>
            
        </li>
        
        
        <li id="section-243">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-243">&#182;</a>
              </div>
              <p>The <code>subexpr</code> hook creates a LazyValue for a nexted expression so it may be
used as a single data point in its parent expression. For example:</p>
<pre><code>{{#if (equal (add 1 2) 3)}}True!{{/if}}
</code></pre><p>The <code>if</code> block expression contains a subexpression that is the evalued value
of the <code>equal</code> helper, which in turn contains a subexpression that is the
evalued value of the <code>add</code> helper. Each subexpression is represented internally
by a single LazyValue that notifies its subscribers when it changes.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">subexpr</span>(<span class="hljs-params">env, scope, helperName, params, hash</span>) </span>{
  <span class="hljs-keyword">var</span> helper = <span class="hljs-keyword">this</span>.lookupHelper(helperName, env);</pre></div></div>
            
        </li>
        
        
        <li id="section-244">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-244">&#182;</a>
              </div>
              <p>Return the apropreate LazyValue for this subexpression type.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (helper) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.invokeHelper(<span class="hljs-literal">null</span>, env, scope, <span class="hljs-literal">null</span>, params, hash, helper, {}, <span class="hljs-literal">undefined</span>);
  }

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.get(env, scope, helperName);

}</pre></div></div>
            
        </li>
        
        
        <li id="section-245">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-245">&#182;</a>
              </div>
              <h3 id="concat-hook">Concat Hook</h3>

            </div>
            
        </li>
        
        
        <li id="section-246">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-246">&#182;</a>
              </div>
              <p>The <code>concat</code> hook creates a LazyValue for adjacent expressions so they may be
used as a single data point in its parent expression. For example:</p>
<pre><code>&lt;div <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">"{{foo}} active {{bar}}"</span>&gt;<span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
</code></pre><p>The div’s attribute expression is passed a concat LazyValue that alerts its
subscribers whenever any of its dynamic values change.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">var</span> CONCAT_CACHE = {};

<span class="hljs-keyword">import</span> LazyValue <span class="hljs-keyword">from</span> <span class="hljs-string">"rebound-htmlbars/lazy-value"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">concat</span>(<span class="hljs-params">env, params</span>)</span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-247">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-247">&#182;</a>
              </div>
              <p>If the concat expression only contains a single value, return it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>(params.length === <span class="hljs-number">1</span>){ <span class="hljs-keyword">return</span> params[<span class="hljs-number">0</span>]; }</pre></div></div>
            
        </li>
        
        
        <li id="section-248">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-248">&#182;</a>
              </div>
              <p>Each concat LazyValue is unique to its inputs. Compute it’s unique name.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> name = <span class="hljs-string">"concat: "</span>;
  _.each(params, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">param, index</span>)</span>{
    name += <span class="hljs-string">`<span class="hljs-subst">${((param &amp;&amp; param.isLazyValue) ? param.cid : param )}</span>`</span>;
  });</pre></div></div>
            
        </li>
        
        
        <li id="section-249">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-249">&#182;</a>
              </div>
              <p>Check the streams cache and return if this LazyValue has already been made</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>(CONCAT_CACHE[name]){ <span class="hljs-keyword">return</span> CONCAT_CACHE[name]; }</pre></div></div>
            
        </li>
        
        
        <li id="section-250">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-250">&#182;</a>
              </div>
              <p>Create a lazyvalue that returns the concatted values of all input params
Add it to the streams cache and return</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">return</span> CONCAT_CACHE[name] = <span class="hljs-keyword">new</span> LazyValue(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">params</span>) </span>{
    <span class="hljs-keyword">return</span> params.join(<span class="hljs-string">''</span>);
  }, {
    context: params[<span class="hljs-number">0</span>].context,
    path: name,
    params: params
  });

}</pre></div></div>
            
        </li>
        
        
        <li id="section-251">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-251">&#182;</a>
              </div>
              <h3 id="content-hook">Content Hook</h3>

            </div>
            
        </li>
        
        
        <li id="section-252">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-252">&#182;</a>
              </div>
              <p>Content Hook</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">content</span>(<span class="hljs-params">morph, env, context, path, lazyValue</span>)</span>{
  <span class="hljs-keyword">var</span> el = morph.contextualElement;</pre></div></div>
            
        </li>
        
        
        <li id="section-253">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-253">&#182;</a>
              </div>
              <p>Two way databinding for textareas</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>(el.tagName === <span class="hljs-string">'TEXTAREA'</span>){
    lazyValue.onNotify(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">updateTextarea</span>(<span class="hljs-params">lazyValue</span>)</span>{
      el.value = lazyValue.value;
    });
    $(el).on(<span class="hljs-string">'change keyup'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">updateTextareaLazyValue</span>(<span class="hljs-params">event</span>)</span>{
      lazyValue.set(lazyValue.path, <span class="hljs-keyword">this</span>.value);
    });
  }

  morph.lazyValue = lazyValue;

  <span class="hljs-keyword">return</span> lazyValue.value;

}</pre></div></div>
            
        </li>
        
        
        <li id="section-254">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-254">&#182;</a>
              </div>
              <h3 id="attribute-hook">Attribute Hook</h3>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">import</span> $ <span class="hljs-keyword">from</span> <span class="hljs-string">"rebound-utils/rebound-utils"</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-255">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-255">&#182;</a>
              </div>
              <p>All valid text based HTML input types</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> TEXT_INPUTS = { <span class="hljs-string">"null"</span>: <span class="hljs-number">1</span>,  text: <span class="hljs-number">1</span>,  email: <span class="hljs-number">1</span>, password: <span class="hljs-number">1</span>,
                       search: <span class="hljs-number">1</span>, url: <span class="hljs-number">1</span>,   tel: <span class="hljs-number">1</span>,   hidden: <span class="hljs-number">1</span>,
                       number: <span class="hljs-number">1</span>, color: <span class="hljs-number">1</span>, date: <span class="hljs-number">1</span>,  datetime: <span class="hljs-number">1</span>,
                       month: <span class="hljs-number">1</span>,  range: <span class="hljs-number">1</span>, time: <span class="hljs-number">1</span>,  week: <span class="hljs-number">1</span>,
                      <span class="hljs-string">"datetime-local"</span>: <span class="hljs-number">1</span>
                    };</pre></div></div>
            
        </li>
        
        
        <li id="section-256">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-256">&#182;</a>
              </div>
              <p>All valid boolean HTML input types</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> BOOLEAN_INPUTS = { checkbox: <span class="hljs-number">1</span>, radio: <span class="hljs-number">1</span> };</pre></div></div>
            
        </li>
        
        
        <li id="section-257">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-257">&#182;</a>
              </div>
              <p>Attribute Hook</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">attribute</span>(<span class="hljs-params">attrMorph, env, scope, name, value</span>)</span>{

  <span class="hljs-keyword">var</span> val = value.isLazyValue ? value.value : value,
      el = attrMorph.element,
      tagName = el.tagName,
      type = el.getAttribute(<span class="hljs-string">"type"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-258">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-258">&#182;</a>
              </div>
              <p>If this is a text input element’s value prop, wire up our databinding</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>( tagName === <span class="hljs-string">'INPUT'</span> &amp;&amp; TEXT_INPUTS[type] &amp;&amp; name === <span class="hljs-string">'value'</span> ){</pre></div></div>
            
        </li>
        
        
        <li id="section-259">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-259">&#182;</a>
              </div>
              <p>If our input events have not been bound yet, bind them</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(!attrMorph.eventsBound){
      $(el).on(<span class="hljs-string">'change input propertychange'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>)</span>{
        value.set(value.path, <span class="hljs-keyword">this</span>.value);
      });
      attrMorph.eventsBound = <span class="hljs-literal">true</span>;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-260">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-260">&#182;</a>
              </div>
              <p>Set the value property of the input</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    el.value = val ? <span class="hljs-built_in">String</span>(val) : <span class="hljs-string">''</span>;
  }

  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>( tagName === <span class="hljs-string">'INPUT'</span> &amp;&amp; BOOLEAN_INPUTS[type] &amp;&amp; name === <span class="hljs-string">'checked'</span> ){</pre></div></div>
            
        </li>
        
        
        <li id="section-261">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-261">&#182;</a>
              </div>
              <p>If our input events have not been bound yet, bind them</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(!attrMorph.eventsBound){
      $(el).on(<span class="hljs-string">'change propertychange'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>)</span>{
        value.set(value.path, ((<span class="hljs-keyword">this</span>.checked) ? <span class="hljs-literal">true</span> : <span class="hljs-literal">false</span>));
      });
      attrMorph.eventsBound = <span class="hljs-literal">true</span>;
    }

    el.checked = (val) ? <span class="hljs-literal">true</span> : <span class="hljs-literal">undefined</span>;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-262">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-262">&#182;</a>
              </div>
              <p>Special case for link elements with dynamic classes.
If the router has assigned it a truthy ‘active’ property, ensure that the extra class is present on re-render.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>( tagName === <span class="hljs-string">'A'</span> &amp;&amp; name === <span class="hljs-string">'class'</span> &amp;&amp; el.active ){
    val = val ? <span class="hljs-built_in">String</span>(val) + <span class="hljs-string">' active'</span> : <span class="hljs-string">'active'</span>;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-263">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-263">&#182;</a>
              </div>
              <p>Set the attribute on our element for visual referance</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  val ? el.setAttribute(name, <span class="hljs-built_in">String</span>(val)) : el.removeAttribute(name);

  <span class="hljs-keyword">this</span>.linkRenderNode(attrMorph, env, scope, <span class="hljs-string">'@attribute'</span>, [value], {});

}

<span class="hljs-keyword">import</span> $ <span class="hljs-keyword">from</span> <span class="hljs-string">"rebound-utils/rebound-utils"</span>;
<span class="hljs-keyword">import</span> loader <span class="hljs-keyword">from</span> <span class="hljs-string">"rebound-router/loader"</span>;
<span class="hljs-keyword">import</span> LazyValue <span class="hljs-keyword">from</span> <span class="hljs-string">"rebound-htmlbars/lazy-value"</span>;

<span class="hljs-keyword">var</span> PARTIALS = {};

<span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">registerPartial</span>(<span class="hljs-params">name, template</span>)</span>{
  <span class="hljs-keyword">if</span>(template &amp;&amp; _.isString(name)){</pre></div></div>
            
        </li>
        
        
        <li id="section-264">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-264">&#182;</a>
              </div>
              <p>If this partial has a callback list associated with its name, call all of
the callbacks before registering the partial.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">Array</span>.isArray(PARTIALS[name])){
      PARTIALS[name].forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">cb</span>) </span>{ cb(template); });
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-265">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-265">&#182;</a>
              </div>
              <p>Save the partial template in our cache and return it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    loader.register(<span class="hljs-string">'/'</span>+name+<span class="hljs-string">'.js'</span>);
    <span class="hljs-keyword">return</span> PARTIALS[name] = template;
  }
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">partial</span>(<span class="hljs-params">renderNode, env, scope, path</span>)</span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-266">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-266">&#182;</a>
              </div>
              <p>If no path is passed, yell</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>(!path){ <span class="hljs-built_in">console</span>.error(<span class="hljs-string">'Partial helper must be passed a path!'</span>); }</pre></div></div>
            
        </li>
        
        
        <li id="section-267">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-267">&#182;</a>
              </div>
              <p>Resolve our path value</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  path = path.isLazyValue ? path.value : path;</pre></div></div>
            
        </li>
        
        
        <li id="section-268">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-268">&#182;</a>
              </div>
              <p>Create new child scope for partial</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  scope = <span class="hljs-keyword">this</span>.createChildScope(scope);

  <span class="hljs-keyword">var</span> render = <span class="hljs-keyword">this</span>.buildRenderResult;</pre></div></div>
            
        </li>
        
        
        <li id="section-269">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-269">&#182;</a>
              </div>
              <p>Because of how htmlbars works with re-renders, we need a contextual element
for our partial that will not disappear on it when lazy partials are loaded.
We use a <code>&lt;rebound-partial&gt;</code> element for this.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> node = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'rebound-partial'</span>);
  node.setAttribute(<span class="hljs-string">'path'</span>, path);</pre></div></div>
            
        </li>
        
        
        <li id="section-270">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-270">&#182;</a>
              </div>
              <p>If a partial is registered with this path name, render it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>(PARTIALS[path] &amp;&amp; !<span class="hljs-built_in">Array</span>.isArray(PARTIALS[path])){
    node.appendChild(render(PARTIALS[path], env, scope, { contextualElement: renderNode}).fragment);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-271">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-271">&#182;</a>
              </div>
              <p>If this partial is not yet registered, add it to a callback list to be called
when registered. When registered, replace the dummy node we created with the
rendered partial template.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">else</span>{
    PARTIALS[path] || (PARTIALS[path] = []);
    PARTIALS[path].push(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">partialCallback</span>(<span class="hljs-params">template</span>)</span>{
      node.appendChild(render(template, env, scope, { contextualElement: renderNode}).fragment, node);
    });
  }

  <span class="hljs-keyword">return</span> node;

}

<span class="hljs-keyword">import</span> { $, REBOUND_SYMBOL } <span class="hljs-keyword">from</span> <span class="hljs-string">"rebound-utils/rebound-utils"</span>;
<span class="hljs-keyword">import</span> Component <span class="hljs-keyword">from</span> <span class="hljs-string">"rebound-component/factory"</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-272">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-272">&#182;</a>
              </div>
              <p>All valid HTML attributes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>const ATTRIBUTES = {  abbr: 1,      "accept-charset": 1,   accept: 1,      accesskey: 1,     action: 1,
                      align: 1,      alink: 1,             alt: 1,         archive: 1,       axis: 1,
                      background: 1, bgcolor: 1,           border: 1,      cellpadding: 1,   cellspacing: 1,
                      char: 1,       charoff: 1,           charset: 1,     checked: 1,       cite: 1,
                      class: 1,      classid: 1,           clear: 1,       code: 1,          codebase: 1,
                      codetype: 1,   color: 1,             cols: 1,        colspan: 1,       compact: 1,
                      content: 1,    coords: 1,            data: 1,        datetime: 1,      declare: 1,
                      defer: 1,      dir: 1,               disabled: 1,    enctype: 1,       face: 1,
                      for: 1,        frame: 1,             frameborder: 1, headers: 1,       height: 1,
                      href: 1,       hreflang: 1,          hspace: 1,     "http-equiv": 1,   id: 1,
                      ismap: 1,      label: 1,             lang: 1,        language: 1,      link: 1,
                      longdesc: 1,   marginheight: 1,      marginwidth: 1, maxlength: 1,     media: 1,
                      method: 1,     multiple: 1,          name: 1,        nohref: 1,        noresize: 1,
                      noshade: 1,    nowrap: 1,            object: 1,      onblur: 1,        onchange: 1,
                      onclick: 1,    ondblclick: 1,        onfocus: 1,     onkeydown: 1,     onkeypress: 1,
                      onkeyup: 1,    onload: 1,            onmousedown: 1, onmousemove: 1,   onmouseout: 1,
                      onmouseover: 1,onmouseup: 1,         onreset: 1,     onselect: 1,      onsubmit: 1,
                      onunload: 1,   profile: 1,           prompt: 1,      readonly: 1,      rel: 1,
                      rev: 1,        rows: 1,              rowspan: 1,     rules: 1,         scheme: 1,
                      scope: 1,      scrolling: 1,         selected: 1,    shape: 1,         size: 1,
                      span: 1,       src: 1,               standby: 1,     start: 1,         style: 1,
                      summary: 1,    tabindex: 1,          target: 1,      text: 1,          title: 1,
                      type: 1,       usemap: 1,            valign: 1,      value: 1,         valuetype: 1,
                      version: 1,    vlink: 1,             vspace: 1,      width: 1  };

export default function component(morph, env, scope, tagName, params, attrs, templates, visitor) {</pre></div></div>
            
        </li>
        
        
        <li id="section-273">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-273">&#182;</a>
              </div>
              <p>Components are only ever rendered once</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (morph.componentIsRendered){ <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>; }

  <span class="hljs-keyword">var</span> component, element, outlet,
      render = <span class="hljs-keyword">this</span>.buildRenderResult,
      seedData = {},
      componentData = {};</pre></div></div>
            
        </li>
        
        
        <li id="section-274">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-274">&#182;</a>
              </div>
              <p>Create a plain data object to pass to our new component as seed data</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> key <span class="hljs-keyword">in</span> attrs){ seedData[key] = <span class="hljs-keyword">this</span>.getValue(attrs[key]); }</pre></div></div>
            
        </li>
        
        
        <li id="section-275">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-275">&#182;</a>
              </div>
              <p>For each param passed to our shared component, add it to our custom element</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  component = Component(tagName, seedData, {[REBOUND_SYMBOL]: {templates: templates, env: env, scope: scope}});
  element = component.el;

  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> key <span class="hljs-keyword">in</span> seedData){</pre></div></div>
            
        </li>
        
        
        <li id="section-276">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-276">&#182;</a>
              </div>
              <p>For each param passed to our component, create its lazyValue</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    componentData[key] = <span class="hljs-keyword">this</span>.get(component.env, component.scope, key);</pre></div></div>
            
        </li>
        
        
        <li id="section-277">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-277">&#182;</a>
              </div>
              <p>Set up two way binding between component and original context</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(componentData[key].isLazyValue &amp;&amp; attrs[key].isLazyValue){</pre></div></div>
            
        </li>
        
        
        <li id="section-278">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-278">&#182;</a>
              </div>
              <p>For each lazy param passed to our component, have it update the original context when changed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      componentData[key].onNotify(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
        attrs[key].set(attrs[key].path, componentData[key].value);
      });</pre></div></div>
            
        </li>
        
        
        <li id="section-279">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-279">&#182;</a>
              </div>
              <p>For each lazy param passed to our component, have it update the component when changed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      attrs[key].onNotify(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
        componentData[key].set(key, attrs[key].value);
      });</pre></div></div>
            
        </li>
        
        
        <li id="section-280">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-280">&#182;</a>
              </div>
              <p>Seed the cache</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      componentData[key].value;

    }
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-281">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-281">&#182;</a>
              </div>
              <p>TODO: Move this to Component
// For each change on our component, update the states of the original context and the element’s proeprties.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">updateAttrs</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> json = component.toJSON();

    <span class="hljs-keyword">if</span> (_.isString(json)) <span class="hljs-keyword">return</span>; <span class="hljs-comment">// If is a string, this model is seralizing already</span></pre></div></div>
            
        </li>
        
        
        <li id="section-282">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-282">&#182;</a>
              </div>
              <p>Set the properties on our element for visual referance if we are on a top level attribute</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    _.each(json, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">value, key</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-283">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-283">&#182;</a>
              </div>
              <p>TODO: Currently, showing objects as properties on the custom element causes problems.
Linked models between the context and component become the same exact model and all hell breaks loose.
Find a way to remedy this. Until then, don’t show objects.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (_.isObject(value) || _.isUndefined(value)) { <span class="hljs-keyword">return</span>; }
      value = _.isObject(value) ? <span class="hljs-built_in">JSON</span>.stringify(value) : value;
      <span class="hljs-keyword">try</span> {
        ATTRIBUTES[key] ? element.setAttribute(key, value) : element.dataset[key] = value;
      } <span class="hljs-keyword">catch</span> (e) {
        <span class="hljs-built_in">console</span>.error(e.message);
      }
    });
  }
  component.listenTo(component, <span class="hljs-string">'change'</span>, updateAttrs);
  updateAttrs();

  <span class="hljs-comment">/** The attributeChangedCallback on our custom element updates the component's data. **/</span>

  morph.setNode(element);
  morph.componentIsRendered = <span class="hljs-literal">true</span>;

}</pre></div></div>
            
        </li>
        
        
        <li id="section-284">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-284">&#182;</a>
              </div>
              <h2 id="rebound-helpers">Rebound Helpers</h2>

            </div>
            
        </li>
        
        
        <li id="section-285">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-285">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">import</span> $ <span class="hljs-keyword">from</span> <span class="hljs-string">"rebound-utils/rebound-utils"</span>;
<span class="hljs-keyword">import</span> LazyValue <span class="hljs-keyword">from</span> <span class="hljs-string">"rebound-htmlbars/lazy-value"</span>;

<span class="hljs-keyword">var</span> HELPERS  = {};

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">NOOP</span>(<span class="hljs-params"></span>)</span>{ <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>; }

<span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">hasHelper</span>(<span class="hljs-params">env, scope, name</span>) </span>{
  (env &amp;&amp; env.helpers) || (env = { helpers: HELPERS });
  <span class="hljs-keyword">return</span> !!(HELPERS[name] || env.helpers[name]);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-286">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-286">&#182;</a>
              </div>
              <p>lookupHelper returns the given function from the helpers object. Manual checks prevent user from overriding reserved words.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">lookupHelper</span>(<span class="hljs-params">env, scope, name</span>) </span>{
  <span class="hljs-keyword">if</span>(_.isString(env)){ name = env; }
  (env &amp;&amp; env.helpers) || (env = { helpers: HELPERS });</pre></div></div>
            
        </li>
        
        
        <li id="section-287">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-287">&#182;</a>
              </div>
              <p>If <code>name</code> is a reserved helper, return it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>(name === <span class="hljs-string">'length'</span>)    <span class="hljs-keyword">return</span> HELPERS.length;
  <span class="hljs-keyword">if</span>(name === <span class="hljs-string">'if'</span>)        <span class="hljs-keyword">return</span> HELPERS.if;
  <span class="hljs-keyword">if</span>(name === <span class="hljs-string">'unless'</span>)    <span class="hljs-keyword">return</span> HELPERS.unless;
  <span class="hljs-keyword">if</span>(name === <span class="hljs-string">'each'</span>)      <span class="hljs-keyword">return</span> HELPERS.each;
  <span class="hljs-keyword">if</span>(name === <span class="hljs-string">'on'</span>)        <span class="hljs-keyword">return</span> HELPERS.on;
  <span class="hljs-keyword">if</span>(name === <span class="hljs-string">'debugger'</span>)  <span class="hljs-keyword">return</span> HELPERS.debugger;
  <span class="hljs-keyword">if</span>(name === <span class="hljs-string">'log'</span>)       <span class="hljs-keyword">return</span> HELPERS.log;</pre></div></div>
            
        </li>
        
        
        <li id="section-288">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-288">&#182;</a>
              </div>
              <p>If not a reserved helper, check env, then global helpers, or return undefined.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>(!hasHelper(env, <span class="hljs-literal">null</span>, name)){ <span class="hljs-built_in">console</span>.error(<span class="hljs-string">'No helper named'</span>, name, <span class="hljs-string">'registered with Rebound'</span>); }
  <span class="hljs-keyword">return</span> HELPERS[name] || env.helpers[name] || NOOP;
}

<span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">registerHelper</span>(<span class="hljs-params">name, callback, env</span>)</span>{
  <span class="hljs-keyword">if</span>(!_.isString(name)) <span class="hljs-keyword">return</span> <span class="hljs-built_in">console</span>.error(<span class="hljs-string">'Name provided to registerHelper must be a string!'</span>);
  <span class="hljs-keyword">if</span>(!_.isFunction(callback)) <span class="hljs-keyword">return</span> <span class="hljs-built_in">console</span>.error(<span class="hljs-string">'Callback provided to regierHelper must be a function!'</span>);
  <span class="hljs-keyword">if</span>(hasHelper(env, <span class="hljs-literal">null</span>, name)) <span class="hljs-keyword">return</span> <span class="hljs-built_in">console</span>.error(<span class="hljs-string">'A helper called "'</span> + name + <span class="hljs-string">'" is already registered!'</span>);

  HELPERS[name] = callback;

}

<span class="hljs-comment">/*******************************
        Default helpers
********************************/</span>

HELPERS.debugger = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">debuggerHelper</span>(<span class="hljs-params">params, hash, options, env</span>)</span>{
  <span class="hljs-comment">/* jshint -W087 */</span>
  <span class="hljs-keyword">debugger</span>;
  <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>;
};

HELPERS.log = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">logHelper</span>(<span class="hljs-params">params, hash, options, env</span>)</span>{
  <span class="hljs-built_in">console</span>.log.apply(<span class="hljs-built_in">console</span>, params);
  <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>;
};

HELPERS.on = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onHelper</span>(<span class="hljs-params">params, hash, options, env</span>)</span>{
  <span class="hljs-keyword">var</span> i, callback, delegate, element,
      eventName = params[<span class="hljs-number">0</span>],
      len = params.length;</pre></div></div>
            
        </li>
        
        
        <li id="section-289">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-289">&#182;</a>
              </div>
              <p>By default everything is delegated on the parent component</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>(len === <span class="hljs-number">2</span>){
    callback = params[<span class="hljs-number">1</span>];
    delegate = options.element;
    element = options.element;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-290">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-290">&#182;</a>
              </div>
              <p>If a selector is provided, delegate on the helper’s element</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(len === <span class="hljs-number">3</span>){
    callback = params[<span class="hljs-number">2</span>];
    delegate = params[<span class="hljs-number">1</span>];
    element = options.element;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-291">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-291">&#182;</a>
              </div>
              <p>Attach event</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  $(element).on(eventName, delegate, hash, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>)</span>{
    <span class="hljs-keyword">if</span>(!_.isFunction(env.root[callback])){ <span class="hljs-keyword">throw</span> <span class="hljs-string">"ERROR: No method named "</span> + callback + <span class="hljs-string">" on component "</span> + env.root.tagName + <span class="hljs-string">"!"</span>; }
    <span class="hljs-keyword">return</span> env.root[callback].call(env.root, event);
  });
};

HELPERS.length = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">lengthHelper</span>(<span class="hljs-params">params, hash, options, env</span>)</span>{
    <span class="hljs-keyword">return</span> params[<span class="hljs-number">0</span>] &amp;&amp; params[<span class="hljs-number">0</span>].length || <span class="hljs-number">0</span>;
};

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isTruthy</span>(<span class="hljs-params">condition</span>)</span>{

  <span class="hljs-keyword">if</span>(condition === <span class="hljs-literal">true</span> || condition === <span class="hljs-literal">false</span>){ <span class="hljs-keyword">return</span> condition; }</pre></div></div>
            
        </li>
        
        
        <li id="section-292">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-292">&#182;</a>
              </div>
              <p>Handle null values</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>(condition === <span class="hljs-literal">undefined</span> || condition === <span class="hljs-literal">null</span>){ <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; }</pre></div></div>
            
        </li>
        
        
        <li id="section-293">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-293">&#182;</a>
              </div>
              <p>Handle models</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>(condition.isModel){ <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; }</pre></div></div>
            
        </li>
        
        
        <li id="section-294">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-294">&#182;</a>
              </div>
              <p>Handle arrays and collection</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>(_.isArray(condition) || condition.isCollection){ <span class="hljs-keyword">return</span> !!condition.length; }</pre></div></div>
            
        </li>
        
        
        <li id="section-295">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-295">&#182;</a>
              </div>
              <p>Handle string values</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>(condition === <span class="hljs-string">'true'</span>){ <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; }
  <span class="hljs-keyword">if</span>(condition === <span class="hljs-string">'false'</span>){ <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; }

  <span class="hljs-keyword">return</span> !!condition;
}

HELPERS.if = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ifHelper</span>(<span class="hljs-params">params, hash, templates</span>)</span>{

  <span class="hljs-keyword">var</span> condition = isTruthy(params[<span class="hljs-number">0</span>]);</pre></div></div>
            
        </li>
        
        
        <li id="section-296">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-296">&#182;</a>
              </div>
              <p>If yield does not exist, this is not a block helper.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>.yield) {
    <span class="hljs-keyword">return</span> (condition) ? params[<span class="hljs-number">1</span>] : ( params[<span class="hljs-number">2</span>] || <span class="hljs-string">''</span>);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-297">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-297">&#182;</a>
              </div>
              <p>Render the apropreate block statement</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>(condition &amp;&amp; <span class="hljs-keyword">this</span>.yield) {
    <span class="hljs-keyword">this</span>.yield();
  }
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(!condition &amp;&amp; templates.inverse &amp;&amp; templates.inverse.yield) {
    templates.inverse.yield();
  }
  <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>;
  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-298">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-298">&#182;</a>
              </div>
              <p>Unless proxies to the if helper with an inverted conditional value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>HELPERS.unless = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">unlessHelper</span>(<span class="hljs-params">params, hash, templates</span>)</span>{
  params[<span class="hljs-number">0</span>] = !isTruthy(params[<span class="hljs-number">0</span>]);
  <span class="hljs-keyword">return</span> HELPERS.if.apply(<span class="hljs-keyword">this</span>, [params, hash, templates]);
};

HELPERS.each = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">eachHelper</span>(<span class="hljs-params">params, hash, templates</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-299">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-299">&#182;</a>
              </div>
              <p>If no data passed, exit</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>(!params[<span class="hljs-number">0</span>]){ <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>; }</pre></div></div>
            
        </li>
        
        
        <li id="section-300">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-300">&#182;</a>
              </div>
              <p>Accepts collections, arrays, models, or objects</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> value = params[<span class="hljs-number">0</span>].isCollection ? params[<span class="hljs-number">0</span>].models : (params[<span class="hljs-number">0</span>].isModel ? params[<span class="hljs-number">0</span>].attributes : params[<span class="hljs-number">0</span>]);</pre></div></div>
            
        </li>
        
        
        <li id="section-301">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-301">&#182;</a>
              </div>
              <p>If the scope has values, render them</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (value &amp;&amp; ((_.isArray(value) &amp;&amp; value.length &gt; <span class="hljs-number">0</span>) || (_.isObject(value) &amp;&amp; <span class="hljs-built_in">Object</span>.keys(value).length &gt; <span class="hljs-number">0</span>))) {</pre></div></div>
            
        </li>
        
        
        <li id="section-302">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-302">&#182;</a>
              </div>
              <p>For each value in the array, yield using that data model</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> key <span class="hljs-keyword">in</span> value) {
      <span class="hljs-keyword">let</span> eachId = (value[key] &amp;&amp; value[key].isData) ? value[key].cid : params[<span class="hljs-number">0</span>].cid + key;
      <span class="hljs-keyword">if</span> (value.hasOwnProperty(key)){ <span class="hljs-keyword">this</span>.yieldItem(eachId, [value[key], key]); }
    }
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-303">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-303">&#182;</a>
              </div>
              <p>Otherwise, render the inverse template</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">if</span>(templates.inverse &amp;&amp; templates.inverse[<span class="hljs-string">"yield"</span>]){ templates.inverse[<span class="hljs-string">"yield"</span>](); }
  }

};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> HELPERS;

<span class="hljs-keyword">import</span> { compileSpec } <span class="hljs-keyword">from</span> <span class="hljs-string">"htmlbars"</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-304">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-304">&#182;</a>
              </div>
              <p>Return an executable function (object) version of the compiled template string</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">compile</span>(<span class="hljs-params">string</span>)</span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Function</span>(<span class="hljs-string">"return "</span> + compileSpec(string))(); <span class="hljs-comment">// jshint ignore:line</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-305">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-305">&#182;</a>
              </div>
              <p>Return a precompiled (string) version of the compiled template string</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">precompile</span>(<span class="hljs-params">string</span>)</span>{
  <span class="hljs-keyword">return</span> compileSpec(string);
}
<span class="hljs-keyword">import</span> { $, REBOUND_SYMBOL } <span class="hljs-keyword">from</span> <span class="hljs-string">"rebound-utils/rebound-utils"</span>;
<span class="hljs-keyword">import</span> _hooks <span class="hljs-keyword">from</span> <span class="hljs-string">"rebound-htmlbars/hooks"</span>;

<span class="hljs-keyword">var</span> RENDER_TIMEOUT;
<span class="hljs-keyword">var</span> TO_RENDER = [];
<span class="hljs-keyword">var</span> ENV_QUEUE = [];</pre></div></div>
            
        </li>
        
        
        <li id="section-306">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-306">&#182;</a>
              </div>
              <p>A convenience method to push only unique eleents in an array of objects to
the TO_RENDER queue. If the element is a Lazy Value, it marks it as dirty in
the process</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> push = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">arr</span>)</span>{
  <span class="hljs-keyword">var</span> i, len = arr.length;
  <span class="hljs-keyword">this</span>.added || (<span class="hljs-keyword">this</span>.added = {});
  arr.forEach((item) =&gt; {
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.added[item.cid]){ <span class="hljs-keyword">return</span>; }
    <span class="hljs-keyword">this</span>.added[item.cid] = <span class="hljs-number">1</span>;
    <span class="hljs-keyword">if</span>(item.isLazyValue){ item.makeDirty(); }
    <span class="hljs-keyword">this</span>.push(item);
  });
};

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">reslot</span>(<span class="hljs-params">env</span>)</span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-307">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-307">&#182;</a>
              </div>
              <p>Fix for stupid Babel module importer
TODO: Fix this. This is dumb. Modules don’t resolve in by time of this file’s
execution because of the dependancy tree so babel doesn’t get a chance to
interop the default value of these imports. We need to do this at runtime instead.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> hooks = _hooks.default || _hooks;

  <span class="hljs-keyword">var</span> outlet,
      slots = env.root.options &amp;&amp; env.root.options[REBOUND_SYMBOL];

  <span class="hljs-keyword">if</span>(!env.root || !slots){ <span class="hljs-keyword">return</span>; }</pre></div></div>
            
        </li>
        
        
        <li id="section-308">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-308">&#182;</a>
              </div>
              <p>Walk the dom, without traversing into other custom elements, and search for
<code>&lt;content&gt;</code> outlets to render templates into.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  $(env.root.el).walkTheDOM(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">el</span>)</span>{
    <span class="hljs-keyword">if</span>(env.root.el === el){ <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; }
    <span class="hljs-keyword">if</span>(el.tagName === <span class="hljs-string">'CONTENT'</span>){ outlet = el; }
    <span class="hljs-keyword">if</span>(el.tagName.indexOf(<span class="hljs-string">'-'</span>) &gt; <span class="hljs-number">-1</span>){ <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  });</pre></div></div>
            
        </li>
        
        
        <li id="section-309">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-309">&#182;</a>
              </div>
              <p>If a <code>&lt;content&gt;</code> outlet is present in component’s template, and a template
is provided, render it into the outlet</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>(slots.templates.default &amp;&amp; _.isElement(outlet) &amp;&amp; !outlet.slotted){
    outlet.slotted = <span class="hljs-literal">true</span>;
    $(outlet).empty();
    outlet.appendChild(hooks.buildRenderResult(slots.templates.default, slots.env, slots.scope, {}).fragment);
  }
}</pre></div></div>
            
        </li>
        
        
        <li id="section-310">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-310">&#182;</a>
              </div>
              <p>Called on animation frame. TO_RENDER is a list of lazy-values to notify.
When notified, they mark themselves as dirty. Then, call revalidate on all
dirty expressions for each environment we need to re-render. Use <code>while(queue.length)</code>
to accomodate synchronous renders where the render queue callbacks may trigger
nested calls of <code>renderCallback</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">renderCallback</span>(<span class="hljs-params"></span>)</span>{

  <span class="hljs-keyword">while</span>(TO_RENDER.length){
    TO_RENDER.shift().notify();
  }

  TO_RENDER.added = {};

  <span class="hljs-keyword">while</span>(ENV_QUEUE.length){
    <span class="hljs-keyword">let</span> env = ENV_QUEUE.shift();
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> key <span class="hljs-keyword">in</span> env.revalidateQueue){
      env.revalidateQueue[key].revalidate();
    }
    reslot(env);
  }
  ENV_QUEUE.added = {};
}</pre></div></div>
            
        </li>
        
        
        <li id="section-311">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-311">&#182;</a>
              </div>
              <p>Listens for <code>change</code> events and calls <code>trigger</code> with the correct values</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onChange</span>(<span class="hljs-params">model, options</span>)</span>{
  trigger.call(<span class="hljs-keyword">this</span>, <span class="hljs-string">'change'</span>, model, model.changedAttributes());
}</pre></div></div>
            
        </li>
        
        
        <li id="section-312">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-312">&#182;</a>
              </div>
              <p>Listens for <code>reset</code> events and calls <code>trigger</code> with the correct values</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onReset</span>(<span class="hljs-params">data, options</span>)</span>{
  trigger.call(<span class="hljs-keyword">this</span>, <span class="hljs-string">'reset'</span>, data, data.isModel ? data.changedAttributes() : { <span class="hljs-string">'@each'</span>: data }, options);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-313">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-313">&#182;</a>
              </div>
              <p>Listens for <code>update</code> events and calls <code>trigger</code> with the correct values</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onUpdate</span>(<span class="hljs-params">collection, options</span>)</span>{
  trigger.call(<span class="hljs-keyword">this</span>, <span class="hljs-string">'update'</span>, collection, { <span class="hljs-string">'@each'</span>: collection }, options);
}


<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">trigger</span>(<span class="hljs-params">type, data, changed, options={}</span>)</span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-314">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-314">&#182;</a>
              </div>
              <p>If nothing has changed, exit.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>(!data || !changed){ <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>; }

  <span class="hljs-keyword">var</span> basePath = data.__path();</pre></div></div>
            
        </li>
        
        
        <li id="section-315">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-315">&#182;</a>
              </div>
              <p>If this event came from within a service, include the service key in the base path</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>(options.service){ basePath = options.service + <span class="hljs-string">'.'</span> + basePath; }</pre></div></div>
            
        </li>
        
        
        <li id="section-316">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-316">&#182;</a>
              </div>
              <p>For each changed key, walk down the data tree from the root to the data
element that triggered the event and add all relevent callbacks to this
object’s TO_RENDER queue.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  basePath = basePath.replace(<span class="hljs-regexp">/\[[^\]]+\]/g</span>, <span class="hljs-string">".@each"</span>);
  <span class="hljs-keyword">var</span> parts = $.splitPath(basePath);
  <span class="hljs-keyword">var</span> context = [];

  <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>){
    <span class="hljs-keyword">let</span> pre = context.join(<span class="hljs-string">'.'</span>).trim();
    <span class="hljs-keyword">let</span> post = parts.join(<span class="hljs-string">'.'</span>).trim();

    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> key <span class="hljs-keyword">in</span> changed){
      <span class="hljs-keyword">let</span> path = (post + (post &amp;&amp; key &amp;&amp; <span class="hljs-string">'.'</span>) + key).trim();
      <span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> testPath <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span>.env.observers[pre]){
        <span class="hljs-keyword">if</span>($.startsWith(testPath, path)){
          push.call(TO_RENDER, <span class="hljs-keyword">this</span>.env.observers[pre][testPath]);
          push.call(ENV_QUEUE, [<span class="hljs-keyword">this</span>.env]);
        }
      }
    }
    <span class="hljs-keyword">if</span>(parts.length === <span class="hljs-number">0</span>){ <span class="hljs-keyword">break</span>; }
    context.push(parts.shift());
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-317">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-317">&#182;</a>
              </div>
              <p>If Rebound is loaded in a testing environment, call renderCallback syncronously
so that changes to the data reflect in the DOM immediately.
TODO: Make tests async so this is not required</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>(<span class="hljs-built_in">window</span>.Rebound &amp;&amp; <span class="hljs-built_in">window</span>.Rebound.testing){ <span class="hljs-keyword">return</span> renderCallback(); }</pre></div></div>
            
        </li>
        
        
        <li id="section-318">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-318">&#182;</a>
              </div>
              <p>Otherwise, queue our render callback to be called on the next animation frame,
after the current call stack has been exhausted.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-built_in">window</span>.cancelAnimationFrame(RENDER_TIMEOUT);
  RENDER_TIMEOUT = <span class="hljs-built_in">window</span>.requestAnimationFrame(renderCallback);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-319">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-319">&#182;</a>
              </div>
              <p>A render function that will merge user provided helpers and hooks with our defaults
and bind a method that re-renders dirty expressions on data change and executes
other delegated listeners added by our hooks.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">render</span>(<span class="hljs-params">el, template, data, options={}</span>)</span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-320">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-320">&#182;</a>
              </div>
              <p>Fix for stupid Babel module importer
TODO: Fix this. This is dumb. Modules don’t resolve in by time of this file’s
execution because of the dependancy tree so babel doesn’t get a chance to
interop the default value of these imports. We need to do this at runtime instead.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> hooks = _hooks.default || _hooks;</pre></div></div>
            
        </li>
        
        
        <li id="section-321">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-321">&#182;</a>
              </div>
              <p>If no data is passed to render, exit with an error</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>(!data){ <span class="hljs-keyword">return</span> <span class="hljs-built_in">console</span>.error(<span class="hljs-string">'No data passed to render function.'</span>); }</pre></div></div>
            
        </li>
        
        
        <li id="section-322">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-322">&#182;</a>
              </div>
              <p>Every component’s template is rendered using a unique Environment and Scope
If this component already has them, re-use the same objects – they contain
important state information. Otherwise, create fresh ones for it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> env = data.env || hooks.createFreshEnv();
  <span class="hljs-keyword">var</span> scope = data.scope || hooks.createFreshScope();</pre></div></div>
            
        </li>
        
        
        <li id="section-323">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-323">&#182;</a>
              </div>
              <p>Bind the component as the scope’s main data object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  hooks.bindSelf(env, scope, data);</pre></div></div>
            
        </li>
        
        
        <li id="section-324">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-324">&#182;</a>
              </div>
              <p>Add template specific hepers to env</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.extend(env.helpers, options.helpers);</pre></div></div>
            
        </li>
        
        
        <li id="section-325">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-325">&#182;</a>
              </div>
              <p>Save env and scope on component data to trigger lazy-value streams on data change</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  data.env = env;
  data.scope = scope;</pre></div></div>
            
        </li>
        
        
        <li id="section-326">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-326">&#182;</a>
              </div>
              <p>Save data on env to allow helpers / hooks access to component methods</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  env.root = data;</pre></div></div>
            
        </li>
        
        
        <li id="section-327">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-327">&#182;</a>
              </div>
              <p>Ensure we have a contextual element to pass to render</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  options.contextualElement || (options.contextualElement = (data.el || <span class="hljs-built_in">document</span>.body));
  options.self = data;</pre></div></div>
            
        </li>
        
        
        <li id="section-328">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-328">&#182;</a>
              </div>
              <p>If data is an eventable object, run the onChange helper on any change</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span>(data.listenTo){
    data.stopListening(<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, onChange).stopListening(<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, onReset).stopListening(<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, onUpdate);
    data.listenTo(data, <span class="hljs-string">'change'</span>, onChange).listenTo(data, <span class="hljs-string">'reset'</span>, onReset).listenTo(data, <span class="hljs-string">'update'</span>, onUpdate);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-329">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-329">&#182;</a>
              </div>
              <p>If this is a real template, run it with our merged helpers and hooks
If there is no template, just return an empty fragment</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  env.template = template ? hooks.buildRenderResult(template, env, scope, options) : { fragment: <span class="hljs-built_in">document</span>.createDocumentFragment() };
  $(el).empty();
  el.appendChild(env.template.fragment);
  reslot(env);
  <span class="hljs-keyword">return</span> el;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-330">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-330">&#182;</a>
              </div>
              <h2 id="rebound-router">Rebound Router</h2>

            </div>
            
        </li>
        
        
        <li id="section-331">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-331">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">import</span> Backbone <span class="hljs-keyword">from</span> <span class="hljs-string">"backbone"</span>;
<span class="hljs-keyword">import</span> $ <span class="hljs-keyword">from</span> <span class="hljs-string">"rebound-utils/rebound-utils"</span>;
<span class="hljs-keyword">import</span> { SERVICES, ServiceLoader} <span class="hljs-keyword">from</span> <span class="hljs-string">"rebound-router/service"</span>;
<span class="hljs-keyword">import</span> Component <span class="hljs-keyword">from</span> <span class="hljs-string">"rebound-component/component"</span>;
<span class="hljs-keyword">import</span> ComponentFactory <span class="hljs-keyword">from</span> <span class="hljs-string">"rebound-component/factory"</span>;
<span class="hljs-keyword">import</span> loader <span class="hljs-keyword">from</span> <span class="hljs-string">"rebound-router/loader"</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-332">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-332">&#182;</a>
              </div>
              <p>If no error page is defined for an app, this is the default 404 page</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> DEFAULT_404_PAGE =
<span class="hljs-string">`&lt;div style="display: block;text-align: center;font-size: 22px;"&gt;
  &lt;h1 style="margin-top: 60px;"&gt;
    Oops! We couldn't find this page.
  &lt;/h1&gt;
  &lt;a href="#" onclick="window.history.back();return false;" style="display: block;text-decoration: none;margin-top: 30px;"&gt;
    Take me back
  &lt;/a&gt;
&lt;/div&gt;`</span>;

<span class="hljs-keyword">var</span> ERROR_ROUTE_NAME = <span class="hljs-string">'error'</span>;
<span class="hljs-keyword">var</span> SUCCESS = <span class="hljs-string">'success'</span>;
<span class="hljs-keyword">var</span> ERROR = <span class="hljs-string">'error'</span>;
<span class="hljs-keyword">var</span> LOADING = <span class="hljs-string">'loading'</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-333">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-333">&#182;</a>
              </div>
              <p>Regexp to validate remote URLs</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> IS_REMOTE_URL = <span class="hljs-regexp">/^([a-z]+:)|^(\/\/)|^([^\/]+\.)/</span>;
<span class="hljs-keyword">var</span> STRIP_SLASHES = <span class="hljs-regexp">/(^\/+|\/+$)/mg</span>;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">normalizeUrl</span>(<span class="hljs-params"></span>)</span>{
  <span class="hljs-keyword">var</span> url = <span class="hljs-string">''</span>;
  <span class="hljs-keyword">var</span> args = <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>);
  args.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">val</span>)</span>{
    <span class="hljs-keyword">if</span>(!val || val === <span class="hljs-string">'/'</span>){ <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>; }
    url += (<span class="hljs-string">'/'</span> + val.replace(STRIP_SLASHES, <span class="hljs-string">''</span>));
  });
  <span class="hljs-keyword">return</span> url || <span class="hljs-string">'/'</span>;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-334">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-334">&#182;</a>
              </div>
              <p>Overload Backbone’s loadUrl so it returns the value of the routed callback
Only ever compare the current path (excludes the query params) to the route regexp</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Backbone.history.loadUrl = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">fragment</span>) </span>{
  <span class="hljs-keyword">var</span> key, resp = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">this</span>.fragment = <span class="hljs-keyword">this</span>.getFragment(fragment).split(<span class="hljs-string">'?'</span>)[<span class="hljs-number">0</span>];
  <span class="hljs-keyword">for</span>(key <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span>.handlers){
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.handlers[key].route.test(<span class="hljs-keyword">this</span>.fragment)){ <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.handlers[key].callback(<span class="hljs-keyword">this</span>.fragment); }
  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-335">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-335">&#182;</a>
              </div>
              <p>Remove the hash up to a <code>?</code> character. In IE9, which does not support the
History API, we need to allow query params to be set both on the URL itself
and in the hash, giving precedence to the query params in the URL.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Backbone.history.getSearch = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
   <span class="hljs-keyword">var</span> match = <span class="hljs-keyword">this</span>.location.href.replace(<span class="hljs-regexp">/#[^\?]*/</span>, <span class="hljs-string">''</span>).match(<span class="hljs-regexp">/\?.+/</span>);
   <span class="hljs-keyword">return</span> match ? match[<span class="hljs-number">0</span>] : <span class="hljs-string">''</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-336">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-336">&#182;</a>
              </div>
              <p>Router Constructor</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> Router = Backbone.Router.extend({

  status: SUCCESS,    <span class="hljs-comment">// loading, success or error</span>
  _currentRoute:  <span class="hljs-string">''</span>, <span class="hljs-comment">// The route path that triggered the current page</span>
  _previousRoute: <span class="hljs-string">''</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-337">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-337">&#182;</a>
              </div>
              <p>By default there is one route. The wildcard route fetches the required
page assets based on user-defined naming convention.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  routes: {
    <span class="hljs-string">'*route'</span>: <span class="hljs-string">'wildcardRoute'</span>
  },

  _loadDeps: loader.load,</pre></div></div>
            
        </li>
        
        
        <li id="section-338">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-338">&#182;</a>
              </div>
              <p>Called when no matching routes are found. Extracts root route and fetches it’s resources</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  wildcardRoute: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">route</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-339">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-339">&#182;</a>
              </div>
              <p>Save the previous route value</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>._previousRoute = <span class="hljs-keyword">this</span>._currentRoute;</pre></div></div>
            
        </li>
        
        
        <li id="section-340">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-340">&#182;</a>
              </div>
              <p>Fetch Resources</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-built_in">document</span>.body.classList.add(<span class="hljs-string">"loading"</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._fetchResource(route, <span class="hljs-keyword">this</span>.config.container).then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">res</span>)</span>{
      <span class="hljs-built_in">document</span>.body.classList.remove(<span class="hljs-string">'loading'</span>);
      <span class="hljs-keyword">return</span> res;
    });
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-341">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-341">&#182;</a>
              </div>
              <p>Modify navigate to default to <code>trigger=true</code> and to return the value of
<code>Backbone.history.navigate</code> inside of a promise.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  navigate: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">fragment, options={}</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-342">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-342">&#182;</a>
              </div>
              <p>Default trigger to true unless otherwise specified</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    (options.trigger === <span class="hljs-literal">undefined</span>) &amp;&amp; (options.trigger = <span class="hljs-literal">true</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-343">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-343">&#182;</a>
              </div>
              <p>Stringify any data passed in the options hash</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> query = options.data ? (~fragment.indexOf(<span class="hljs-string">'?'</span>) ? <span class="hljs-string">'&amp;'</span> : <span class="hljs-string">'?'</span>) + $.url.query.stringify(options.data) : <span class="hljs-string">''</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-344">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-344">&#182;</a>
              </div>
              <p>Un-Mark any <code>active</code> links in the page container</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> $container = $(<span class="hljs-keyword">this</span>.config.containers).unMarkLinks();</pre></div></div>
            
        </li>
        
        
        <li id="section-345">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-345">&#182;</a>
              </div>
              <p>Navigate to the specified path. Return value is the value from the router
callback specified on the component</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> resp = Backbone.history.navigate(fragment + query, options);</pre></div></div>
            
        </li>
        
        
        <li id="section-346">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-346">&#182;</a>
              </div>
              <p>Always return a promise. If the response of <code>Backbone.histroy.navigate</code>
was a promise, wait for it to resolve before resolving. Once resolved,
mark relevent links on the page as <code>active</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">resolve, reject</span>) </span>{
      <span class="hljs-keyword">if</span>(resp &amp;&amp; resp.constructor === <span class="hljs-built_in">Promise</span>) resp.then(resolve, resolve);
      resolve(resp);
    }).then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">resp</span>)</span>{
      $container.markLinks();
      <span class="hljs-keyword">return</span> resp;
    });
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-347">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-347">&#182;</a>
              </div>
              <p>Modify <code>router.execute</code> to return the value of our route callback</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  execute: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">callback, args, name</span>) </span>{
    <span class="hljs-keyword">if</span> (callback){ <span class="hljs-keyword">return</span> callback.apply(<span class="hljs-keyword">this</span>, args); }
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-348">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-348">&#182;</a>
              </div>
              <p>Override routeToRegExp so:</p>
<ul>
<li>If key is a stringified regexp literal, convert to a regexp object</li>
<li>Else If route is a string, proxy right through</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _routeToRegExp: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">route</span>)</span>{
    <span class="hljs-keyword">var</span> res;

    <span class="hljs-keyword">if</span>(route[<span class="hljs-number">0</span>] === <span class="hljs-string">'/'</span> &amp;&amp; route[route.length<span class="hljs-number">-1</span>] === <span class="hljs-string">'/'</span> ) {
      res = <span class="hljs-keyword">new</span> <span class="hljs-built_in">RegExp</span>(route.slice(<span class="hljs-number">1</span>, route.length<span class="hljs-number">-1</span>), <span class="hljs-string">''</span>);
      res._isRegexp = <span class="hljs-literal">true</span>;
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> route == <span class="hljs-string">'string'</span>){
      res = Backbone.Router.prototype._routeToRegExp.call(<span class="hljs-keyword">this</span>, route);
      res._isString = <span class="hljs-literal">true</span>;
    }

    <span class="hljs-keyword">return</span> res;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-349">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-349">&#182;</a>
              </div>
              <p>Override route so if callback returns false, the route event is not triggered
Every route also looks for query params, parses with QS, and passes the extra
variable as a POJO to callbacks</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  route: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">route, name, callback</span>) </span>{
    <span class="hljs-keyword">if</span> (_.isFunction(name)) {
      callback = name;
      name = <span class="hljs-string">''</span>;
    }

    <span class="hljs-keyword">if</span> (!_.isRegExp(route)){
      route = <span class="hljs-keyword">this</span>._routeToRegExp(route);
    }

    <span class="hljs-keyword">if</span> (!callback){ callback = <span class="hljs-keyword">this</span>[name]; }
    Backbone.history.route(route, (fragment) =&gt; {</pre></div></div>
            
        </li>
        
        
        <li id="section-350">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-350">&#182;</a>
              </div>
              <p>If this route was defined as a regular expression, we don’t capture
query params. Only parse the actual path.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      fragment = fragment.split(<span class="hljs-string">'?'</span>)[<span class="hljs-number">0</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-351">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-351">&#182;</a>
              </div>
              <p>Extract the arguments we care about from the fragment</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> args = <span class="hljs-keyword">this</span>._extractParameters(route, fragment);</pre></div></div>
            
        </li>
        
        
        <li id="section-352">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-352">&#182;</a>
              </div>
              <p>Get the query params string</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> search = (Backbone.history.getSearch() || <span class="hljs-string">''</span>).slice(<span class="hljs-number">1</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-353">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-353">&#182;</a>
              </div>
              <p>If this route was created from a string (not a regexp), remove the auto-captured
search params.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span>(route._isString){ args.pop(); }</pre></div></div>
            
        </li>
        
        
        <li id="section-354">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-354">&#182;</a>
              </div>
              <p>If the route is not user prodided, if the history object has search params
then our args have the params as its last agrument as of Backbone 1.2.0
If the route is a user provided regex, add in parsed search params from
the history object before passing to the callback.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      args.push((search) ? $.url.query.parse(search) : {});

      <span class="hljs-keyword">var</span> resp = <span class="hljs-keyword">this</span>.execute(callback, args, name);
      <span class="hljs-keyword">if</span> ( resp !== <span class="hljs-literal">false</span>) {
        <span class="hljs-keyword">this</span>.trigger.apply(<span class="hljs-keyword">this</span>, [<span class="hljs-string">'route:'</span> + name].concat(args));
        <span class="hljs-keyword">this</span>.trigger(<span class="hljs-string">'route'</span>, name, args);
        Backbone.history.trigger(<span class="hljs-string">'route'</span>, <span class="hljs-keyword">this</span>, name, args);
      }
      <span class="hljs-keyword">return</span> resp;
    });
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-355">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-355">&#182;</a>
              </div>
              <p>On startup, save our config object and start the router</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  initialize: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">options={}, callback=function(</span>)</span>{}) {</pre></div></div>
            
        </li>
        
        
        <li id="section-356">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-356">&#182;</a>
              </div>
              <p>Let all of our components always have referance to our router</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    Component.prototype.router = <span class="hljs-keyword">this</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-357">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-357">&#182;</a>
              </div>
              <p>Save our config referance</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.config = options;
    <span class="hljs-keyword">this</span>.config.handlers = [];
    <span class="hljs-keyword">this</span>.config.containers = [];</pre></div></div>
            
        </li>
        
        
        <li id="section-358">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-358">&#182;</a>
              </div>
              <p>Normalize our url configs</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.config.root = normalizeUrl(<span class="hljs-keyword">this</span>.config.root);
    <span class="hljs-keyword">this</span>.config.assetRoot = <span class="hljs-keyword">this</span>.config.assetRoot ? normalizeUrl(<span class="hljs-keyword">this</span>.config.assetRoot) : <span class="hljs-keyword">this</span>.config.root;
    <span class="hljs-keyword">this</span>.config.jsPath = normalizeUrl(<span class="hljs-keyword">this</span>.config.assetRoot, <span class="hljs-keyword">this</span>.config.jsPath);
    <span class="hljs-keyword">this</span>.config.cssPath = normalizeUrl(<span class="hljs-keyword">this</span>.config.assetRoot, <span class="hljs-keyword">this</span>.config.cssPath);</pre></div></div>
            
        </li>
        
        
        <li id="section-359">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-359">&#182;</a>
              </div>
              <p>Get a unique instance id for this router</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.uid = $.uniqueId(<span class="hljs-string">'router'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-360">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-360">&#182;</a>
              </div>
              <p>Allow user to override error route</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.config.errorRoute &amp;&amp; (ERROR_ROUTE_NAME = <span class="hljs-keyword">this</span>.config.errorRoute);</pre></div></div>
            
        </li>
        
        
        <li id="section-361">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-361">&#182;</a>
              </div>
              <p>Convert our routeMappings to regexps and push to our handlers</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    _.each(<span class="hljs-keyword">this</span>.config.routeMapping, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">value, route</span>)</span>{
      <span class="hljs-keyword">var</span> regex = <span class="hljs-keyword">this</span>._routeToRegExp(route);
      <span class="hljs-keyword">this</span>.config.handlers.unshift({ route: route, regex: regex, app: value });
    }, <span class="hljs-keyword">this</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-362">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-362">&#182;</a>
              </div>
              <p>Use the user provided container, or default to the closest <code>&lt;main&gt;</code> tag</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.config.container = $((<span class="hljs-keyword">this</span>.config.container || <span class="hljs-string">'main'</span>))[<span class="hljs-number">0</span>];
    <span class="hljs-keyword">this</span>.config.containers.push(<span class="hljs-keyword">this</span>.config.container);
    SERVICES.page = <span class="hljs-keyword">new</span> ServiceLoader(<span class="hljs-string">'page'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-363">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-363">&#182;</a>
              </div>
              <p>Install our global components</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    _.each(<span class="hljs-keyword">this</span>.config.services, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">selector, route</span>)</span>{
      <span class="hljs-keyword">var</span> container = $(selector)[<span class="hljs-number">0</span>] || <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'span'</span>);
      <span class="hljs-keyword">this</span>.config.containers.push(container);
      SERVICES[route] = <span class="hljs-keyword">new</span> ServiceLoader(route);
      <span class="hljs-keyword">this</span>._fetchResource(route, container).catch(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{});
    }, <span class="hljs-keyword">this</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-364">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-364">&#182;</a>
              </div>
              <p>Watch click events on links in all out containers</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>._watchLinks(<span class="hljs-keyword">this</span>.config.containers);</pre></div></div>
            
        </li>
        
        
        <li id="section-365">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-365">&#182;</a>
              </div>
              <p>Start the history and call the provided callback</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    Backbone.history.start({
      pushState: (<span class="hljs-keyword">this</span>.config.pushState === <span class="hljs-literal">undefined</span>) ? <span class="hljs-literal">true</span> : <span class="hljs-keyword">this</span>.config.pushState,
      root: (<span class="hljs-keyword">this</span>.config.root || <span class="hljs-string">''</span>)
    }).then(callback);

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  },

  stop: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
    $(<span class="hljs-keyword">this</span>.config.container).off(<span class="hljs-string">'click'</span>);
    Backbone.history.stop();
    <span class="hljs-keyword">this</span>._uninstallResource();
    Backbone.history.handlers = [];
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-366">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-366">&#182;</a>
              </div>
              <p>Given a dom element, watch for all click events on anchor tags.
If the clicked anchor has a relative url, attempt to route to that path.
Give all links on the page that match this path the class <code>active</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _watchLinks: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">container</span>)</span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-367">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-367">&#182;</a>
              </div>
              <p>Navigate to route for any link with a relative href</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    $(container).on(<span class="hljs-string">'click'</span>, <span class="hljs-string">'a'</span>, (e) =&gt; {
      <span class="hljs-keyword">var</span> path = e.target.getAttribute(<span class="hljs-string">'href'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-368">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-368">&#182;</a>
              </div>
              <p>If the path is a remote URL, allow the browser to navigate normally.
Otherwise, prevent default so we can handle the route event.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span>(IS_REMOTE_URL.test(path) || path === <span class="hljs-string">'#'</span>){ <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>; }
      e.preventDefault();</pre></div></div>
            
        </li>
        
        
        <li id="section-369">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-369">&#182;</a>
              </div>
              <p>If this is not our current route, navigate to the new route</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span>(path !== <span class="hljs-string">'/'</span>+Backbone.history.fragment){
        <span class="hljs-keyword">this</span>.navigate(path, {trigger: <span class="hljs-literal">true</span>});
      }
    });
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-370">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-370">&#182;</a>
              </div>
              <p>De-initializes the previous app before rendering a new app
This way we can ensure that every new page starts with a clean slate
This is crucial for scalability of a single page app.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _uninstallResource: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{

    <span class="hljs-keyword">var</span> routes = <span class="hljs-keyword">this</span>.current ? (<span class="hljs-keyword">this</span>.current.data.routes || {}) : {};
        routes[<span class="hljs-keyword">this</span>._previousRoute] = <span class="hljs-string">''</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-371">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-371">&#182;</a>
              </div>
              <p>Unset Previous Application’s Routes. For each route in the page app, remove
the handler from our route object and delete our referance to the route’s callback</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    _.each(routes, (value, key) =&gt; {
      <span class="hljs-keyword">var</span> regExp = <span class="hljs-keyword">this</span>._routeToRegExp(key).toString();
      Backbone.history.handlers = _.filter(Backbone.history.handlers, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">obj</span>)</span>{
        <span class="hljs-keyword">return</span> obj.route.toString() !== regExp;
      });
    });

    <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>.current){ <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>; }

    <span class="hljs-keyword">var</span> oldPageName = <span class="hljs-keyword">this</span>.current.__pageId;</pre></div></div>
            
        </li>
        
        
        <li id="section-372">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-372">&#182;</a>
              </div>
              <p>Un-hook Event Bindings, Delete Objects</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.current.data.deinitialize();</pre></div></div>
            
        </li>
        
        
        <li id="section-373">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-373">&#182;</a>
              </div>
              <p>Now we no longer have a page installed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.current = <span class="hljs-literal">undefined</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-374">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-374">&#182;</a>
              </div>
              <p>Disable old css if it exists</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    setTimeout(() =&gt; {
      <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.status === ERROR){ <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>; }
      <span class="hljs-built_in">document</span>.getElementById(oldPageName + <span class="hljs-string">'-css'</span>).setAttribute(<span class="hljs-string">'disabled'</span>, <span class="hljs-literal">true</span>);
    }, <span class="hljs-number">500</span>);

  },</pre></div></div>
            
        </li>
        
        
        <li id="section-375">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-375">&#182;</a>
              </div>
              <p>Give our new page component, load routes and render a new instance of the
page component in the top level outlet.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _installResource: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">PageApp, appName, container</span>) </span>{
    <span class="hljs-keyword">var</span> oldPageName, pageInstance, routes = [];
    <span class="hljs-keyword">var</span> isService = (container !== <span class="hljs-keyword">this</span>.config.container);
    <span class="hljs-keyword">var</span> name = (isService) ? appName : <span class="hljs-string">'page'</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-376">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-376">&#182;</a>
              </div>
              <p>If no container exists, throw an error</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(!container) <span class="hljs-keyword">throw</span> <span class="hljs-string">'No container found on the page! Please specify a container that exists in your Rebound config.'</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-377">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-377">&#182;</a>
              </div>
              <p>Add page level loading class</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    container.classList.remove(<span class="hljs-string">'error'</span>, <span class="hljs-string">'loading'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-378">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-378">&#182;</a>
              </div>
              <p>Uninstall any old resource we have loaded</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(!isService &amp;&amp; <span class="hljs-keyword">this</span>.current){ <span class="hljs-keyword">this</span>._uninstallResource(); }</pre></div></div>
            
        </li>
        
        
        <li id="section-379">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-379">&#182;</a>
              </div>
              <p>Load New PageApp, give it it’s name so we know what css to remove when it deinitializes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    pageInstance = ComponentFactory(PageApp).el;
    <span class="hljs-keyword">if</span>(SERVICES[name].isLazyComponent){ SERVICES[name].hydrate(pageInstance.data); }
    <span class="hljs-keyword">else</span>{ SERVICES[name] = pageInstance.data; }
    pageInstance.__pageId = <span class="hljs-keyword">this</span>.uid + <span class="hljs-string">'-'</span> + appName;</pre></div></div>
            
        </li>
        
        
        <li id="section-380">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-380">&#182;</a>
              </div>
              <p>Add to our page</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    $(container).empty();
    container.appendChild(pageInstance);</pre></div></div>
            
        </li>
        
        
        <li id="section-381">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-381">&#182;</a>
              </div>
              <p>Make sure we’re back at the top of the page</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-built_in">document</span>.body.scrollTop = <span class="hljs-number">0</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-382">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-382">&#182;</a>
              </div>
              <p>Add a default route handler for the route that got us here so if the component
does not define a route that handles it, we don’t get a redirect loop</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(!isService){ <span class="hljs-keyword">this</span>.route(<span class="hljs-keyword">this</span>._currentRoute, <span class="hljs-string">'default'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{ <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>; }); }</pre></div></div>
            
        </li>
        
        
        <li id="section-383">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-383">&#182;</a>
              </div>
              <p>Augment ApplicationRouter with new routes from PageApp added in reverse order to preserve order higherarchy</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    _.each(pageInstance.data.routes, (value, key) =&gt; {</pre></div></div>
            
        </li>
        
        
        <li id="section-384">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-384">&#182;</a>
              </div>
              <p>Add the new callback referance on to our router and add the route handler</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">this</span>.route(key, value, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{ <span class="hljs-keyword">return</span> pageInstance.data[value].apply(pageInstance.data, <span class="hljs-built_in">arguments</span>); });
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-385">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-385">&#182;</a>
              </div>
              <p>If this is the main page component, set it as current</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(!isService){ <span class="hljs-keyword">this</span>.current = pageInstance; }</pre></div></div>
            
        </li>
        
        
        <li id="section-386">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-386">&#182;</a>
              </div>
              <p>Always return a promise</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">resolve, reject</span>)</span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-387">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-387">&#182;</a>
              </div>
              <p>Re-trigger route so the newly added route may execute if there’s a route match.
If no routes are matched, app will hit wildCard route which will then trigger 404</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span>(!isService){
        <span class="hljs-keyword">let</span> res = Backbone.history.loadUrl(Backbone.history.fragment);
        <span class="hljs-keyword">if</span>(res &amp;&amp; <span class="hljs-keyword">typeof</span> res.then === <span class="hljs-string">'function'</span>) <span class="hljs-keyword">return</span> res.then(resolve);
        <span class="hljs-keyword">return</span> resolve(res);
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-388">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-388">&#182;</a>
              </div>
              <p>Return our newly installed app</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">return</span> resolve(pageInstance);
    });
  },

  _fetchJavascript: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">routeName, appName</span>)</span>{
    <span class="hljs-keyword">var</span> jsID = <span class="hljs-keyword">this</span>.uid + <span class="hljs-string">'-'</span> + appName + <span class="hljs-string">'-route'</span>,
        jsUrl = <span class="hljs-keyword">this</span>.config.jsPath.replace(<span class="hljs-regexp">/:route/g</span>, routeName).replace(<span class="hljs-regexp">/:app/g</span>, appName);</pre></div></div>
            
        </li>
        
        
        <li id="section-389">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-389">&#182;</a>
              </div>
              <p>Load the JavaScript.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">return</span> loader.loadJS(jsUrl, jsID);
  },

  _fetchCSS: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">routeName, appName</span>)</span>{

    <span class="hljs-keyword">var</span> cssID = <span class="hljs-keyword">this</span>.uid + <span class="hljs-string">'-'</span> + appName + <span class="hljs-string">'-css'</span>,
        cssUrl = <span class="hljs-keyword">this</span>.config.cssPath.replace(<span class="hljs-regexp">/:route/g</span>, routeName).replace(<span class="hljs-regexp">/:app/g</span>, appName);</pre></div></div>
            
        </li>
        
        
        <li id="section-390">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-390">&#182;</a>
              </div>
              <p>Load the CSS</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">return</span> loader.loadCSS(cssUrl, cssID);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-391">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-391">&#182;</a>
              </div>
              <p>Fetches HTML and CSS</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _fetchResource: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">route, container</span>) </span>{

    <span class="hljs-keyword">var</span> appName, routeName,
        isService = (container !== <span class="hljs-keyword">this</span>.config.container),
        isError = (route === ERROR_ROUTE_NAME);</pre></div></div>
            
        </li>
        
        
        <li id="section-392">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-392">&#182;</a>
              </div>
              <p>Normalize Route</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    route || (route = <span class="hljs-string">''</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-393">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-393">&#182;</a>
              </div>
              <p>Get the app name from this route</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    appName = routeName = (route.split(<span class="hljs-string">'/'</span>)[<span class="hljs-number">0</span>] || <span class="hljs-string">'index'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-394">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-394">&#182;</a>
              </div>
              <p>If this isn’t the error route, Find Any Custom Route Mappings</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(!isService &amp;&amp; !isError){
      <span class="hljs-keyword">this</span>._currentRoute = route.split(<span class="hljs-string">'/'</span>)[<span class="hljs-number">0</span>];
      _.any(<span class="hljs-keyword">this</span>.config.handlers, (handler) =&gt; {
        <span class="hljs-keyword">if</span> (handler.regex.test(route)){
          appName = handler.app;
          <span class="hljs-keyword">this</span>._currentRoute = handler.route;
          <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
      });
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-395">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-395">&#182;</a>
              </div>
              <p>Wrap these async resource fetches in a promise and return it.
This promise resolves when both css and js resources are loaded
It rejects if either of the css or js resources fails to load.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>((resolve, reject) =&gt; {

      <span class="hljs-keyword">var</span> throwError = (err) =&gt; {</pre></div></div>
            
        </li>
        
        
        <li id="section-396">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-396">&#182;</a>
              </div>
              <p>If we are already in an error state, this means we were unable to load
a custom error page. Uninstall anything we have and insert our default 404 page.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.status === ERROR){
          <span class="hljs-keyword">if</span>(isService) <span class="hljs-keyword">return</span> resolve(err);
          <span class="hljs-keyword">this</span>._uninstallResource();
          container.innerHTML = DEFAULT_404_PAGE;
          <span class="hljs-keyword">return</span> resolve(err);
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-397">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-397">&#182;</a>
              </div>
              <p>Set our status to error and attempt to load a custom error page.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-built_in">console</span>.error(<span class="hljs-string">'Could not '</span> + ((isService) ? <span class="hljs-string">'load the '</span> + appName + <span class="hljs-string">' service:'</span> : <span class="hljs-string">'find the '</span> + (appName || <span class="hljs-string">'index'</span>) + <span class="hljs-string">' app.'</span>), <span class="hljs-string">'at'</span>, (<span class="hljs-string">'/'</span> + route));
        <span class="hljs-keyword">this</span>.status = ERROR;
        <span class="hljs-keyword">this</span>._currentRoute = route;
        resolve(<span class="hljs-keyword">this</span>._fetchResource(ERROR_ROUTE_NAME, container));
      };</pre></div></div>
            
        </li>
        
        
        <li id="section-398">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-398">&#182;</a>
              </div>
              <p>If the values we got from installing our resources are unexpected, 404
Otherwise, set status, activate the css, and install the page component</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> install = (response) =&gt; {
        <span class="hljs-keyword">var</span> cssElement = response[<span class="hljs-number">0</span>], jsElement = response[<span class="hljs-number">1</span>];
        <span class="hljs-keyword">if</span>(!(cssElement <span class="hljs-keyword">instanceof</span> Element) || !(jsElement <span class="hljs-keyword">instanceof</span> Element) ) <span class="hljs-keyword">return</span> throwError();
        (!isService &amp;&amp; !isError) &amp;&amp; (<span class="hljs-keyword">this</span>.status = SUCCESS);
        cssElement &amp;&amp; cssElement.removeAttribute(<span class="hljs-string">'disabled'</span>);
        <span class="hljs-keyword">this</span>._installResource(jsElement.getAttribute(<span class="hljs-string">'data-name'</span>), appName, container).then(resolve, resolve);
      };</pre></div></div>
            
        </li>
        
        
        <li id="section-399">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-399">&#182;</a>
              </div>
              <p>If loading a page, set status to loading</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      (!isService &amp;&amp; !isError) &amp;&amp; (<span class="hljs-keyword">this</span>.status = LOADING);</pre></div></div>
            
        </li>
        
        
        <li id="section-400">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-400">&#182;</a>
              </div>
              <p>If Page Is Already Loaded Then The Route Does Not Exist. 404 and Exit.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.current &amp;&amp; <span class="hljs-keyword">this</span>.current.__pageId === (<span class="hljs-keyword">this</span>.uid + <span class="hljs-string">'-'</span> + appName)){ <span class="hljs-keyword">return</span> throwError(); }</pre></div></div>
            
        </li>
        
        
        <li id="section-401">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-401">&#182;</a>
              </div>
              <p>Fetch our css and js in paralell, install or throw when both complete</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-built_in">Promise</span>.all([<span class="hljs-keyword">this</span>._fetchCSS(routeName, appName), <span class="hljs-keyword">this</span>._fetchJavascript(routeName, appName)])
      .then(install, throwError);

    });
  }
});

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> Router;
<span class="hljs-keyword">export</span> { Router <span class="hljs-keyword">as</span> Router };
<span class="hljs-keyword">export</span> { SERVICES <span class="hljs-keyword">as</span> services};

<span class="hljs-keyword">import</span> $ <span class="hljs-keyword">from</span> <span class="hljs-string">"rebound-utils/rebound-utils"</span>;

<span class="hljs-keyword">var</span> MODULE_CACHE = {};

<span class="hljs-keyword">var</span> loader = {</pre></div></div>
            
        </li>
        
        
        <li id="section-402">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-402">&#182;</a>
              </div>
              <p>If this JS element is not on the page already, it hasn’t been loaded before -
create the element and load the JS resource.
Else if the JS resource has been loaded before, resolve with the element</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  loadJS(url, id){</pre></div></div>
            
        </li>
        
        
        <li id="section-403">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-403">&#182;</a>
              </div>
              <p>Always return a promise for a load request</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">resolve, reject</span>)</span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-404">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-404">&#182;</a>
              </div>
              <p>If we have already tried to load this js module, resolve or reject appropreately</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span>(MODULE_CACHE[url]){
        <span class="hljs-keyword">if</span> (_.isElement(MODULE_CACHE[url]) &amp;&amp; MODULE_CACHE[url].hasAttribute(<span class="hljs-string">'data-error'</span>)){ <span class="hljs-keyword">return</span> reject(); }
        <span class="hljs-keyword">return</span> resolve(MODULE_CACHE[url]);
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-405">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-405">&#182;</a>
              </div>
              <p>Construct the script element and save it in the <code>MODULE_CACHE</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> e = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'script'</span>);
      e.setAttribute(<span class="hljs-string">'type'</span>, <span class="hljs-string">'text/javascript'</span>);
      e.setAttribute(<span class="hljs-string">'src'</span>, url);
      e.setAttribute(<span class="hljs-string">'id'</span>, (id || _.uniqueId(<span class="hljs-string">'module'</span>)) );
      MODULE_CACHE[url] = e;</pre></div></div>
            
        </li>
        
        
        <li id="section-406">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-406">&#182;</a>
              </div>
              <p>All browsers support loading events on <code>&lt;script&gt;</code> elements, bind to these
events and resolve our promise appropreately</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      $(e).on(<span class="hljs-string">'load'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{ resolve(<span class="hljs-keyword">this</span>); });
      $(e).on(<span class="hljs-string">'error'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>)</span>{ reject(err); });</pre></div></div>
            
        </li>
        
        
        <li id="section-407">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-407">&#182;</a>
              </div>
              <p>And add it do to the dom</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-built_in">document</span>.head.appendChild(e);

    });
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-408">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-408">&#182;</a>
              </div>
              <p>If this CSS element is not on the page already, it hasn’t been loaded before -
create the element and load the CSS resource.
Else if the CSS resource has been loaded before, resolve with the element</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  loadCSS(url, id){</pre></div></div>
            
        </li>
        
        
        <li id="section-409">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-409">&#182;</a>
              </div>
              <p>Always return a promise for a load request</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">resolve, reject</span>)</span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-410">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-410">&#182;</a>
              </div>
              <p>If we have already tried to load this js module, resolve or reject appropreately</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span>(MODULE_CACHE[url]){
        <span class="hljs-keyword">if</span> (_.isElement(MODULE_CACHE[url]) &amp;&amp; MODULE_CACHE[url].hasAttribute(<span class="hljs-string">'data-error'</span>)){ <span class="hljs-keyword">return</span> reject(); }
        <span class="hljs-keyword">return</span> resolve(MODULE_CACHE[url]);
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-411">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-411">&#182;</a>
              </div>
              <p>Construct our <code>&lt;link&gt;</code> element.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> e = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'link'</span>);
      e.setAttribute(<span class="hljs-string">'type'</span>, <span class="hljs-string">'text/css'</span>);
      e.setAttribute(<span class="hljs-string">'rel'</span>, <span class="hljs-string">'stylesheet'</span>);
      e.setAttribute(<span class="hljs-string">'href'</span>, url);
      e.setAttribute(<span class="hljs-string">'id'</span>, id);
      MODULE_CACHE[url] = e;</pre></div></div>
            
        </li>
        
        
        <li id="section-412">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-412">&#182;</a>
              </div>
              <p>Older browsers and phantomJS &lt; 2.0 don’t support the onLoad event for
<code>&lt;link&gt;</code> tags. Poll stylesheets array as a fallback. Timeout at 5s.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">let</span> count = <span class="hljs-number">0</span>, ti = setInterval(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">document</span>.styleSheets.length; i++){
          count = count + <span class="hljs-number">50</span>;
          <span class="hljs-keyword">if</span>((<span class="hljs-built_in">document</span>.styleSheets[i].href || <span class="hljs-string">''</span>).indexOf(url) &gt; <span class="hljs-number">-1</span>){ successCallback(); }
          <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(count &gt;= <span class="hljs-number">5000</span>){ errorCallback(<span class="hljs-string">'CSS Timeout'</span>); }
        }
      }, <span class="hljs-number">50</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-413">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-413">&#182;</a>
              </div>
              <p>On successful load, clearInterval and resolve.
On failed load, clearInterval and reject.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> successCallback = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
        clearInterval(ti);
        resolve(e);
      };
      <span class="hljs-keyword">var</span> errorCallback = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>)</span>{
        clearInterval(ti);
        e.setAttribute(<span class="hljs-string">'data-error'</span>, <span class="hljs-string">''</span>);
        reject(err);
      };</pre></div></div>
            
        </li>
        
        
        <li id="section-414">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-414">&#182;</a>
              </div>
              <p>Modern browsers support loading events on <code>&lt;link&gt;</code> elements, bind these
events. These will be callsed before our interval is called and they will
clearInterval so the resolve/reject handlers aren’t called twice.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      $(e).on(<span class="hljs-string">'load'</span>, successCallback);
      $(e).on(<span class="hljs-string">'error'</span>, errorCallback);
      $(e).on(<span class="hljs-string">'readystatechange'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{ clearInterval(ti); });</pre></div></div>
            
        </li>
        
        
        <li id="section-415">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-415">&#182;</a>
              </div>
              <p>Add our <code>&lt;link&gt;</code> element to the page.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-built_in">document</span>.head.appendChild(e);

    });
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-416">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-416">&#182;</a>
              </div>
              <p>Load multiple dependancies
Given an array of dependancy urls, add them all to the head in their own script tags</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  load(deps){
    <span class="hljs-keyword">if</span>(!deps){ <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>; }
    deps = _.isArray(deps) ? deps : [deps];</pre></div></div>
            
        </li>
        
        
        <li id="section-417">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-417">&#182;</a>
              </div>
              <p>For each dependancy passed, call loadJS</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    deps.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">url</span>)</span>{
      url = url.trim();
      url = <span class="hljs-string">'/'</span> + url + <span class="hljs-string">'.js'</span>;
      loader.loadJS(url);
    });
  },

  register(url){
    MODULE_CACHE[url] = <span class="hljs-literal">true</span>;
  }
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> loader;</pre></div></div>
            
        </li>
        
        
        <li id="section-418">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-418">&#182;</a>
              </div>
              <h2 id="property-compiler">Property Compiler</h2>

            </div>
            
        </li>
        
        
        <li id="section-419">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-419">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">import</span> { Parser, tokTypes } <span class="hljs-keyword">from</span> <span class="hljs-string">"acorn"</span>;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">tokenizer</span>(<span class="hljs-params">input, options</span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Parser(options, input);
}

<span class="hljs-keyword">const</span> TERMINATORS = [<span class="hljs-string">';'</span>,<span class="hljs-string">','</span>,<span class="hljs-string">'=='</span>,<span class="hljs-string">'&gt;'</span>,<span class="hljs-string">'&lt;'</span>,<span class="hljs-string">'&gt;='</span>,<span class="hljs-string">'&lt;='</span>,<span class="hljs-string">'&gt;=='</span>,<span class="hljs-string">'&lt;=='</span>,<span class="hljs-string">'!='</span>,<span class="hljs-string">'!=='</span>, <span class="hljs-string">'==='</span>, <span class="hljs-string">'&amp;&amp;'</span>, <span class="hljs-string">'||'</span>, <span class="hljs-string">'+'</span>, <span class="hljs-string">'-'</span>, <span class="hljs-string">'/'</span>, <span class="hljs-string">'*'</span>, <span class="hljs-string">'{'</span>, <span class="hljs-string">'}'</span>];

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">reduceMemos</span>(<span class="hljs-params">memo, paths</span>)</span>{
  <span class="hljs-keyword">var</span> newMemo = [];
  paths = (!_.isArray(paths)) ? [paths] : paths;
  _.each(paths, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">path</span>)</span>{
    _.each(memo, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">mem</span>)</span>{
      newMemo.push(_.compact([mem, path]).join(<span class="hljs-string">'.'</span>).replace(<span class="hljs-string">'.['</span>, <span class="hljs-string">'['</span>));
    });
  });
  <span class="hljs-keyword">return</span> newMemo;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-420">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-420">&#182;</a>
              </div>
              <p>TODO: Make this farrrrrr more robust…very minimal right now</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">compile</span>(<span class="hljs-params">prop, name</span>)</span>{
  <span class="hljs-keyword">var</span> output = {};

  <span class="hljs-keyword">if</span>(prop.__params) <span class="hljs-keyword">return</span> prop.__params;

  <span class="hljs-keyword">var</span> str = prop.toString(), <span class="hljs-comment">//.replace(/(?:\/\*(?:[\s\S]*?)\*\/)|(?:([\s;])+\/\/(?:.*)$)/gm, '$1'), // String representation of function sans comments</span>
      token = tokenizer(str, {
        ecmaVersion: <span class="hljs-number">6</span>,
        sourceType: <span class="hljs-string">'script'</span>
      }),
      finishedPaths = [],
      listening = <span class="hljs-number">0</span>,
      paths = [],
      attrs = [],
      workingpath = [];

  <span class="hljs-keyword">do</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-421">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-421">&#182;</a>
              </div>
              <p>console.log(token.type.label, token.value);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    token.nextToken();

    <span class="hljs-keyword">if</span>(token.value === <span class="hljs-string">'this'</span>){
      listening++;
      workingpath = [];
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-422">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-422">&#182;</a>
              </div>
              <p>TODO: handle gets on collections</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(token.value === <span class="hljs-string">'get'</span>){
      token.nextToken();
      <span class="hljs-keyword">while</span>(_.isUndefined(token.value)){
        token.nextToken();
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-423">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-423">&#182;</a>
              </div>
              <p>Replace any access to a collection with the generic @each placeholder and push dependancy</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      workingpath.push(token.value.replace(<span class="hljs-regexp">/\[.+\]/g</span>, <span class="hljs-string">".@each"</span>).replace(<span class="hljs-regexp">/^\./</span>, <span class="hljs-string">''</span>));
    }

    <span class="hljs-keyword">if</span>(token.value === <span class="hljs-string">'pluck'</span>){
      token.nextToken();
      <span class="hljs-keyword">while</span>(_.isUndefined(token.value)){
        token.nextToken();
      }

      workingpath.push(<span class="hljs-string">'@each.'</span> + token.value);
    }

    <span class="hljs-keyword">if</span>(token.value === <span class="hljs-string">'slice'</span> || token.value === <span class="hljs-string">'clone'</span> || token.value === <span class="hljs-string">'filter'</span>){
      token.nextToken();
      <span class="hljs-keyword">if</span>(token.type.label === <span class="hljs-string">'('</span>) workingpath.push(<span class="hljs-string">'@each'</span>);
    }

    <span class="hljs-keyword">if</span>(token.value === <span class="hljs-string">'at'</span>){
      token.nextToken();
      <span class="hljs-keyword">while</span>(_.isUndefined(token.value)){
        token.nextToken();
      }
      workingpath.push(<span class="hljs-string">'@each'</span>);
    }

    <span class="hljs-keyword">if</span>(token.value === <span class="hljs-string">'where'</span> || token.value === <span class="hljs-string">'findWhere'</span>){
      workingpath.push(<span class="hljs-string">'@each'</span>);
      token.nextToken();
      attrs = [];
      <span class="hljs-keyword">var</span> itr = <span class="hljs-number">0</span>;
      <span class="hljs-keyword">while</span>(token.type.label !== <span class="hljs-string">')'</span>){
        <span class="hljs-keyword">if</span>(token.value){
          <span class="hljs-keyword">if</span>(itr%<span class="hljs-number">2</span> === <span class="hljs-number">0</span>){
            attrs.push(token.value);
          }
          itr++;
        }
        token.nextToken();
      }
      workingpath.push(attrs);
    }

    <span class="hljs-keyword">if</span>(listening &amp;&amp; (_.indexOf(TERMINATORS, token.type.label) &gt; <span class="hljs-number">-1</span> || _.indexOf(TERMINATORS, token.value) &gt; <span class="hljs-number">-1</span>)){
      workingpath = _.reduce(workingpath, reduceMemos, [<span class="hljs-string">''</span>]);
      finishedPaths = _.compact(_.union(finishedPaths, workingpath));
      workingpath = [];
      listening--;
    }

  } <span class="hljs-keyword">while</span> (token.start !== token.end &amp;&amp; token.type !== tokTypes.eof);</pre></div></div>
            
        </li>
        
        
        <li id="section-424">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-424">&#182;</a>
              </div>
              <p>Save our finished paths directly on the function</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  prop.__params = finishedPaths;</pre></div></div>
            
        </li>
        
        
        <li id="section-425">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-425">&#182;</a>
              </div>
              <p>Return the dependancies list</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">return</span> finishedPaths;

}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> { compile: compile };</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
